<!DOCTYPE html>
<html lang="ja" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>販売管理システム (テスト最終版)</title>
    <link rel="icon" href="data:,">
	<!-- External Libraries -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --primary: #2c5aa0;
            --primary-hover: #1e3a5f;
            --background: #f5f7fa;
            --card-bg: #ffffff;
            --text-color: #333333;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Meiryo', sans-serif;
            background-color: var(--background);
            color: var(--text-color);
            min-height: 100vh;
        }

        /* Authentication Screen */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: fixed;
            top: 0;
            left: 0;
            z-index: 9999;
        }

        .auth-card {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 420px;
            text-align: center;
        }

        .auth-header {
            color: var(--primary);
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #eee;
            padding-bottom: 0.75rem;
        }
        
        .auth-header h2 {
            margin: 0 0 0.5rem 0;
            font-size: 1.5rem;
        }

        /* App Structure */
        .app-container {
            display: none;
            flex-direction: column;
            min-height: 100vh;
        }

        .app-header {
            background: var(--primary);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .app-title { margin: 0; font-size: 1.5rem; font-weight: bold; color: white; }
        
        /* 修正2: 担当者名を改行しない */
        .user-info { display: flex; align-items: center; gap: 1rem; white-space: nowrap; }

        .tab-menu {
            background: #1e3a5f;
            display: flex;
            padding: 0 1rem;
            overflow-x: auto;
        }

        .tab-button {
            background: transparent;
            border: none;
            color: #ccc;
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            font-size: 1rem;
            border-bottom: 3px solid transparent;
        }
        .tab-button:hover { color: white; background: rgba(255, 255, 255, 0.1); }
        .tab-button.active { color: white; border-bottom: 3px solid white; background: rgba(255, 255, 255, 0.05); }

        .main-content {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            flex: 1;
        }

        .page-section { display: none; animation: fadeIn 0.3s ease-in-out; }
        .page-section.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .card h2, .card h3 {
            color: var(--primary);
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }

        /* Dashboard Stats */
        .grid-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            border-left: 5px solid var(--primary);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
            margin: 0.5rem 0;
            white-space: nowrap;
        }
        .stat-label { color: #666; font-size: 0.9rem; }

        /* Dashboard Grid */
        .grid-dashboard {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }
        @media (max-width: 1200px) { .grid-dashboard { grid-template-columns: 1fr; } }

        .chart-wrapper { position: relative; height: 280px; width: 100%; }
        .funnel-wrapper { max-height: 300px; overflow-y: auto; }

        /* Tables */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #ddd; white-space: nowrap; }
        th { background-color: #f8f9fa; font-weight: bold; color: var(--primary); cursor: pointer; }
        tr:hover { background-color: #f5f5f5; }

        .customer-link {
            color: var(--primary);
            text-decoration: underline;
            cursor: pointer;
            font-weight: bold;
        }

        /* Funnel */
        .funnel-container { display: flex; flex-direction: column; gap: 0.5rem; }
        .funnel-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 0.5rem 1rem; color: white; border-radius: 4px;
            font-size: 0.9rem; transition: width 0.5s ease;
        }

        /* Calendar */
        .calendar-header {
            display: grid; grid-template-columns: repeat(7, 1fr); text-align: center;
            background: var(--primary); color: white; padding: 0.5rem 0; border-radius: 4px 4px 0 0;
        }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); border: 1px solid #ddd; }
        .calendar-day {
            min-height: 120px; border: 1px solid #eee; padding: 0.5rem;
            background: white; position: relative;
        }
        .calendar-day.other-month { background-color: #f9f9f9; color: #ccc; }
        .calendar-day.today { background-color: #e3f2fd; }

		.schedule-item {
			background: var(--primary); color: white; padding: 2px 5px; margin-bottom: 2px;
			border-radius: 3px; font-size: 0.75rem; cursor: pointer;
			white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
			display: flex;
			align-items: center;
			gap: 4px;
		}
		/* Calendar - Mobile対応 */
		.calendar-scroll-container {
			overflow-x: auto;
			-webkit-overflow-scrolling: touch; /* iOS用スムーズスクロール */
			border: 1px solid #ddd;
			border-radius: 4px;
		}

		/* ヘッダーとグリッドの幅を統一してズレを防止 */
		.calendar-scroll-container .calendar-header,
		.calendar-scroll-container .calendar-grid {
			min-width: 700px; /* 7列 × 100px想定。調整可能 */
		}

		.calendar-scroll-container .calendar-header {
			border-radius: 0; /* コンテナ側で角丸を制御 */
			margin-bottom: 0;
		}

		.calendar-scroll-container .calendar-grid {
			border: none; /* 外枠はコンテナが担当 */
		}


		/* 担当者名バッジスタイル */
		.schedule-assignee {
			background: rgba(255, 255, 255, 0.3);
			padding: 1px 4px;
			border-radius: 2px;
			font-size: 0.65rem;
			font-weight: bold;
			flex-shrink: 0;
		}

		/* 担当者別カラー設定 */
		.schedule-item[data-assignee="永森"] { 
			background-color: #e74c3c; 
			border-left: 3px solid #c0392b; 
		}
		.schedule-item[data-assignee="箱崎"] { 
			background-color: #3498db; 
			border-left: 3px solid #2980b9; 
		}
		.schedule-item[data-assignee="清水"] { 
			background-color: #2ecc71; 
			border-left: 3px solid #27ae60; 
		}
		.schedule-item[data-assignee="杉田"] { 
			background-color: #f39c12; 
			border-left: 3px solid #e67e22; 
		}
		.schedule-item[data-assignee="安里"] { 
			background-color: #9b59b6; 
			border-left: 3px solid #8e44ad; 
		}
		.schedule-item[data-assignee="鎌田"] { 
			background-color: #1abc9c; 
			border-left: 3px solid #16a085; 
		}
		.schedule-item[data-assignee="大山"] { 
			background-color: #34495e; 
			border-left: 3px solid #2c3e50; 
		}
		.schedule-item[data-assignee="admin"] { 
			background-color: #95a5a6; 
			border-left: 3px solid #7f8c8d; 
		}

		/* Modals */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); z-index: 10000; justify-content: center; align-items: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white; padding: 2rem; border-radius: 8px; width: 90%;
            max-width: 600px; max-height: 90vh; overflow-y: auto;
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1.5rem; border-bottom: 1px solid #eee; padding-bottom: 1rem;
        }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; }

        /* Form Elements */
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: bold; color: #555; }
        input, select, textarea {
            width: 100%; padding: 0.5rem; border: 1px solid #ddd;
            border-radius: 4px; font-size: 1rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none; border-radius: 4px; cursor: pointer;
            font-size: 0.9rem; display: inline-flex; align-items: center; gap: 0.5rem;
            text-decoration: none; color: white; background-color: var(--primary);
            flex-shrink: 1;
        }
        .btn:hover { background-color: var(--primary-hover); }
        .btn-secondary { background-color: #6c757d; }
        .btn-danger { background-color: #dc3545; }
        .btn-success { background-color: #28a745; }
        
        /* 修正4: テーブルボタン調整用 */
        .btn-sm {
            padding: 0.2rem 0.4rem !important;
            font-size: 0.75rem !important;
            white-space: nowrap;
        }
        .btn-group {
            display: flex;
            gap: 0.3rem;
            flex-wrap: nowrap;
        }

        .actions { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem; }

        /* KPI Progress */
        .progress-bar-container {
            background-color: #e9ecef; border-radius: 0.25rem; height: 1.5rem;
            width: 100%; overflow: hidden; margin: 0.5rem 0;
        }
        .progress-bar {
            background-color: #28a745; height: 100%; color: white; text-align: center;
            line-height: 1.5rem; font-size: 0.8rem; transition: width 0.6s ease;
        }

        /* Toast & Loading */
        .toast {
            position: fixed; top: 20px; right: 20px; padding: 1rem 1.5rem;
            border-radius: 4px; color: white; font-weight: bold; display: none;
            z-index: 11000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); animation: slideIn 0.3s ease-out;
        }
        .toast-success { background-color: #28a745; }
        .toast-error { background-color: #dc3545; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); z-index: 20000;
            display: none; justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid var(--primary);
            border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Specific Layout Classes */
        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .filter-select {
			width: 150px !important;
			padding: 0.5rem;
		}

		/* Project Management Styles */
		.project-alert-warning {
			background-color: #fff3cd !important;
			border-left: 4px solid #ffc107;
		}
		.project-alert-danger {
			background-color: #f8d7da !important;
			border-left: 4px solid #dc3545;
			animation: pulse 2s infinite;
		}
		@keyframes pulse {
			0%, 100% { opacity: 1; }
			50% { opacity: 0.8; }
		}

		/* Document Upload Styles */
		.drop-zone {
			border: 2px dashed #ccc;
			border-radius: 8px;
			padding: 2rem;
			text-align: center;
			color: #666;
			transition: all 0.3s;
			background: #f9f9f9;
			cursor: pointer;
			margin-bottom: 1rem;
		}
		.drop-zone:hover,
		.drop-zone.dragover {
			border-color: var(--primary);
			background: #e3f2fd;
			color: var(--primary);
		}

		.file-item {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 0.75rem;
			border: 1px solid #ddd;
			border-radius: 4px;
			margin-bottom: 0.5rem;
			background: white;
			transition: background 0.2s;
		}
		.file-item:hover {
			background-color: #f8f9fa;
		}

		.version-badge {
			background: #6c757d;
			color: white;
			font-size: 0.7rem;
			padding: 2px 6px;
			border-radius: 10px;
			margin-right: 5px;
		}

		.stagnant-days {
			font-weight: bold;
		}
		.stagnant-warning { color: #ffc107; }
		.stagnant-danger { color: #dc3545; }
		/* =========================================
		   Mobile Responsive Optimization
		   ========================================= */

		/* タブレット・スマホ表示時の最適化 (768px以下) */
		@media (max-width: 768px) {
			/* スクロールヒント表示 */
			.mobile-scroll-hint {
				display: block !important;
			}
			
			/* カレンダー全体の調整 */
			.calendar-day {
				min-height: 80px;
				padding: 0.3rem;
				font-size: 0.8rem;
			}
			
			/* 予定アイテムの表示調整 */
			.schedule-item {
				font-size: 0.65rem;
				padding: 1px 3px;
				margin-bottom: 1px;
				line-height: 1.2;
			}
			
			/* 担当者バッジの調整 */
			.schedule-assignee {
				font-size: 0.6rem;
				padding: 0px 2px;
			}
			
			/* メインコンテンツの余白調整 */
			.main-content {
				padding: 1rem 0.5rem;
			}
			
			/* カード要素の余白調整 */
			.card {
				padding: 1rem;
			}
			
			/* ヘッダーコントロールの調整 */
			.header-controls {
				flex-direction: column;
				width: 100%;
				gap: 5px;
			}
			
			.header-controls > * {
				width: 100%;
			}
		}

		/* 超小画面用の追加調整 (480px以下) */
		@media (max-width: 480px) {
			.calendar-day {
				min-height: 60px;
			}
			
			.schedule-item {
				font-size: 0.6rem;
			}
			
			/* 超小画面では担当者名を非表示にしてスペース確保 */
			.schedule-assignee {
				display: none;
			}
			
			/* ボタンのサイズ調整 */
			.btn {
				font-size: 0.8rem;
				padding: 0.4rem 0.8rem;
			}
			
			/* テーブルの文字サイズ調整 */
			table {
				font-size: 0.75rem;
			}
			
			th, td {
				padding: 0.5rem;
			}
		}
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <p style="margin-top: 1rem; font-weight: bold; color: var(--primary);">Loading...</p>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <h2><i class="fas fa-chart-line"></i> 販売管理システム</h2>
                <p>テスト最終版</p>
            </div>
            <form id="loginForm">
                <div class="form-group" style="text-align: left;">
                    <label>ユーザーID (メールアドレス)</label>
                    <input type="text" id="username" required placeholder="admin">
                </div>
                <div class="form-group" style="text-align: left;">
                    <label>パスワード</label>
                    <input type="password" id="password" required placeholder="パスワードを入力">
                </div>
                <button type="submit" class="btn" style="width: 100%; justify-content: center; padding: 0.8rem;">ログイン</button>
            </form>
            <div style="margin-top: 1rem; font-size: 0.8rem; color: #666;">
                <p>初期ID: admin, eimori, hakozaki...</p>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="appContainer" class="app-container">
        <header class="app-header">
            <div class="app-title"><i class="fas fa-chart-line"></i> 販売管理システム</div>
            <div class="user-info">
                <span id="userInfoDisplay"></span>
                <button id="logoutBtn" class="btn btn-secondary" style="border: 1px solid white;">ログアウト</button>
            </div>
        </header>

        <nav class="tab-menu">
			<button class="tab-button active" onclick="app.showPage('dashboard')">ダッシュボード</button>
			<button class="tab-button" onclick="app.showPage('customers')">顧客管理</button>
			<button class="tab-button" onclick="app.showPage('projects')">案件管理</button>
			<button class="tab-button" onclick="app.showPage('schedule')">スケジュール</button>
			<button class="tab-button" onclick="app.showPage('activities')">活動記録</button>
			<button class="tab-button" onclick="app.showPage('kpi')">KPI設定</button>
		</nav>

        <main class="main-content">
            <!-- Dashboard Section -->
            <section id="dashboardPage" class="page-section active">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 class="page-title">ダッシュボード</h2>
                    <select id="dashboardFilter" onchange="app.renderDashboard()" class="filter-select">
                        <option value="all">全体表示</option>
                        <option value="personal">個人表示</option>
                    </select>
                </div>

                <div class="card">
                    <h3>売上達成状況</h3>
                    <div style="margin-bottom: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <strong id="dashboardKpiLabel">全体達成率</strong>
                            <div>
                                <span style="color: var(--primary); font-size: 1.2rem; font-weight: bold;" id="dashboardKpiRate">0%</span>
                                <span style="margin-left: 1rem; color: #dc3545;">不足: <span id="dashboardKpiShortage">¥0</span></span>
                            </div>
                        </div>
                        <div class="progress-bar-container">
                            <div id="dashboardKpiBar" class="progress-bar" style="width: 0%">0%</div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.9rem;">
                        <div><strong>売上目標:</strong> <span id="dashboardKpiTarget">¥0</span></div>
                        <div><strong>現在売上:</strong> <span id="dashboardKpiCurrent">¥0</span></div>
                    </div>
                </div>

                <div class="grid-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="statTotalCustomers">0</div>
                        <div class="stat-label">総顧客数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statTodaySchedule">0</div>
                        <div class="stat-label">本日の予定</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statWeekActivities">0</div>
                        <div class="stat-label">今週の活動</div>
                    </div>
                    <div class="stat-card">
						<div class="stat-value" id="statTotalSales">¥0</div>
						<div class="stat-label">受注想定価格合計</div>
						<div style="font-size: 0.75rem; color: #666; margin-top: 0.5rem;" id="statTotalSalesDetail">-</div>
					</div>
                </div>

                <div class="grid-dashboard">
                    <div class="card">
						<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
							<h3 style="margin: 0; border: none;">担当者別活動状況</h3>
							<div style="display: flex; gap: 0.3rem;">
								<button class="btn btn-sm" style="padding: 0.3rem 0.5rem; font-size: 0.75rem;" onclick="app.setActivityPeriod('all')">累計</button>
								<button class="btn btn-sm" style="padding: 0.3rem 0.5rem; font-size: 0.75rem;" onclick="app.setActivityPeriod('week')">今週</button>
								<button class="btn btn-sm" style="padding: 0.3rem 0.5rem; font-size: 0.75rem;" onclick="app.setActivityPeriod('month')">今月</button>
							</div>
						</div>
						<div class="chart-wrapper"><canvas id="chartActivity"></canvas></div>
					</div>
                    <div class="card">
                        <h3>機種名別売上（受注済）</h3>
                        <div class="chart-wrapper"><canvas id="chartProduct"></canvas></div>
                    </div>
                    <div class="card">
                        <h3>ステージ別案件数</h3>
                        <div class="funnel-wrapper"><div id="funnelStage" class="funnel-container"></div></div>
                    </div>
                    <div class="card">
                        <h3>確度別分布</h3>
                        <div class="funnel-wrapper"><div id="funnelProbability" class="funnel-container"></div></div>
                    </div>
                    <div class="card" style="grid-column: 1 / -1;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
							<h3 style="margin: 0; border: none;">受注予定タイムライン (6月-5月)</h3>
							<div style="font-size: 0.85rem; color: #666;">
								<span style="color: #4BC0C0; font-weight: bold;">目標: ¥<span id="timelineTarget">0</span></span> | 
								<span style="color: #28a745; font-weight: bold;">受注済: ¥<span id="timelineOrdered">0</span></span> | 
								<span style="color: #ffc107; font-weight: bold;">想定: ¥<span id="timelineExpected">0</span></span> | 
								<span style="color: #dc3545; font-weight: bold;">不足: ¥<span id="timelineShortage">0</span></span>
							</div>
						</div>
                        <div class="chart-wrapper" style="height: 350px;"><canvas id="chartTimeline"></canvas></div>
                    </div>
                </div>
            </section>

            <!-- Customer Management Section -->
            <section id="customersPage" class="page-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; gap: 1rem; flex-wrap: wrap;">
                    <h2 class="page-title" style="margin: 0;">顧客管理</h2>
                    <div class="header-controls">
                        <select id="customersFilter" onchange="app.renderCustomers()" class="filter-select">
                            <option value="all">全員表示</option>
                            <option value="personal">個人表示</option>
                        </select>
                        <button class="btn btn-primary" onclick="app.openCustomerModal()"><i class="fas fa-plus"></i> 新規顧客追加</button>
                    </div>
                </div>
                <div class="card table-container">
                    <table id="customersTable">
                        <thead>
                            <tr>
                                <th onclick="app.sortCustomers('name')">顧客名 <i class="fas fa-sort" id="sortIconCustomerName"></i></th>
                                <th>業種</th>
                                <th>ランク</th>
                                <th>ステータス</th>
                                <th>主担当者</th>
                                <th>担当者数</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <!-- Schedule Section -->
            <section id="schedulePage" class="page-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 10px;">
                    <h2 class="page-title">スケジュール</h2>
                    <div class="header-controls">
                        <select id="scheduleFilterAssignee" onchange="app.renderSchedule()" class="filter-select"></select>
                        <select id="scheduleViewType" onchange="app.renderSchedule()" class="filter-select">
                            <option value="calendar">カレンダー</option>
                            <option value="list">リスト一覧</option>
                        </select>
                        <button class="btn btn-primary" onclick="app.openScheduleModal()"><i class="fas fa-plus"></i> 予定追加</button>
                    </div>
                </div>
                <div class="card">
                    <!-- 修正5: カレンダー操作ボタンレイアウト -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <button class="btn btn-secondary" style="min-width: 60px; padding: 0.4rem 0.6rem;" onclick="app.changeMonth(-1)">前月</button>
                        <h3 id="currentMonthLabel" style="margin: 0; white-space: nowrap;"></h3>
                        <button class="btn btn-secondary" style="min-width: 60px; padding: 0.4rem 0.6rem;" onclick="app.changeMonth(1)">翌月</button>
                    </div>
                    <div id="calendarView">
						<div class="calendar-scroll-container">
							<div class="calendar-header">
								<div>日</div><div>月</div><div>火</div><div>水</div><div>木</div><div>金</div><div>土</div>
							</div>
							<div id="calendarGrid" class="calendar-grid"></div>
						</div>
						<div style="text-align: center; font-size: 0.8rem; color: #666; margin-top: 5px; display: none;" class="mobile-scroll-hint">
							<i class="fas fa-arrows-alt-h"></i> 横にスクロールできます
						</div>
					</div>
                    <div id="scheduleListView" style="display: none;">
                        <table id="scheduleListTable">
                            <thead>
                                <tr>
                                    <th onclick="app.sortScheduleList('date')">日付 <i class="fas fa-sort" id="sortIconScheduleDate"></i></th>
                                    <th>時間</th>
                                    <th>担当者</th>
                                    <th>タイトル</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Activity Log Section -->
            <section id="activitiesPage" class="page-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; gap: 1rem; flex-wrap: wrap;">
                    <h2 class="page-title" style="margin: 0;">活動記録</h2>
                    <div class="header-controls">
                        <select id="activitiesFilter" onchange="app.renderActivities()" class="filter-select">
                            <option value="all">全員表示</option>
                            <option value="personal">個人表示</option>
                        </select>
                        <button class="btn btn-success" onclick="app.exportReport('weekly')"><i class="fas fa-file-csv"></i> 週報出力</button>
                        <button class="btn btn-success" onclick="app.exportReport('monthly')"><i class="fas fa-file-csv"></i> 月報出力</button>
                        <button class="btn btn-primary" onclick="app.openActivityModal()"><i class="fas fa-plus"></i> 記録追加</button>
                    </div>
                </div>
                <div class="card table-container">
                    <table id="activitiesTable">
                        <thead>
							<tr>
								<th onclick="app.sortActivities('date')">日付 <i class="fas fa-sort" id="sortIconActivityDate"></i></th>
								<th onclick="app.sortActivities('assignee')">担当 <i class="fas fa-sort" id="sortIconActivityAssignee"></i></th>
								<th onclick="app.sortActivities('customer')">得意先 <i class="fas fa-sort" id="sortIconActivityCustomer"></i></th>
								<th onclick="app.sortActivities('purpose')">目的 <i class="fas fa-sort" id="sortIconActivityPurpose"></i></th>
								<th>相手</th>
								<th>機種名</th>
								<th>商談内容</th>
								<th onclick="app.sortActivities('stage')">ステージ <i class="fas fa-sort" id="sortIconActivityStage"></i></th>
								<th onclick="app.sortActivities('expected_date')">受注予定日 <i class="fas fa-sort" id="sortIconExpectedDate"></i></th>
								<th onclick="app.sortActivities('probability')">確度 <i class="fas fa-sort" id="sortIconActivityProbability"></i></th>
								<th onclick="app.sortActivities('amount')">金額 <i class="fas fa-sort" id="sortIconActivityAmount"></i></th>
								<th>操作</th>
							</tr>
						</thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <!-- Projects Section -->
			<section id="projectsPage" class="page-section">
				<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; gap: 1rem; flex-wrap: wrap;">
					<h2 class="page-title" style="margin: 0;">案件管理</h2>
					<div class="header-controls">
						<select id="projectsFilter" onchange="app.renderProjects()" class="filter-select">
							<option value="all">全員表示</option>
							<option value="personal">個人表示</option>
						</select>
						<select id="projectsStatusFilter" onchange="app.renderProjects()" class="filter-select">
							<option value="all">全ステータス</option>
							<option value="進行中">進行中</option>
							<option value="保留">保留</option>
							<option value="完了">完了</option>
							<option value="失注">失注</option>
						</select>
						<button class="btn btn-primary" onclick="app.openProjectModal()"><i class="fas fa-plus"></i> 新規案件</button>
					</div>
				</div>
				
				<!-- 滞留アラート表示エリア -->
				<div id="projectAlerts" style="margin-bottom: 1.5rem;"></div>
				
				<div class="card">
					<div style="margin-bottom: 1rem; font-size: 0.9rem;">
						<span style="display:inline-block; width:15px; height:15px; background:#fff3cd; border:1px solid #ffc107; vertical-align:middle;"></span> 30日以上滞留　
						<span style="display:inline-block; width:15px; height:15px; background:#f8d7da; border:1px solid #dc3545; vertical-align:middle; margin-left:10px;"></span> 60日以上滞留
					</div>
					
					<div class="table-container">
						<table id="projectsTable">
							<thead>
								<tr>
									<th onclick="app.sortProjects('projectNumber')">案件番号 <i class="fas fa-sort" id="sortIconProjectNumber"></i></th>
									<th onclick="app.sortProjects('projectName')">案件名 <i class="fas fa-sort" id="sortIconProjectName"></i></th>
									<th onclick="app.sortProjects('customer')">得意先 <i class="fas fa-sort" id="sortIconProjectCustomer"></i></th>
									<th>機種名</th>
									<th>担当</th>
									<th onclick="app.sortProjects('stage')">ステージ <i class="fas fa-sort" id="sortIconProjectStage"></i></th>
									<th>確度</th>
									<th onclick="app.sortProjects('estimatedAmount')">想定金額 <i class="fas fa-sort" id="sortIconProjectAmount"></i></th>
									<th>受注予定日</th>
									<th>滞留日数</th>
									<th>ステータス</th>
									<th>ドキュメント</th>
									<th>操作</th>
								</tr>
							</thead>
							<tbody></tbody>
						</table>
					</div>
				</div>
			</section>
			
			<!-- KPI Settings Section -->
            <section id="kpiPage" class="page-section">
                <h2 class="page-title">KPI設定</h2>
                <div class="card">
                    <!-- 修正8: タイトルとボタンを横並びに -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0; border: none; padding: 0;">売上目標設定</h3>
                        <button class="btn btn-primary" onclick="app.saveKPITargets()">目標保存</button>
                    </div>
                    <div class="form-group">
                        <label>全体売上目標 (円) *</label>
                        <input type="text" id="kpiTotalTarget" required oninput="app.formatCurrency(this)">
                    </div>
                    <div class="form-group">
                        <label>個人売上目標 (円) *</label>
                        <input type="text" id="kpiPersonalTarget" required oninput="app.formatCurrency(this)">
                    </div>
                </div>
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <!-- 修正8: タイトルの改行防止 -->
                        <h3 style="margin: 0; white-space: nowrap;">個人別KPI (アクションプラン)</h3>
                        <button class="btn btn-primary" onclick="app.openKPIModal()"><i class="fas fa-plus"></i> 項目追加</button>
                    </div>
                    <table id="personalKPITable">
                        <thead>
                            <tr><th>対象項目</th><th>ゴール (目標値)</th><th>期限</th><th>現状</th><th>操作</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <!-- Modals (修正7: 各モーダルタイトルの改行防止) -->
    <div id="customerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3 style="white-space: nowrap;">顧客情報</h3><button class="close-btn" onclick="app.closeModal('customerModal')">×</button></div>
            <form onsubmit="app.saveCustomer(event)">
                <input type="hidden" id="customerId">
                <div class="form-group"><label>顧客名 *</label><input type="text" id="customerName" required></div>
                <div class="form-group"><label>業種</label><input type="text" id="customerIndustry"></div>
                <div class="form-group"><label>ランク</label><select id="customerRank"><option value="A">A</option><option value="B">B</option><option value="C">C</option></select></div>
                <div class="form-group"><label>ステータス</label><select id="customerStatus"><option value="取引中">取引中</option><option value="アプローチ中">アプローチ中</option><option value="休眠">休眠</option></select></div>
                <div class="form-group"><label>主担当者 *</label><select id="customerAssignee" required class="staff-select"></select></div>
                <div class="actions">
                    <button type="button" class="btn btn-secondary" onclick="app.closeModal('customerModal')">キャンセル</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <div id="customerStaffModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3><span id="staffModalCustomerName"></span> の担当者一覧</h3><button class="close-btn" onclick="app.closeModal('customerStaffModal')">×</button></div>
            <div style="margin-bottom: 1rem; text-align: right;"><button class="btn btn-primary" onclick="app.addCustomerStaff()">担当者追加</button></div>
            <table id="customerStaffTable"><thead><tr><th>担当者名</th><th>部署・役職</th><th>連絡先</th><th>操作</th></tr></thead><tbody></tbody></table>
        </div>
    </div>

    <div id="scheduleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3 style="white-space: nowrap;">予定情報</h3><button class="close-btn" onclick="app.closeModal('scheduleModal')">×</button></div>
            <form onsubmit="app.saveSchedule(event)">
                <input type="hidden" id="scheduleId">
                <div class="form-group"><label>タイトル *</label><input type="text" id="scheduleTitle" required></div>
                <div class="form-group"><label>日付 *</label><input type="date" id="scheduleDate" required></div>
                <div class="form-group"><label>時間</label><input type="time" id="scheduleTime"></div>
                <div class="form-group"><label>担当者 *</label><select id="scheduleAssignee" required class="staff-select"></select></div>
                <div class="actions">
                    <button type="button" class="btn btn-danger" id="deleteScheduleBtn" style="display: none;" onclick="app.deleteSchedule()">削除</button>
                    <button type="button" class="btn btn-secondary" onclick="app.closeModal('scheduleModal')">キャンセル</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <div id="activityModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3 style="white-space: nowrap;">活動記録</h3><button class="close-btn" onclick="app.closeModal('activityModal')">×</button></div>
            <form onsubmit="app.saveActivity(event)">
                <input type="hidden" id="activityId">
                <div class="form-group"><label>日付 *</label><input type="date" id="activityDate" required></div>
                <div class="form-group"><label>担当 *</label><select id="activityAssignee" required class="staff-select"></select></div>
                <div class="form-group"><label>得意先 *</label><select id="activityCustomer" required></select></div>
                <div class="form-group"><label>目的 *</label><select id="activityPurpose" required>
                    <option value="A">A: 新規事業活動</option><option value="B">B: 商談促進</option><option value="C">C: 仕様打合せ</option>
                    <option value="D">D: 納入・営業立会い</option><option value="E">E: クレーム対応</option><option value="F">F: 無償作業</option>
                    <option value="G">G: 有償作業</option><option value="H">H: 相談・アドバイス</option><option value="I">I: 部品調査</option>
                    <option value="J">J: 情報収集</option><option value="K">K: 社内業務</option>
                </select></div>
                <div class="form-group"><label>相手</label><input type="text" id="activityPartner"></div>
                <div class="form-group"><label>機種名</label><input type="text" id="activityProduct"></div>
                <div class="form-group"><label>商談内容</label><textarea id="activityContent" rows="3"></textarea></div>
                <div class="form-group"><label>ステージ</label><select id="activityStage">
                    <option value="アプローチ">アプローチ</option><option value="ヒアリング">ヒアリング</option>
                    <option value="提案">提案</option><option value="見積提出">見積提出</option>
                    <option value="クロージング">クロージング</option><option value="受注">受注</option>
                </select></div>
                <div class="form-group"><label>確度</label><select id="activityProbability"><option value="A">A (高)</option><option value="B">B</option><option value="C">C</option><option value="D">D (低)</option></select></div>
                <div class="form-group"><label>受注想定価格</label><input type="number" id="activityAmount"></div>
                <div class="form-group"><label>受注予定日</label><input type="date" id="activityExpectedDate"></div>
				
				<!-- ★案件連携セクション追加 -->
				<input type="hidden" id="activityProjectId">
				<div class="form-group" id="projectLinkSection" style="background: #e3f2fd; padding: 1rem; border-radius: 4px; display: none;">
					<label style="color: var(--primary);"><i class="fas fa-link"></i> 案件連携中</label>
					<div id="linkedProjectInfo" style="font-size: 0.9rem; margin-bottom: 0.5rem;"></div>
					<button type="button" class="btn btn-secondary btn-sm" onclick="app.unlinkProject()">連携解除</button>
				</div>
				<div class="form-group" id="projectSelectSection">
					<label>関連案件 (任意)</label>
					<select id="activityProject" onchange="app.linkToProject()">
						<option value="">案件なし（通常活動）</option>
					</select>
					<small style="color: #666;">※案件を選択すると、ステージや確度が案件側に自動反映されます</small>
				</div>
				<div id="projectCreateSection" style="margin-top: 0.5rem;">
					<button type="button" class="btn btn-success" onclick="app.createProjectFromActivity()" style="width: 100%;">
						<i class="fas fa-briefcase"></i> この活動から新規案件を作成
					</button>
				</div>
				
                <div class="actions">
                    <button type="button" class="btn btn-secondary" onclick="app.closeModal('activityModal')">キャンセル</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <div id="kpiItemModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3 style="white-space: nowrap;">個人KPI項目</h3><button class="close-btn" onclick="app.closeModal('kpiItemModal')">×</button></div>
            <form onsubmit="app.saveKPIItem(event)">
                <input type="hidden" id="kpiItemId">
                <div class="form-group"><label>対象項目 *</label><input type="text" id="kpiTargetItem" required></div>
                <div class="form-group"><label>ゴール (目標値) *</label><input type="text" id="kpiGoalValue" required></div>
                <div class="form-group"><label>期限</label><input type="date" id="kpiDeadline"></div>
                <div class="form-group"><label>現状</label><input type="text" id="kpiCurrentStatus"></div>
                <div class="actions">
                    <button type="button" class="btn btn-secondary" onclick="app.closeModal('kpiItemModal')">キャンセル</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

	<!-- Project Modal -->
	<div id="projectModal" class="modal">
		<div class="modal-content" style="max-width: 900px;">
			<div class="modal-header">
				<h3 style="white-space: nowrap;">案件情報</h3>
				<button class="close-btn" onclick="app.closeModal('projectModal')">×</button>
			</div>
			<form onsubmit="app.saveProject(event)">
				<input type="hidden" id="projectId">
				
				<div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem;">
					<div class="form-group">
						<label>案件番号（自動採番）</label>
						<input type="text" id="projectNumber" readonly style="background: #f0f0f0; font-weight: bold; color: var(--primary);">
					</div>
					<div class="form-group">
						<label>案件名 *</label>
						<input type="text" id="projectName" required placeholder="例：〇〇社 新工場設備導入案件">
					</div>
				</div>
				
				<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
					<div class="form-group">
						<label>得意先 *</label>
						<select id="projectCustomer" required></select>
					</div>
					<div class="form-group">
						<label>機種名</label>
						<input type="text" id="projectProduct" placeholder="製造機種名">
					</div>
					<div class="form-group">
						<label>担当者 *</label>
						<select id="projectAssignee" required class="staff-select"></select>
					</div>
				</div>
				
				<div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 1rem;">
					<div class="form-group">
						<label>ステージ *</label>
						<select id="projectStage" required>
							<option value="アプローチ">アプローチ</option>
							<option value="ヒアリング">ヒアリング</option>
							<option value="提案">提案</option>
							<option value="見積提出">見積提出</option>
							<option value="クロージング">クロージング</option>
							<option value="受注">受注</option>
						</select>
					</div>
					<div class="form-group">
						<label>確度</label>
						<select id="projectProbability">
							<option value="A">A (高)</option>
							<option value="B">B</option>
							<option value="C">C</option>
							<option value="D">D (低)</option>
							<option value="受注済">受注済</option>
						</select>
					</div>
					<div class="form-group">
						<label>想定金額</label>
						<input type="number" id="projectAmount" placeholder="円">
					</div>
					<div class="form-group">
						<label>受注予定日</label>
						<input type="date" id="projectExpectedDate">
					</div>
				</div>
				
				<div class="form-group">
					<label>ステータス</label>
					<select id="projectStatus">
						<option value="進行中">進行中</option>
						<option value="保留">保留</option>
						<option value="完了">完了</option>
						<option value="失注">失注</option>
					</select>
				</div>
				
				<div class="form-group">
					<label>備考</label>
					<textarea id="projectNotes" rows="2" placeholder="案件に関する特記事項"></textarea>
				</div>

				<!-- Phase 2-3: ドキュメント管理エリア -->
				<div class="form-group">
					<label><i class="fas fa-paperclip"></i> 関連ドキュメント（見積書・図面・資料等）</label>
					<div id="dropZone" class="drop-zone">
						<i class="fas fa-cloud-upload-alt" style="font-size: 2.5rem; margin-bottom: 0.5rem;"></i>
						<p style="margin: 0;">ファイルをドラッグ&ドロップ<br>または<br>クリックして選択</p>
						<input type="file" id="fileInput" style="display:none" multiple accept=".pdf,.xlsx,.xls,.dwg,.dxf,.jpg,.jpeg,.png,.doc,.docx">
					</div>
					<div id="uploadProgress" style="display:none; color:var(--primary); font-weight:bold; margin:0.5rem 0;">
						<i class="fas fa-spinner fa-spin"></i> アップロード中...
					</div>
					<div id="fileList" style="margin-top: 1rem;"></div>
				</div>
				
				<div class="actions">
					<button type="button" class="btn btn-danger" id="deleteProjectBtn" style="display: none;" onclick="app.deleteProject()">削除</button>
					<button type="button" class="btn btn-secondary" onclick="app.closeModal('projectModal')">キャンセル</button>
					<button type="submit" class="btn btn-primary">保存</button>
				</div>
			</form>
		</div>
	</div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
		// Constants & Global State
        // 修正1: USER_ACCOUNTSの修正（eimori）
        const USER_ACCOUNTS = [
            { username: 'admin', password: 'admin', assignee: 'admin', displayName: '管理者', role: 'admin', altUsername: 'admin' },
            { username: '永森', password: 'eimori', assignee: '永森', displayName: '永森', role: 'staff', altUsername: 'eimori' },
            { username: '箱崎', password: 'hakozaki', assignee: '箱崎', displayName: '箱崎', role: 'staff', altUsername: 'hakozaki' },
            { username: '清水', password: 'shimizu', assignee: '清水', displayName: '清水', role: 'staff', altUsername: 'shimizu' },
            { username: '杉田', password: 'sugita', assignee: '杉田', displayName: '杉田', role: 'staff', altUsername: 'sugita' },
            { username: '安里', password: 'asato', assignee: '安里', displayName: '安里', role: 'staff', altUsername: 'asato' },
            { username: '鎌田', password: 'kamata', assignee: '鎌田', displayName: '鎌田', role: 'staff', altUsername: 'kamata' },
            { username: '大山', password: 'oyama', assignee: '大山', displayName: '大山', role: 'staff', altUsername: 'oyama' }
        ];

        const STAFFS = ['永森', '箱崎', '清水', '杉田', '安里', '鎌田', '大山'];
        let supabaseClient = null;
		// LocalStorage優先のためデフォルトSupabase設定
		const SUPABASE_URL =
			localStorage.getItem('supabaseUrl') || 'https://vflehlpohwuwploozobi.supabase.co';

		const SUPABASE_KEY =
			localStorage.getItem('supabaseKey') || 'sb_publishable_469r2OoTzw-xioLdkOHotQ_7b8RzjuY';

		// Initialize Supabase if config exists
        if (SUPABASE_URL && SUPABASE_KEY && SUPABASE_URL !== 'YOUR_SUPABASE_URL') {
            try {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            } catch (e) { console.warn('Supabase init failed', e); }
        }

        let CURRENT_USER = { id: '', username: '', assignee: '', displayName: '', role: 'staff' };

        class SalesApp {
			setActivityPeriod(period) {
				this.activityPeriod = period;
				this.renderDashboard();
			}

            constructor() {
                this.data = {
                    customers: [],
                    schedules: [],
                    activities: [],
                    kpiSettings: { totalTarget: 0, personalTargets: {}, personalItems: [] }
                };
                this.currentDate = new Date();
                this.currentEditingCustomerId = null;
                
                // Sort state
                this.customersSortField = null; this.customersSortOrder = 'asc';
                this.activitiesSortField = null; this.activitiesSortOrder = 'asc';
                this.scheduleSortField = null; this.scheduleSortOrder = 'asc';
				
				// ★ここに追加
				this.currentProjectFiles = []; // ファイル管理用の一時配列
                
                this.init();
            }

            init() {
                this.loadData();
                this.setupEventListeners();
                
                // Simple session check (localStorage mode)
                const sessionUser = sessionStorage.getItem('currentUser');
                if (sessionUser) {
                    CURRENT_USER = JSON.parse(sessionUser);
                    this.showApp();
                }
            }

            setupEventListeners() {
                // Login Form
                document.getElementById('loginForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const username = document.getElementById('username').value;
                    const password = document.getElementById('password').value;
                    
                    // 修正1: ユーザー認証ロジック
                    const user = USER_ACCOUNTS.find(u => (u.username === username || u.assignee === username || u.altUsername === username) && u.password === password);
                    
                    if (user) {
                        CURRENT_USER = user;
                        sessionStorage.setItem('currentUser', JSON.stringify(user));
                        this.showApp();
                    } else {
                        alert('ログイン失敗: ユーザー名またはパスワードが間違っています');
                    }
                });

                document.getElementById('logoutBtn').addEventListener('click', () => {
                    sessionStorage.removeItem('currentUser');
                    location.reload();
                });

                // Dynamic Probability Dropdown based on Stage
                document.getElementById('activityStage').addEventListener('change', function(e) {
                    const probSelect = document.getElementById('activityProbability');
                    if (this.value === '受注') {
                        probSelect.innerHTML = '<option value="">空白</option><option value="受注済">受注済</option>';
                    } else {
                        probSelect.innerHTML = '<option value="A">A (高)</option><option value="B">B</option><option value="C">C</option><option value="D">D (低)</option>';
                    }
                });
            }
			
            showApp() {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('appContainer').style.display = 'flex';
                document.getElementById('userInfoDisplay').textContent = CURRENT_USER.displayName;
                this.setupSelectOptions();
                this.showPage('dashboard');
				// ★ここに追加
				setTimeout(() => {
					this.setupFileUploadEvents();
				}, 100);
			}
			
            setupSelectOptions() {
                const staffOptions = '<option value="">選択してください</option>' + STAFFS.map(s => `<option value="${s}">${s}</option>`).join('');
                document.querySelectorAll('.staff-select').forEach(el => el.innerHTML = staffOptions);
                
                // Schedule filter
                const sFilter = document.getElementById('scheduleFilterAssignee');
                sFilter.innerHTML = '<option value="all">全員</option>' + STAFFS.map(s => `<option value="${s}">${s}</option>`).join('');
                if (CURRENT_USER.role !== 'admin' && STAFFS.includes(CURRENT_USER.assignee)) {
                    sFilter.value = CURRENT_USER.assignee;
                }
            }

            showPage(pageId) {
                document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
                document.getElementById(pageId + 'Page').classList.add('active');
                document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
                const idx = ['dashboard', 'customers', 'projects', 'schedule', 'activities', 'kpi'].indexOf(pageId);
                if (idx !== -1) document.querySelectorAll('.tab-button')[idx].classList.add('active');

                if (pageId === 'dashboard') this.renderDashboard();
                if (pageId === 'customers') this.renderCustomers();
				if (pageId === 'projects') this.renderProjects(); 
                if (pageId === 'schedule') this.renderSchedule();
                if (pageId === 'activities') this.renderActivities();
                if (pageId === 'kpi') this.renderKPI();
            }

            // --- Dashboard Render ---
            renderDashboard() {
				const customers = this.data.customers || [];
				const schedules = this.data.schedules || [];
				const activities = this.data.activities || [];

				// ↓ 以降は customers / schedules / activities を使う

                const filter = document.getElementById('dashboardFilter').value;
                const isPersonal = filter === 'personal' && CURRENT_USER.role !== 'admin';
                
                const acts = isPersonal ? this.data.activities.filter(a => a.assignee === CURRENT_USER.assignee) : this.data.activities;
                const scheds = isPersonal ? this.data.schedules.filter(s => s.assignee === CURRENT_USER.assignee) : this.data.schedules;
                const custs = isPersonal ? this.data.customers.filter(c => c.assignee === CURRENT_USER.assignee) : this.data.customers;

                // Stats
                document.getElementById('statTotalCustomers').textContent = custs.length;
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('statTodaySchedule').textContent = scheds.filter(s => s.date === today).length;
                
                const now = new Date();
                const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
                const weekActs = acts.filter(a => new Date(a.date) >= weekStart);
                document.getElementById('statWeekActivities').textContent = weekActs.length; 
                
                // 受注済と受注想定を分離
				const orderedSales = acts.filter(a => a.stage === '受注').reduce((sum, a) => sum + (Number(a.amount) || 0), 0);
				const expectedSales = acts.filter(a => a.stage !== '受注').reduce((sum, a) => sum + (Number(a.amount) || 0), 0);
				const totalSales = orderedSales + expectedSales;
				document.getElementById('statTotalSales').textContent = '¥' + totalSales.toLocaleString();
				document.getElementById('statTotalSalesDetail').textContent = `受注済: ¥${orderedSales.toLocaleString()} / 想定: ¥${expectedSales.toLocaleString()}`;

                // KPI Achievement
                const ordered = acts.filter(a => a.stage === '受注').reduce((sum, a) => sum + (Number(a.amount) || 0), 0);
                const target = isPersonal ? (this.data.kpiSettings.personalTargets[CURRENT_USER.assignee] || 0) : this.data.kpiSettings.totalTarget;
                const rate = target > 0 ? Math.round((ordered / target) * 100) : 0;
                
                document.getElementById('dashboardKpiLabel').textContent = isPersonal ? '個人達成率' : '全体達成率';
                document.getElementById('dashboardKpiRate').textContent = rate + '%';
                document.getElementById('dashboardKpiShortage').textContent = '¥' + Math.max(target - ordered, 0).toLocaleString();
                document.getElementById('dashboardKpiBar').style.width = Math.min(rate, 100) + '%';
                document.getElementById('dashboardKpiBar').textContent = rate + '%';
                document.getElementById('dashboardKpiTarget').textContent = '¥' + Number(target).toLocaleString();
                document.getElementById('dashboardKpiCurrent').textContent = '¥' + ordered.toLocaleString();

                this.renderCharts(acts, target);
				
				// 個人表示時のKPI状況表示
				if (isPersonal) {
					// 個人KPIカードが存在しない場合は追加
					let personalKpiCard = document.getElementById('personalKpiCard');
					if (!personalKpiCard) {
						const dashboardGrid = document.querySelector('.grid-dashboard');
						personalKpiCard = document.createElement('div');
						personalKpiCard.id = 'personalKpiCard';
						personalKpiCard.className = 'card';
						personalKpiCard.style.gridColumn = '1 / -1';
						dashboardGrid.appendChild(personalKpiCard);
					}
    
					// 個人KPI項目を取得
					const userItems = this.data.kpiSettings.personalItems.filter(i => i.userId === CURRENT_USER.assignee);
    
					if (userItems.length > 0) {
						personalKpiCard.style.display = 'block';
        
						let kpiHtml = '<h3>個人別KPI達成状況</h3><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">';
        
						userItems.forEach(item => {
							// 簡易的な達成率計算（数値の場合のみ）
							const goal = parseFloat(item.goalValue);
							const current = parseFloat(item.currentStatus);
							let progressHtml = '';
            
							if (!isNaN(goal) && !isNaN(current) && goal > 0) {
								const rate = Math.min(Math.round((current / goal) * 100), 100);
								const color = rate >= 80 ? '#28a745' : rate >= 50 ? '#ffc107' : '#dc3545';
								progressHtml = `
									<div class="progress-bar-container" style="margin-top: 0.5rem;">
										<div class="progress-bar" style="width: ${rate}%; background-color: ${color};">${rate}%</div>
									</div>
									<div style="font-size: 0.8rem; color: #666; margin-top: 0.3rem;">
										現状: ${current} / 目標: ${goal}
									</div>
								`;
							} else {
								progressHtml = `
									<div style="font-size: 0.85rem; color: #666; margin-top: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
										<div><strong>目標:</strong> ${item.goalValue}</div>
										<div><strong>現状:</strong> ${item.currentStatus || '未設定'}</div>
									</div>
								`;
							}
            
							const deadlineText = item.deadline ? `<div style="font-size: 0.75rem; color: #999;">期限: ${item.deadline}</div>` : '';
            
							kpiHtml += `
								<div style="padding: 1rem; background: #f8f9fa; border-radius: 8px; border-left: 4px solid var(--primary);">
									<div style="font-weight: bold; color: var(--primary); margin-bottom: 0.5rem;">${item.targetItem}</div>
									${deadlineText}
									${progressHtml}
								</div>
							`;
						});
        
						kpiHtml += '</div>';
						personalKpiCard.innerHTML = kpiHtml;
					} else {
						personalKpiCard.style.display = 'none';
					}
				} else {
					// 全体表示時は非表示
					const personalKpiCard = document.getElementById('personalKpiCard');
					if (personalKpiCard) personalKpiCard.style.display = 'none';
				}
            }

            renderCharts(acts, target) {
                ['chartActivity', 'chartProduct', 'chartTimeline'].forEach(id => {
                    const canvas = document.getElementById(id);
                    const parent = canvas.parentElement;
                    const newCanvas = document.createElement('canvas');
                    newCanvas.id = id;
                    parent.innerHTML = '';
                    parent.appendChild(newCanvas);
                });
				
                // Activity Bar - 期間フィルター対応
				const activityPeriod = this.activityPeriod || 'all'; // 'all', 'week', 'month'
				let filteredActs = acts;

				if (activityPeriod === 'week') {
					const now = new Date();
					const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
					filteredActs = acts.filter(a => new Date(a.date) >= weekStart);
				} else if (activityPeriod === 'month') {
					const now = new Date();
					const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
					filteredActs = acts.filter(a => new Date(a.date) >= monthStart);
				}

				const counts = {}; STAFFS.forEach(s => counts[s] = 0);
				filteredActs.forEach(a => { if (counts[a.assignee] !== undefined) counts[a.assignee]++; });

				const periodLabel = activityPeriod === 'all' ? '累計活動件数' : activityPeriod === 'week' ? '今週の活動件数' : '今月の活動件数';

				new Chart(document.getElementById('chartActivity'), {
					type: 'bar',
					data: { labels: STAFFS, datasets: [{ label: periodLabel, data: STAFFS.map(s => counts[s]), backgroundColor: '#2c5aa0' }] },
					options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
				});

                // Product Doughnut - 受注済のみ
				const prods = {}; 
				acts.filter(a => a.stage === '受注').forEach(a => { 
					if(a.product) prods[a.product] = (prods[a.product] || 0) + (Number(a.amount) || 0); 
				});
                const colorPalette = [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                    '#FF9F40', '#E7E9ED', '#76D7C4', '#F7DC6F', '#C0392B',
                    '#8E44AD', '#3498DB', '#2ECC71', '#F39C12', '#D35400'
                ];
                new Chart(document.getElementById('chartProduct'), {
                    type: 'doughnut',
                    data: { labels: Object.keys(prods), datasets: [{ data: Object.values(prods), backgroundColor: colorPalette }] },
                    options: { maintainAspectRatio: false }
                });

                // Funnels
                const stages = ['アプローチ', 'ヒアリング', '提案', '見積提出', 'クロージング', '受注'];
                const stageCounts = {}; stages.forEach(s => stageCounts[s] = { count: 0, amount: 0 });
                acts.forEach(a => { if (stageCounts[a.stage]) { stageCounts[a.stage].count++; stageCounts[a.stage].amount += (Number(a.amount) || 0); } });
                const maxStage = Math.max(...Object.values(stageCounts).map(v => v.count), 1);
                document.getElementById('funnelStage').innerHTML = stages.map(s => `
                    <div class="funnel-item" style="width: ${Math.max((stageCounts[s].count / maxStage) * 100, 10)}%; min-width: 120px; background-color: #2c5aa0;">
                        <span class="funnel-label">${s}</span><span class="funnel-value">${stageCounts[s].count}件 / ¥${(stageCounts[s].amount / 10000).toFixed(0)}万</span>
                    </div>`).join('');

                // Probability Funnel
                const actsForProb = acts.filter(a => a.stage !== '受注');
                const probs = ['A', 'B', 'C', 'D'];
                const probCounts = {}; probs.forEach(p => probCounts[p] = 0);
                actsForProb.forEach(a => { if (probCounts[a.probability] !== undefined) probCounts[a.probability]++; });
                const maxProb = Math.max(...Object.values(probCounts), 1);
                document.getElementById('funnelProbability').innerHTML = probs.map(p => `
                    <div class="funnel-item" style="width: ${Math.max((probCounts[p] / maxProb) * 100, 10)}%; min-width: 50px; background-color: #28a745;">
                        <span class="funnel-label">${p}</span><span class="funnel-value">${probCounts[p]}件</span>
                    </div>`).join('');
	
				// Timeline - 受注済と受注想定を分離、KPI達成状況を明確化
				const months = ['6月','7月','8月','9月','10月','11月','12月','1月','2月','3月','4月','5月'];
				const monthlyOrdered = new Array(12).fill(0);  // 受注済
				const monthlyExpected = new Array(12).fill(0); // 受注想定
																							
				// 現在の月のインデックスを取得（営業年度基準）
				const nowDate = new Date();
				const nowMonth = nowDate.getMonth(); // 0-11
				const nowIdx = (nowMonth - 5 + 12) % 12;
				
				acts.forEach(a => {
					if (a.expected_date) {
						const d = new Date(a.expected_date);
						let m = d.getMonth();
						let idx = (m - 5 + 12) % 12;
						if (idx >= 0 && idx < 12) {
							const amount = Number(a.amount) || 0;
							if (a.stage === '受注') {
								monthlyOrdered[idx] += amount;
							} else {
								monthlyExpected[idx] += amount;
							}
						}
					}
				});

				// 累積（受注済のみ）
				let cumOrdered = 0;
				const cumulativeOrdered = monthlyOrdered.map(v => cumOrdered += v);

				// 現時点の受注済合計
				const currentOrdered = acts.filter(a => a.stage === '受注').reduce((sum, a) => sum + (Number(a.amount) || 0), 0);
				// 受注想定合計（ファネル）
				const totalExpected = acts.filter(a => a.stage !== '受注').reduce((sum, a) => sum + (Number(a.amount) || 0), 0);
				// 不足額
				const shortage = Math.max(target - currentOrdered, 0);
				// その後で表示更新
				document.getElementById('timelineTarget').textContent   = target.toLocaleString();
				document.getElementById('timelineOrdered').textContent  = currentOrdered.toLocaleString();
				document.getElementById('timelineExpected').textContent = totalExpected.toLocaleString();
				document.getElementById('timelineShortage').textContent = shortage.toLocaleString();
				
				new Chart(document.getElementById('chartTimeline'), {
					type: 'bar',
					data: {
						labels: months,
						datasets: [
							{ 
								label: '累積受注済', 
								data: cumulativeOrdered, 
								borderColor: '#FF6384', 
								backgroundColor: 'rgba(255, 99, 132, 0.2)', 
								type: 'line', 
								fill: false, 
								order: 1 
							},
							{ 
								label: '月次受注済', 
								data: monthlyOrdered, 
								backgroundColor: 'rgba(75, 192, 192, 0.6)', 
								type: 'bar', 
								stack: 'stack1',
								order: 3
							},
							{ 
								label: '月次受注想定', 
								data: monthlyExpected, 
								backgroundColor: 'rgba(255, 206, 86, 0.6)', 
								type: 'bar', 
								stack: 'stack1',
								order: 3
							},
							{ 
								label: 'KPI目標', 
								data: Array(12).fill(target), 
								borderColor: '#4BC0C0', 
								borderDash: [5, 5], 
								pointRadius: 0, 
								type: 'line', 
								order: 0 
							}
						]
					},
					options: { 
						maintainAspectRatio: false,
						interaction: { mode: 'index', intersect: false },
						plugins: {
							tooltip: {
								callbacks: {
									footer: function(context) {
										return `\n現在の受注済: ¥${currentOrdered.toLocaleString()}\n受注想定: ¥${totalExpected.toLocaleString()}\n不足額: ¥${shortage.toLocaleString()}`;
									}
								}
							}
						}
					}
				});
            }

            // --- Customer Management ---
            renderCustomers() {
                const filter = document.getElementById('customersFilter').value;
                let list = this.data.customers;
                if (filter === 'personal' && CURRENT_USER.role !== 'admin') {
                    list = list.filter(c => c.assignee === CURRENT_USER.assignee);
                }
                
                if (this.customersSortField) {
                    list.sort((a, b) => {
                        const va = a[this.customersSortField] || '';
                        const vb = b[this.customersSortField] || '';
                        return this.customersSortOrder === 'asc' ? va.localeCompare(vb, 'ja') : vb.localeCompare(va, 'ja');
                    });
                    document.getElementById('sortIconCustomerName').className = this.customersSortOrder === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
                } else {
                    document.getElementById('sortIconCustomerName').className = 'fas fa-sort';
                }

                document.querySelector('#customersTable tbody').innerHTML = list.map(c => `
                    <tr>
                        <td><span class="customer-link" onclick="app.openCustomerStaffModal('${c.id}')">${c.name}</span></td>
                        <td>${c.industry || '-'}</td>
                        <td>${c.rank || '-'}</td>
                        <td>${c.status || '-'}</td>
                        <td>${c.assignee || '-'}</td>
                        <td>${c.staffs.length}</td>
                        <!-- 修正4: ボタン配置修正 -->
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-secondary btn-sm" onclick="app.editCustomer('${c.id}')">編集</button>
                                <button class="btn btn-danger btn-sm" onclick="app.deleteCustomer('${c.id}')">削除</button>
                            </div>
                        </td>
                    </tr>`).join('');
            }

            sortCustomers(field) {
                if (this.customersSortField === field) {
                    this.customersSortOrder = this.customersSortOrder === 'asc' ? 'desc' : 'asc';
                } else {
                    this.customersSortField = field;
                    this.customersSortOrder = 'asc';
                }
                this.renderCustomers();
            }

            // --- Schedule ---
            renderSchedule() {
                const view = document.getElementById('scheduleViewType').value;
                const assignee = document.getElementById('scheduleFilterAssignee').value;
                let list = this.data.schedules;
                if (assignee !== 'all') {
                    list = list.filter(s => s.assignee === assignee);
                }

                if (view === 'calendar') {
                    document.getElementById('calendarView').style.display = 'block';
                    document.getElementById('scheduleListView').style.display = 'none';
                    this.renderCalendar(list);
                } else {
                    document.getElementById('calendarView').style.display = 'none';
                    document.getElementById('scheduleListView').style.display = 'block';
                    
                    if (this.scheduleSortField === 'date') {
                        list.sort((a, b) => this.scheduleSortOrder === 'asc' ? a.date.localeCompare(b.date) : b.date.localeCompare(a.date));
                        document.getElementById('sortIconScheduleDate').className = this.scheduleSortOrder === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
                    }

                    document.querySelector('#scheduleListTable tbody').innerHTML = list.map(s => `
                        <tr>
                            <td>${s.date}</td>
                            <td>${s.time || '-'}</td>
                            <td>${s.assignee}</td>
                            <td>${s.title}</td>
                            <td><button class="btn btn-secondary btn-sm" onclick="app.editSchedule('${s.id}')">編集</button></td>
                        </tr>`).join('');
                }
            }

            sortScheduleList(field) {
                if (this.scheduleSortField === field) {
                    this.scheduleSortOrder = this.scheduleSortOrder === 'asc' ? 'desc' : 'asc';
                } else {
                    this.scheduleSortField = field;
                    this.scheduleSortOrder = 'asc';
                }
                this.renderSchedule();
            }

            renderCalendar(list) {
				const y = this.currentDate.getFullYear();
				const m = this.currentDate.getMonth();
				document.getElementById('currentMonthLabel').textContent = `${y}年 ${m + 1}月`;

				const first = new Date(y, m, 1);
				const last = new Date(y, m + 1, 0);
				const start = new Date(first);
				start.setDate(start.getDate() - start.getDay());
				const end = new Date(last);
				end.setDate(end.getDate() + (6 - end.getDay()));

				let html = '';
				for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
					const year = d.getFullYear();
					const month = String(d.getMonth() + 1).padStart(2, '0');
					const day = String(d.getDate()).padStart(2, '0');
					const dateStr = `${year}-${month}-${day}`;
					
					const isOther = d.getMonth() !== m;
					
					const today = new Date();
					const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
					const isToday = dateStr === todayStr;
					
					// その日の予定を取得して時間順にソート
					const dayScheds = list.filter(s => s.date === dateStr).sort((a, b) => {
						const timeA = a.time || '99:99';  // 時間未設定は最後に表示
						const timeB = b.time || '99:99';
						return timeA.localeCompare(timeB);
					});
					
					html += `<div class="calendar-day ${isOther ? 'other-month' : ''} ${isToday ? 'today' : ''}">
						<div style="text-align:right; font-size:0.8rem; margin-bottom:2px;">${d.getDate()}</div>
						${dayScheds.map(s => {
							// モバイル用テキスト短縮
							const isMobile = window.innerWidth <= 768;
							const maxLength = isMobile ? 10 : 20;
							const displayTitle = s.title.length > maxLength ? 
								s.title.substring(0, maxLength) + '...' : s.title;
							const timeDisplay = s.time ? s.time.substring(0, 5) + ' ' : '';
							
							return `
								<div class="schedule-item" 
									 data-assignee="${s.assignee}" 
									 onclick="app.editSchedule('${s.id}')"
									 title="${s.assignee} - ${s.time || ''} ${s.title}">
									<span class="schedule-assignee">${s.assignee}</span>
									<span>${timeDisplay}${displayTitle}</span>
								</div>
							`;
						}).join('')}
					</div>`;
				}
				document.getElementById('calendarGrid').innerHTML = html;
			}
            changeMonth(delta) {
                this.currentDate.setMonth(this.currentDate.getMonth() + delta);
                this.renderSchedule();
            }

            // --- Activity Log ---
            renderActivities() {
				const filter = document.getElementById('activitiesFilter').value;
				let list = this.data.activities;
				if (filter === 'personal' && CURRENT_USER.role !== 'admin') {
					list = list.filter(a => a.assignee === CURRENT_USER.assignee);
				}
				
				// 拡張ソート処理
				if (this.activitiesSortField) {
					list.sort((a, b) => {
						let valA, valB;
						
						switch(this.activitiesSortField) {
							case 'amount':
								valA = Number(a.amount) || 0;
								valB = Number(b.amount) || 0;
								return this.activitiesSortOrder === 'asc' ? valA - valB : valB - valA;
								
							case 'date':
							case 'expected_date':
								valA = a[this.activitiesSortField] || '9999-12-31';
								valB = b[this.activitiesSortField] || '9999-12-31';
								break;
								
							default:
								valA = (a[this.activitiesSortField] || '').toString();
								valB = (b[this.activitiesSortField] || '').toString();
						}
						
						if (this.activitiesSortField !== 'amount') {
							const result = valA.localeCompare(valB, 'ja');
							return this.activitiesSortOrder === 'asc' ? result : -result;
						}
					});
					
					// ソートアイコンの更新
					const iconMap = {
						'date': 'sortIconActivityDate',
						'assignee': 'sortIconActivityAssignee', 
						'customer': 'sortIconActivityCustomer',
						'purpose': 'sortIconActivityPurpose',
						'stage': 'sortIconActivityStage',
						'expected_date': 'sortIconExpectedDate',
						'probability': 'sortIconActivityProbability',
						'amount': 'sortIconActivityAmount'
					};
					
					// 全アイコンをリセット
					Object.values(iconMap).forEach(iconId => {
						const icon = document.getElementById(iconId);
						if (icon) icon.className = 'fas fa-sort';
					});
					
					// アクティブなソートアイコンを設定
					const activeIcon = document.getElementById(iconMap[this.activitiesSortField]);
					if (activeIcon) {
						activeIcon.className = this.activitiesSortOrder === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
					}
				}

				// テーブル行の生成（機種名を追加）
				document.querySelector('#activitiesTable tbody').innerHTML = list.map(a => `
					<tr>
						<td>${a.date}</td>
						<td>${a.assignee}</td>
						<td>${a.customer}</td>
						<td>${a.purpose}</td>
						<td>${a.partner || '-'}</td>
						<td>${a.product || '-'}</td>
						<td title="${a.content}" onclick="alert('${(a.content || '').replace(/'/g, "\\'")}');" style="cursor:pointer; max-width:150px; overflow:hidden; text-overflow:ellipsis;">${a.content || '-'}</td>
						<td>${a.stage || '-'}</td>
						<td>${a.expected_date || '-'}</td>
						<td>${a.probability || '-'}</td>
						<td>¥${Number(a.amount).toLocaleString()}</td>
						<td>
							<div class="btn-group">
								<button class="btn btn-secondary btn-sm" onclick="app.editActivity('${a.id}')">編集</button>
								<button class="btn btn-danger btn-sm" onclick="app.deleteActivity('${a.id}')">削除</button>
							</div>
						</td>
					</tr>`).join('');
				
				// 顧客選択肢の更新
				const custSelect = document.getElementById('activityCustomer');
				const sortedCustomers = [...this.data.customers].sort((a, b) => a.name.localeCompare(b.name, 'ja'));
				custSelect.innerHTML = '<option value="">選択</option>' + sortedCustomers.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
			}
			
            sortActivities(field) {
                if (this.activitiesSortField === field) {
                    this.activitiesSortOrder = this.activitiesSortOrder === 'asc' ? 'desc' : 'asc';
                } else {
                    this.activitiesSortField = field;
                    this.activitiesSortOrder = 'asc';
                }
                this.renderActivities();
            }

            exportReport(type) {
                const BOM = '\uFEFF';
                const header = '日付,担当,得意先,目的,相手,商談内容,ステージ,確度,金額\n';
                const list = this.data.activities;
                const rows = list.map(a => `${a.date},${a.assignee},${a.customer},${a.purpose},${a.partner || ''},"${(a.content || '').replace(/"/g, '""')}",${a.stage},${a.probability},${a.amount || 0}`).join('\n');
                
                const csv = BOM + header + rows;
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `${type === 'weekly' ? '週報' : '月報'}_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                this.showToast(`${type === 'weekly' ? '週報' : '月報'}を出力しました`, 'success');
            }

            // --- KPI Settings ---
            renderKPI() {
                const totalTarget = this.data.kpiSettings.totalTarget || 0;
                const personalTarget = this.data.kpiSettings.personalTargets[CURRENT_USER.assignee] || 0;
                
                document.getElementById('kpiTotalTarget').value = totalTarget.toLocaleString();
                document.getElementById('kpiPersonalTarget').value = personalTarget.toLocaleString();
                
                // Filter personal items by current user
                const userItems = this.data.kpiSettings.personalItems.filter(i => i.userId === CURRENT_USER.assignee);
                
                document.querySelector('#personalKPITable tbody').innerHTML = userItems.map(i => `
                    <tr>
                        <td>${i.targetItem}</td>
                        <td>${i.goalValue}</td>
                        <td>${i.deadline || '-'}</td>
                        <td>${i.currentStatus || '-'}</td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-secondary btn-sm" onclick="app.editKPIItem('${i.id}')">編集</button>
                                <button class="btn btn-danger btn-sm" onclick="app.deleteKPIItem('${i.id}')">削除</button>
                            </div>
                        </td>
                    </tr>`).join('');
            }

            saveKPITargets() {
                const total = this.parseCurrency(document.getElementById('kpiTotalTarget').value);
                const personal = this.parseCurrency(document.getElementById('kpiPersonalTarget').value);
                
                this.data.kpiSettings.totalTarget = total;
                this.data.kpiSettings.personalTargets[CURRENT_USER.assignee] = personal;
                
                this.saveData();
                this.showToast('KPI目標を保存しました', 'success');
            }

            // Modal Management
            openCustomerModal() {
                document.getElementById('customerId').value = '';
                document.getElementById('customerName').value = '';
                document.getElementById('customerIndustry').value = '';
                document.getElementById('customerRank').value = 'A';
                document.getElementById('customerStatus').value = '取引中';
                document.getElementById('customerAssignee').value = CURRENT_USER.assignee;
                this.openModal('customerModal');
            }

            editCustomer(id) {
                const c = this.data.customers.find(x => x.id == id);
                if (!c) return;
                document.getElementById('customerId').value = c.id;
                document.getElementById('customerName').value = c.name;
                document.getElementById('customerIndustry').value = c.industry || '';
                document.getElementById('customerRank').value = c.rank || 'A';
                document.getElementById('customerStatus').value = c.status || '取引中';
                document.getElementById('customerAssignee').value = c.assignee || '';
                this.openModal('customerModal');
            }

            saveCustomer(e) {
                e.preventDefault();
                const id = document.getElementById('customerId').value;
                const data = {
                    name: document.getElementById('customerName').value,
                    industry: document.getElementById('customerIndustry').value,
                    rank: document.getElementById('customerRank').value,
                    status: document.getElementById('customerStatus').value,
                    assignee: document.getElementById('customerAssignee').value
                };

                if (id) {
                    const idx = this.data.customers.findIndex(x => x.id == id);
                    if (idx !== -1) {
                        this.data.customers[idx] = { ...this.data.customers[idx], ...data };
                    }
                } else {
                    this.data.customers.push({ id: Date.now().toString(), ...data, staffs: [] });
                }

                this.saveData();
                this.closeModal('customerModal');
                this.renderCustomers();
                this.showToast('顧客を保存しました', 'success');
            }

            deleteCustomer(id) {
                if (!confirm('この顧客を削除しますか?')) return;
                this.data.customers = this.data.customers.filter(c => c.id != id);
                this.saveData();
                this.renderCustomers();
                this.showToast('顧客を削除しました', 'success');
            }

            openCustomerStaffModal(customerId) {
                this.currentEditingCustomerId = customerId;
                const c = this.data.customers.find(x => x.id == customerId);
                if (!c) return;
                document.getElementById('staffModalCustomerName').textContent = c.name;
                this.renderCustomerStaffs(c);
                this.openModal('customerStaffModal');
            }

            renderCustomerStaffs(customer) {
                document.querySelector('#customerStaffTable tbody').innerHTML = (customer.staffs || []).map((s, idx) => `
                    <tr>
                        <td>${s.name}</td>
                        <td>${s.dept || '-'}</td>
                        <td>${s.contact || '-'}</td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-secondary btn-sm" onclick="app.editCustomerStaff(${idx})">編集</button>
                                <button class="btn btn-danger btn-sm" onclick="app.deleteCustomerStaff(${idx})">削除</button>
                            </div>
                        </td>
                    </tr>`).join('');
            }

            addCustomerStaff() {
                const name = prompt('担当者名:');
                if (!name) return;
                const dept = prompt('部署・役職:');
                const contact = prompt('連絡先:');
                
                const c = this.data.customers.find(x => x.id == this.currentEditingCustomerId);
                if (!c) return;
                if (!c.staffs) c.staffs = [];
                c.staffs.push({ name, dept, contact });
                this.saveData();
                this.renderCustomerStaffs(c);
                this.renderCustomers();
            }

            editCustomerStaff(idx) {
                const c = this.data.customers.find(x => x.id == this.currentEditingCustomerId);
                if (!c || !c.staffs[idx]) return;
                const s = c.staffs[idx];
                const name = prompt('担当者名:', s.name);
                if (!name) return;
                const dept = prompt('部署・役職:', s.dept);
                const contact = prompt('連絡先:', s.contact);
                c.staffs[idx] = { name, dept, contact };
                this.saveData();
                this.renderCustomerStaffs(c);
                this.renderCustomers();
            }

            deleteCustomerStaff(idx) {
                if (!confirm('この担当者を削除しますか?')) return;
                const c = this.data.customers.find(x => x.id == this.currentEditingCustomerId);
                if (!c) return;
                c.staffs.splice(idx, 1);
                this.saveData();
                this.renderCustomerStaffs(c);
                this.renderCustomers();
            }

            openScheduleModal() {
                document.getElementById('scheduleId').value = '';
                document.getElementById('scheduleTitle').value = '';
                document.getElementById('scheduleDate').value = '';
                document.getElementById('scheduleTime').value = '';
                document.getElementById('scheduleAssignee').value = CURRENT_USER.assignee;
                document.getElementById('deleteScheduleBtn').style.display = 'none';
                this.openModal('scheduleModal');
            }

            editSchedule(id) {
                const s = this.data.schedules.find(x => x.id == id);
                if (!s) return;
                document.getElementById('scheduleId').value = s.id;
                document.getElementById('scheduleTitle').value = s.title;
                document.getElementById('scheduleDate').value = s.date;
                document.getElementById('scheduleTime').value = s.time || '';
                document.getElementById('scheduleAssignee').value = s.assignee;
                document.getElementById('deleteScheduleBtn').style.display = 'inline-block';
                this.openModal('scheduleModal');
            }

            saveSchedule(e) {
                e.preventDefault();
                const id = document.getElementById('scheduleId').value;
                const data = {
                    title: document.getElementById('scheduleTitle').value,
                    date: document.getElementById('scheduleDate').value,
                    time: document.getElementById('scheduleTime').value,
                    assignee: document.getElementById('scheduleAssignee').value
                };

                if (id) {
                    const idx = this.data.schedules.findIndex(x => x.id == id);
                    if (idx !== -1) this.data.schedules[idx] = { ...this.data.schedules[idx], ...data };
                } else {
                    this.data.schedules.push({ id: Date.now().toString(), ...data });
                }

                this.saveData();
                this.closeModal('scheduleModal');
                this.renderSchedule();
                this.showToast('予定を保存しました', 'success');
            }

            deleteSchedule() {
                const id = document.getElementById('scheduleId').value;
                if (!confirm('この予定を削除しますか?')) return;
                this.data.schedules = this.data.schedules.filter(s => s.id != id);
                this.saveData();
                this.closeModal('scheduleModal');
                this.renderSchedule();
                this.showToast('予定を削除しました', 'success');
            }

            openActivityModal() {
                document.getElementById('activityId').value = '';
                document.getElementById('activityDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('activityAssignee').value = CURRENT_USER.assignee;
                document.getElementById('activityCustomer').value = '';
                document.getElementById('activityPurpose').value = 'A';
                document.getElementById('activityPartner').value = '';
                document.getElementById('activityProduct').value = '';
                document.getElementById('activityContent').value = '';
                document.getElementById('activityStage').value = 'アプローチ';
                document.getElementById('activityProbability').value = 'A';
                document.getElementById('activityAmount').value = '';
                document.getElementById('activityExpectedDate').value = '';
				
				// 案件選択肢の初期化
				document.getElementById('activityProject').innerHTML = '<option value="">案件なし（通常活動）</option>';
				document.getElementById('projectLinkSection').style.display = 'none';
				document.getElementById('projectCreateSection').style.display = 'block';

				// 得意先変更時の案件更新イベント
				const custSelect = document.getElementById('activityCustomer');
				custSelect.onchange = (e) => {
					this.updateActivityProjectOptions(e.target.value);
				};

                this.openModal('activityModal');
            }

			editActivity(id) {
				const a = this.data.activities.find(x => x.id == id);
				if (!a) return;
				document.getElementById('activityId').value = a.id;
				document.getElementById('activityDate').value = a.date;
				document.getElementById('activityAssignee').value = a.assignee;
				document.getElementById('activityCustomer').value = a.customer;
				document.getElementById('activityPurpose').value = a.purpose;
				document.getElementById('activityPartner').value = a.partner || '';
				document.getElementById('activityProduct').value = a.product || '';
				document.getElementById('activityContent').value = a.content || '';
				document.getElementById('activityStage').value = a.stage || 'アプローチ';
				
				const probSelect = document.getElementById('activityProbability');
				if (a.stage === '受注') {
					probSelect.innerHTML = '<option value="">空白</option><option value="受注済">受注済</option>';
				} else {
					probSelect.innerHTML = '<option value="A">A (高)</option><option value="B">B</option><option value="C">C</option><option value="D">D (低)</option>';
				}
				probSelect.value = a.probability || '';
				
				document.getElementById('activityAmount').value = a.amount || '';
				document.getElementById('activityExpectedDate').value = a.expected_date || '';
				
				// 案件選択肢の更新
				this.updateActivityProjectOptions(a.customer);

				// 案件連携情報の表示
				document.getElementById('activityProjectId').value = a.projectId || '';
				document.getElementById('activityProject').value = a.projectId || '';

				if (a.projectId) {
					const linkedProject = this.data.projects.find(p => p.id === a.projectId);
					if (linkedProject) {
						this.updateProjectLinkUI(linkedProject);
					}
				} else {
					document.getElementById('projectLinkSection').style.display = 'none';
					document.getElementById('projectCreateSection').style.display = 'block';
				}

				this.openModal('activityModal');
			}
				
			updateActivityProjectOptions(customerName) {
				const projectSelect = document.getElementById('activityProject');
				projectSelect.innerHTML = '<option value="">案件なし（通常活動）</option>';
					
				if (!customerName) return;
					
				// その顧客の進行中・保留中の案件のみ表示
				const relatedProjects = this.data.projects.filter(p => 
					p.customer === customerName && 
					(p.status === '進行中' || p.status === '保留')
				);
					
				relatedProjects.forEach(p => {
					const option = document.createElement('option');
					option.value = p.id;
					option.textContent = `[${p.stage}] ${p.projectName}`;
					projectSelect.appendChild(option);
				});
			}
        
            saveActivity(e) {
				e.preventDefault();
				const id = document.getElementById('activityId').value;
				const data = {
					date: document.getElementById('activityDate').value,
					assignee: document.getElementById('activityAssignee').value,
					customer: document.getElementById('activityCustomer').value,
					purpose: document.getElementById('activityPurpose').value,
					partner: document.getElementById('activityPartner').value,
					product: document.getElementById('activityProduct').value,
					content: document.getElementById('activityContent').value,
					stage: document.getElementById('activityStage').value,
					probability: document.getElementById('activityProbability').value,
					amount: Number(document.getElementById('activityAmount').value) || 0,
					expected_date: document.getElementById('activityExpectedDate').value,
					projectId: document.getElementById('activityProjectId')?.value || null  // ★案件連携
				};

				if (id) {
					const idx = this.data.activities.findIndex(x => x.id === id);
					if (idx !== -1) {
						this.data.activities[idx] = { ...this.data.activities[idx], ...data };
						
						// ★既存案件の自動更新
						if (data.projectId) {
							this.updateProjectFromActivity(data.projectId, data);
						}
					}
				} else {
					this.data.activities.push({ id: Date.now().toString(), ...data });
				}

				this.saveData();
				this.closeModal('activityModal');
				this.renderActivities();
				this.showToast('活動記録を保存しました', 'success');
			}

            deleteActivity(id) {
                if (!confirm('この活動記録を削除しますか?')) return;
                this.data.activities = this.data.activities.filter(a => a.id != id);
                this.saveData();
                this.renderActivities();
                this.showToast('活動記録を削除しました', 'success');
            }

            openKPIModal() {
                document.getElementById('kpiItemId').value = '';
                document.getElementById('kpiTargetItem').value = '';
                document.getElementById('kpiGoalValue').value = '';
                document.getElementById('kpiDeadline').value = '';
                document.getElementById('kpiCurrentStatus').value = '';
                this.openModal('kpiItemModal');
            }

            editKPIItem(id) {
                const item = this.data.kpiSettings.personalItems.find(x => x.id == id);
                if (!item) return;
                document.getElementById('kpiItemId').value = item.id;
                document.getElementById('kpiTargetItem').value = item.targetItem;
                document.getElementById('kpiGoalValue').value = item.goalValue;
                document.getElementById('kpiDeadline').value = item.deadline || '';
                document.getElementById('kpiCurrentStatus').value = item.currentStatus || '';
                this.openModal('kpiItemModal');
            }

            saveKPIItem(e) {
                e.preventDefault();
                const id = document.getElementById('kpiItemId').value;
                const data = {
                    targetItem: document.getElementById('kpiTargetItem').value,
                    goalValue: document.getElementById('kpiGoalValue').value,
                    deadline: document.getElementById('kpiDeadline').value,
                    currentStatus: document.getElementById('kpiCurrentStatus').value,
                    userId: CURRENT_USER.assignee
                };

                if (id) {
                    const idx = this.data.kpiSettings.personalItems.findIndex(x => x.id == id);
                    if (idx !== -1) this.data.kpiSettings.personalItems[idx] = { ...this.data.kpiSettings.personalItems[idx], ...data };
                } else {
                    this.data.kpiSettings.personalItems.push({ id: Date.now().toString(), ...data });
                }

                this.saveData();
                this.closeModal('kpiItemModal');
                this.renderKPI();
                this.showToast('KPI項目を保存しました', 'success');
            }

            deleteKPIItem(id) {
                if (!confirm('このKPI項目を削除しますか?')) return;
                this.data.kpiSettings.personalItems = this.data.kpiSettings.personalItems.filter(i => i.id != id);
                this.saveData();
                this.renderKPI();
                this.showToast('KPI項目を削除しました', 'success');
            }

            // ========================================
			// Project Management Functions
			// ========================================

			generateProjectNumber() {
				const year = new Date().getFullYear();
				const existingProjects = this.data.projects.filter(p => p.projectNumber && p.projectNumber.startsWith(`PRJ-${year}`));
				const nextNum = existingProjects.length + 1;
				return `PRJ-${year}-${String(nextNum).padStart(3, '0')}`;
			}

			calculateStagnantDays(project) {
				if (!project.lastActivityDate) return 0;
				const lastDate = new Date(project.lastActivityDate);
				const today = new Date();
				const diffTime = Math.abs(today - lastDate);
				return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
			}

			renderProjects() {
				const filter = document.getElementById('projectsFilter').value;
				const statusFilter = document.getElementById('projectsStatusFilter').value;
				
				let list = this.data.projects || [];
				
				// フィルタリング
				if (filter === 'personal' && CURRENT_USER.role !== 'admin') {
					list = list.filter(p => p.assignee === CURRENT_USER.assignee);
				}
				if (statusFilter !== 'all') {
					list = list.filter(p => p.status === statusFilter);
				}
				
				// ソート処理
				if (this.projectsSortField) {
					list.sort((a, b) => {
						let valA, valB;
						
						if (this.projectsSortField === 'estimatedAmount') {
							valA = Number(a.estimatedAmount) || 0;
							valB = Number(b.estimatedAmount) || 0;
							return this.projectsSortOrder === 'asc' ? valA - valB : valB - valA;
						} else {
							valA = (a[this.projectsSortField] || '').toString();
							valB = (b[this.projectsSortField] || '').toString();
							const result = valA.localeCompare(valB, 'ja');
							return this.projectsSortOrder === 'asc' ? result : -result;
						}
					});
				}
				
				// Phase 2-2: 滞留アラートの生成
				const stagnantProjects = list.filter(p => {
					const days = this.calculateStagnantDays(p);
					return p.status === '進行中' && days >= 30;
				}).sort((a, b) => this.calculateStagnantDays(b) - this.calculateStagnantDays(a));
				
				let alertsHtml = '';
				if (stagnantProjects.length > 0) {
					alertsHtml = '<div class="card"><h3 style="margin-top: 0; color: #dc3545;"><i class="fas fa-exclamation-triangle"></i> 滞留案件アラート</h3>';
					stagnantProjects.slice(0, 5).forEach(p => {
						const days = this.calculateStagnantDays(p);
						const alertClass = days >= 60 ? 'project-alert-danger' : 'project-alert-warning';
						const alertIcon = days >= 60 ? 'fas fa-exclamation-circle' : 'fas fa-exclamation-triangle';
						alertsHtml += `
							<div class="${alertClass}" style="padding: 1rem; margin-bottom: 0.5rem; border-radius: 8px; display: flex; align-items: center; gap: 1rem;">
								<i class="${alertIcon}" style="font-size: 1.5rem;"></i>
								<div style="flex: 1;">
									<strong>${p.projectName}</strong> (${p.projectNumber})<br>
									<small>担当: ${p.assignee} | ステージ: ${p.stage} | 滞留: ${days}日</small>
								</div>
								<button class="btn btn-sm btn-primary" onclick="app.editProject('${p.id}')">確認</button>
							</div>
						`;
					});
					alertsHtml += '</div>';
				}
				document.getElementById('projectAlerts').innerHTML = alertsHtml;
				
				// テーブル行の生成
				document.querySelector('#projectsTable tbody').innerHTML = list.map(p => {
					const stagnantDays = this.calculateStagnantDays(p);
					let stagnantClass = '';
					let stagnantText = `${stagnantDays}日`;
					
					if (p.status === '進行中') {
						if (stagnantDays >= 60) {
							stagnantClass = 'stagnant-danger';
						} else if (stagnantDays >= 30) {
							stagnantClass = 'stagnant-warning';
						}
					}
					
					const rowClass = p.status === '進行中' && stagnantDays >= 60 ? 'project-alert-danger' : 
									p.status === '進行中' && stagnantDays >= 30 ? 'project-alert-warning' : '';
					
					const docCount = p.documents ? p.documents.length : 0;
					
					return `
						<tr class="${rowClass}">
							<td><strong>${p.projectNumber}</strong></td>
							<td>${p.projectName}</td>
							<td>${p.customer}</td>
							<td>${p.product || '-'}</td>
							<td>${p.assignee}</td>
							<td>${p.stage}</td>
							<td>${p.probability || '-'}</td>
							<td>¥${Number(p.estimatedAmount || 0).toLocaleString()}</td>
							<td>${p.expectedOrderDate || '-'}</td>
							<td class="stagnant-days ${stagnantClass}">${stagnantText}</td>
							<td><span style="padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; background: ${p.status === '進行中' ? '#28a745' : p.status === '完了' ? '#007bff' : '#6c757d'}; color: white;">${p.status}</span></td>
							<td>
								<button class="btn btn-sm btn-secondary" onclick="app.openDocumentModal('${p.id}')">
									<i class="fas fa-folder"></i> ${docCount}
								</button>
							</td>
							<td>
								<div class="btn-group">
									<button class="btn btn-secondary btn-sm" onclick="app.editProject('${p.id}')">編集</button>
									<button class="btn btn-danger btn-sm" onclick="app.deleteProject('${p.id}')">削除</button>
								</div>
							</td>
						</tr>
					`;
				}).join('');
			}

			sortProjects(field) {
				if (this.projectsSortField === field) {
					this.projectsSortOrder = this.projectsSortOrder === 'asc' ? 'desc' : 'asc';
				} else {
					this.projectsSortField = field;
					this.projectsSortOrder = 'asc';
				}
				this.renderProjects();
			}

			openProjectModal() {
				document.getElementById('projectId').value = '';
				document.getElementById('projectNumber').value = this.generateProjectNumber();
				document.getElementById('projectName').value = '';
				document.getElementById('projectCustomer').value = '';
				document.getElementById('projectProduct').value = '';
				document.getElementById('projectAssignee').value = CURRENT_USER.assignee;
				document.getElementById('projectStage').value = 'アプローチ';
				document.getElementById('projectProbability').value = 'B';
				document.getElementById('projectAmount').value = '';
				document.getElementById('projectExpectedDate').value = '';
				document.getElementById('projectStatus').value = '進行中';
				document.getElementById('projectNotes').value = '';
				document.getElementById('deleteProjectBtn').style.display = 'none';
				
				// 顧客選択肢の更新
				const custSelect = document.getElementById('projectCustomer');
				const sortedCustomers = [...this.data.customers].sort((a, b) => a.name.localeCompare(b.name, 'ja'));
				custSelect.innerHTML = '<option value="">選択してください</option>' + sortedCustomers.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
				
				// ファイルリストの初期化
				this.currentProjectFiles = [];
				this.renderFileList();
				
				this.openModal('projectModal');
			}

			editProject(id) {
				const p = this.data.projects.find(x => x.id === id);
				if (!p) return;
				
				document.getElementById('projectId').value = p.id;
				document.getElementById('projectNumber').value = p.projectNumber;
				document.getElementById('projectName').value = p.projectName;
				document.getElementById('projectProduct').value = p.product || '';
				document.getElementById('projectAssignee').value = p.assignee;
				document.getElementById('projectStage').value = p.stage;
				document.getElementById('projectProbability').value = p.probability || 'B';
				document.getElementById('projectAmount').value = p.estimatedAmount || '';
				document.getElementById('projectExpectedDate').value = p.expectedOrderDate || '';
				document.getElementById('projectStatus').value = p.status;
				document.getElementById('projectNotes').value = p.notes || '';
				document.getElementById('deleteProjectBtn').style.display = 'inline-block';
				
				// 顧客選択肢の更新
				const custSelect = document.getElementById('projectCustomer');
				const sortedCustomers = [...this.data.customers].sort((a, b) => a.name.localeCompare(b.name, 'ja'));
				custSelect.innerHTML = '<option value="">選択してください</option>' + sortedCustomers.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
				custSelect.value = p.customer;
				
				// ファイルリストの設定
				this.currentProjectFiles = p.documents || [];
				this.renderFileList();
				
				this.openModal('projectModal');
			}

			saveProject(e) {
				e.preventDefault();
				const id = document.getElementById('projectId').value;
				const projectNumber = document.getElementById('projectNumber').value;
				
				const data = {
					id: id || Date.now().toString(),
					projectNumber: projectNumber,
					projectName: document.getElementById('projectName').value,
					customer: document.getElementById('projectCustomer').value,
					product: document.getElementById('projectProduct').value,
					assignee: document.getElementById('projectAssignee').value,
					stage: document.getElementById('projectStage').value,
					probability: document.getElementById('projectProbability').value,
					estimatedAmount: Number(document.getElementById('projectAmount').value) || 0,
					expectedOrderDate: document.getElementById('projectExpectedDate').value,
					status: document.getElementById('projectStatus').value,
					notes: document.getElementById('projectNotes').value,
					lastActivityDate: new Date().toISOString().split('T')[0],
					createdDate: id ? this.data.projects.find(p => p.id === id)?.createdDate : new Date().toISOString().split('T')[0],
					documents: this.currentProjectFiles || []
				};
				
				if (id) {
					const idx = this.data.projects.findIndex(x => x.id === id);
					if (idx !== -1) this.data.projects[idx] = data;
				} else {
					this.data.projects.push(data);
				}
				
				this.saveData();
				this.closeModal('projectModal');
				this.renderProjects();
				this.showToast('案件を保存しました', 'success');
			}

			deleteProject(id) {
				if (!id) id = document.getElementById('projectId').value;
				if (!confirm('この案件を削除しますか？関連ドキュメントも削除されます。')) return;
				
				this.data.projects = this.data.projects.filter(p => p.id !== id);
				this.saveData();
				this.closeModal('projectModal');
				this.renderProjects();
				this.showToast('案件を削除しました', 'success');
			}
			
			// ========================================
			// 活動記録⇔案件連携機能
			// ========================================

			createProjectFromActivity() {
				// フォームデータの取得
				const customerName = document.getElementById('activityCustomer').value;
				const productName = document.getElementById('activityProduct').value;
				const assignee = document.getElementById('activityAssignee').value;
				const stage = document.getElementById('activityStage').value;
				const probability = document.getElementById('activityProbability').value;
				const amount = document.getElementById('activityAmount').value;
				const expectedDate = document.getElementById('activityExpectedDate').value;
				const content = document.getElementById('activityContent').value;
				
				if (!customerName) {
					alert('得意先を選択してください');
					return;
				}
				
				// 案件自動生成
				const projectNumber = this.generateProjectNumber();
				const projectName = `${customerName} ${productName || '案件'} (活動記録から作成)`;
				
				const newProject = {
					id: Date.now().toString(),
					projectNumber: projectNumber,
					projectName: projectName,
					customer: customerName,
					product: productName || '',
					assignee: assignee,
					stage: stage,
					probability: probability || 'B',
					estimatedAmount: Number(amount) || 0,
					expectedOrderDate: expectedDate,
					status: '進行中',
					notes: `活動記録から自動作成\n初回商談内容: ${content}`,
					lastActivityDate: document.getElementById('activityDate').value,
					createdDate: new Date().toISOString().split('T')[0],
					documents: [],
					relatedActivityIds: []
				};
				
				this.data.projects.push(newProject);
				
				// UI更新
				document.getElementById('activityProjectId').value = newProject.id;
				this.updateProjectLinkUI(newProject);
				
				this.saveData();
				this.showToast(`案件 ${projectNumber} を作成しました`, 'success');
			}

			updateProjectFromActivity(projectId, activityData) {
				const project = this.data.projects.find(p => p.id === projectId);
				if (!project) return;
				
				// 案件情報を最新の活動記録で自動更新
				project.stage = activityData.stage;
				project.probability = activityData.probability;
				project.estimatedAmount = Number(activityData.amount) || project.estimatedAmount;
				project.expectedOrderDate = activityData.expected_date || project.expectedOrderDate;
				project.lastActivityDate = activityData.date;
				
				// ステータスの自動更新
				if (activityData.stage === '受注') {
					project.status = '完了';
				}
				
				this.saveData();
				this.showToast('関連案件も自動更新されました', 'info');
			}

			linkToProject() {
				const projectId = document.getElementById('activityProject').value;
				document.getElementById('activityProjectId').value = projectId;
				
				if (projectId) {
					const project = this.data.projects.find(p => p.id === projectId);
					if (project) {
						this.updateProjectLinkUI(project);
					}
				} else {
					document.getElementById('projectLinkSection').style.display = 'none';
				}
			}

			updateProjectLinkUI(project) {
				document.getElementById('linkedProjectInfo').innerHTML = `
					<strong>${project.projectNumber}</strong>: ${project.projectName}<br>
					<small>この活動は案件に自動連携されます</small>
				`;
				document.getElementById('projectLinkSection').style.display = 'block';
				document.getElementById('projectCreateSection').style.display = 'none';
			}

			unlinkProject() {
				if (!confirm('案件との連携を解除しますか？\n（案件自体は削除されません）')) return;
				
				document.getElementById('activityProjectId').value = '';
				document.getElementById('activityProject').value = '';
				document.getElementById('projectLinkSection').style.display = 'none';
				document.getElementById('projectCreateSection').style.display = 'block';
				this.showToast('案件連携を解除しました', 'success');
			}
			
			// ========================================
			// Phase 2-3: Document Management Functions
			// ========================================

			setupFileUploadEvents() {
				const dropZone = document.getElementById('dropZone');
				const fileInput = document.getElementById('fileInput');
				
				if (!dropZone || !fileInput) return;
				
				dropZone.addEventListener('click', () => fileInput.click());
				
				dropZone.addEventListener('dragover', (e) => {
					e.preventDefault();
					dropZone.classList.add('dragover');
				});
				
				dropZone.addEventListener('dragleave', () => {
					dropZone.classList.remove('dragover');
				});
				
				dropZone.addEventListener('drop', (e) => {
					e.preventDefault();
					dropZone.classList.remove('dragover');
					if (e.dataTransfer.files.length) {
						this.handleFileUpload(e.dataTransfer.files);
					}
				});
				
				fileInput.addEventListener('change', (e) => {
					if (e.target.files.length) {
						this.handleFileUpload(e.target.files);
					}
				});
			}

			async handleFileUpload(files) {
				if (!supabaseClient) {
					alert('Supabase設定がされていないためアップロードできません');
					return;
				}
				
				const progressEl = document.getElementById('uploadProgress');
				progressEl.style.display = 'block';
				
				for (let file of files) {
					try {
						// バージョン管理：同名ファイルの最新バージョン番号を取得
						const existingFiles = this.currentProjectFiles.filter(f => f.originalName === file.name);
						const version = existingFiles.length + 1;
						
						// ファイル名にタイムスタンプとバージョンを付与
						const timestamp = new Date().getTime();
						const fileExt = file.name.split('.').pop();
						const fileName = `v${version}_${timestamp}_${file.name}`;
						const filePath = `projects/${fileName}`;
						
						const { data, error } = await supabaseClient.storage
							.from('project-files')
							.upload(filePath, file);
							
						if (error) throw error;
						
						// 公開URLの取得
						const { data: publicData } = supabaseClient.storage
							.from('project-files')
							.getPublicUrl(filePath);
						
						// ファイルメタデータを配列に追加
						this.currentProjectFiles.push({
							id: Date.now().toString() + Math.random(),
							originalName: file.name,
							fileName: fileName,
							filePath: filePath,
							publicUrl: publicData.publicUrl,
							version: version,
							fileSize: (file.size / 1024).toFixed(1) + ' KB',
							uploadDate: new Date().toISOString().split('T')[0],
							uploadedBy: CURRENT_USER.assignee,
							fileType: fileExt.toLowerCase()
						});
						
					} catch (err) {
						console.error('Upload failed:', err);
						alert(`アップロード失敗: ${file.name} - ${err.message}`);
					}
				}
				
				progressEl.style.display = 'none';
				this.renderFileList();
				this.showToast('ファイルをアップロードしました', 'success');
			}

			renderFileList() {
				const listEl = document.getElementById('fileList');
				if (!this.currentProjectFiles || this.currentProjectFiles.length === 0) {
					listEl.innerHTML = '<p style="color: #666; font-style: italic;">まだドキュメントがありません</p>';
					return;
				}
				
				// ファイル名でグループ化してバージョン表示
				const groupedFiles = {};
				this.currentProjectFiles.forEach(f => {
					if (!groupedFiles[f.originalName]) {
						groupedFiles[f.originalName] = [];
					}
					groupedFiles[f.originalName].push(f);
				});
				
				let html = '';
				Object.keys(groupedFiles).forEach(fileName => {
					const versions = groupedFiles[fileName].sort((a, b) => b.version - a.version);
					const latest = versions[0];
					const fileIcon = this.getFileIcon(latest.fileType);
					
					html += `
						<div class="file-item">
							<div style="display: flex; align-items: center; gap: 0.5rem; flex: 1;">
								<i class="${fileIcon}" style="font-size: 1.5rem; color: var(--primary);"></i>
								<div>
									<div>
										<span class="version-badge">v${latest.version}</span>
										<a href="${latest.publicUrl}" target="_blank" style="font-weight: bold; text-decoration: underline;">
											${latest.originalName}
										</a>
									</div>
									<small style="color: #666;">
										${latest.fileSize} | ${latest.uploadDate} | ${latest.uploadedBy}
										${versions.length > 1 ? ` | 他${versions.length - 1}バージョン` : ''}
									</small>
								</div>
							</div>
							<div class="btn-group">
								${versions.length > 1 ? `<button class="btn btn-sm btn-secondary" onclick="app.showFileVersions('${fileName}')">履歴</button>` : ''}
								<button class="btn btn-sm btn-danger" onclick="app.removeFileGroup('${fileName}')">削除</button>
							</div>
						</div>
					`;
				});
				
				listEl.innerHTML = html;
			}

			getFileIcon(fileType) {
				const iconMap = {
					'pdf': 'fas fa-file-pdf',
					'xlsx': 'fas fa-file-excel', 'xls': 'fas fa-file-excel',
					'docx': 'fas fa-file-word', 'doc': 'fas fa-file-word',
					'dwg': 'fas fa-drafting-compass', 'dxf': 'fas fa-drafting-compass',
					'jpg': 'fas fa-file-image', 'jpeg': 'fas fa-file-image', 'png': 'fas fa-file-image',
					'zip': 'fas fa-file-archive', 'rar': 'fas fa-file-archive'
				};
				return iconMap[fileType] || 'fas fa-file';
			}

			removeFileGroup(fileName) {
				if (!confirm(`「${fileName}」の全バージョンを削除しますか？`)) return;
				
				this.currentProjectFiles = this.currentProjectFiles.filter(f => f.originalName !== fileName);
				this.renderFileList();
			}

			showFileVersions(fileName) {
				const versions = this.currentProjectFiles
					.filter(f => f.originalName === fileName)
					.sort((a, b) => b.version - a.version);
				
				let versionList = `「${fileName}」のバージョン履歴:\n\n`;
				versions.forEach(v => {
					versionList += `v${v.version} - ${v.uploadDate} (${v.uploadedBy}) - ${v.fileSize}\n`;
				});
				
				alert(versionList);
			}

			openDocumentModal(projectId) {
				// 将来的な拡張：プロジェクト専用ドキュメント管理画面
				const project = this.data.projects.find(p => p.id === projectId);
				if (!project) return;
				
				alert(`${project.projectName} のドキュメント管理機能は今後実装予定です。\n現在は案件編集画面からファイル管理をご利用ください。`);
			}

			openModal(id) { document.getElementById(id).classList.add('active'); }
            closeModal(id) { document.getElementById(id).classList.remove('active'); }

            showToast(msg, type = 'success') {
                const toast = document.getElementById('toast');
                toast.textContent = msg;
                toast.className = `toast toast-${type}`;
                toast.style.display = 'block';
                setTimeout(() => { toast.style.display = 'none'; }, 3000);
            }

            showLoading(show) {
                document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
            }

            formatCurrency(input) {
                let val = input.value.replace(/,/g, '');
                if (!isNaN(val) && val !== '') {
                    input.value = Number(val).toLocaleString();
                }
            }

            parseCurrency(str) {
                return Number((str || '').replace(/,/g, '')) || 0;
            }

            saveData() {
				saveSalesData(this.data);
			}

            loadData() {
				const saved = JSON.parse(localStorage.getItem('salesData') || '{}');
				this.data = {
					customers: saved.customers || [],
					schedules: saved.schedules || [],
					activities: saved.activities || [],
					projects: saved.projects || [],  // 新規追加
					kpiSettings: saved.kpiSettings || {
						totalTarget: 300000000,
						personalTargets: {
							'永森': 100000000,
							'箱崎': 100000000,
							'清水': 100000000,
							'杉田': 100000000,
							'安里': 100000000,
							'鎌田': 100000000,
							'大山': 100000000
						},
						personalItems: []
					}
				};
			}

        }

        let app;

        // DOM読み込み後にアプリ起動
        window.addEventListener('DOMContentLoaded', async () => {
			app = new SalesApp();
			
			// アプリ初期化完了を待つ
			await new Promise(resolve => setTimeout(resolve, 100));
			
			await loadFromSupabaseAndApply();
			subscribeSalesDataRealtime();
		});

        // ================================
        // Supabase から初期データ取得
        // ================================
		async function loadFromSupabaseAndApply() {
			if (!supabaseClient || !app) return;

			const { data, error } = await supabaseClient
				.from('sales_data')
				.select('payload')
				.eq('id', 'shared')
				.single();

			if (error) {
				console.warn('Supabase load failed, fallback to localStorage', error);
				return;
			}

			if (!data?.payload) return;

			const payload = data.payload;
    
			// 新旧両方の形式に対応
			const core = payload.data || payload;

			app.data = {
				customers: core.customers || [],
				schedules: core.schedules || [],
				activities: core.activities || [],
				projects: core.projects || [],      
				kpiSettings: core.kpiSettings || {
				totalTarget: 300000000,
					personalTargets: {},
					personalItems: []
				}
			};

			localStorage.setItem('salesData', JSON.stringify(app.data));

			app.renderDashboard();
			app.renderCustomers();
			app.renderSchedule();
			app.renderActivities();

			console.log('Supabase data applied');
		}

        // ================================
        // Realtime購読
        // ================================
        function subscribeSalesDataRealtime() {
            if (!supabaseClient) return;

            supabaseClient
                .channel('sales-data-channel')
                .on(
                    'postgres_changes',
                    {
                        event: '*',
                        schema: 'public',
                        table: 'sales_data'
                    },
                    (payload) => {
                        console.log('Realtime update received', payload);

                        const newPayload = payload.new?.payload;
                        if (!newPayload) return;

                        // 自分の更新は無視（二重反映防止）
                        if (newPayload._updatedBy === CURRENT_USER.assignee) {
                            return;
                        }

                        app.data = {
                            customers: newPayload.customers || app.data.customers || [],
                            schedules: newPayload.schedules || app.data.schedules || [],
                            activities: newPayload.activities || app.data.activities || [],
							projects: newPayload.projects || app.data.projects || [], 
                            kpiSettings: newPayload.kpiSettings || app.data.kpiSettings
                        };

                        // localStorage も更新
                        localStorage.setItem('salesData', JSON.stringify(app.data));

                        // 再描画
                        app.renderDashboard();
                        app.renderCustomers();
                        app.renderSchedule();
                        app.renderActivities();

                        app.showToast('他のユーザーがデータを更新しました', 'success');
                    }
                )
                .subscribe();
        }

        // ================================
        // 保存専用関数（localStorage + Supabase）
        // ================================
        function saveSalesData(data) {
            // ① localStorage に保存
            localStorage.setItem('salesData', JSON.stringify(data));

            // ② Supabase に送信
            syncToSupabase(data);
        }

        // ================================
        // Supabase 同期処理
        // ================================
        async function syncToSupabase(data) {
            if (!supabaseClient) {
                console.warn('Supabase client not initialized');
                return;
            }

            const payload = {
                ...data,
                _updatedBy: CURRENT_USER.assignee
            };

            const { error } = await supabaseClient
                .from('sales_data')
                .upsert({
                    id: 'shared',
                    payload: payload,
                    updated_at: new Date().toISOString()
                });

            if (error) {
                console.error('Supabase upsert error:', error);
            } else {
                console.log('Supabase updated successfully', payload);
            }
        }
    </script>
</body>
</html>

