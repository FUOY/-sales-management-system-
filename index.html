<!DOCTYPE html>
<html lang="ja" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>販売管理システム</title>
    <!-- 外部ライブラリ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #2c5aa0;
            --primary-hover: #1e3a5f;
            --background: #f5f7fa;
            --card-bg: #ffffff;
            --text-color: #333333;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Meiryo', sans-serif;
            background-color: var(--background);
            color: var(--text-color);
            min-height: 100vh;
        }

        /* 1. ログイン画面のレイアウト修正 */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: fixed;
            top: 0;
            left: 0;
            z-index: 9999;
        }

        .login-card {
            background: white;
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 450px; /* 幅調整 */
            text-align: center;
        }

        .login-header {
            color: var(--primary);
            margin-bottom: 2rem;
            border-bottom: 2px solid #eee;
            padding-bottom: 1rem;
        }

        /* 2. テキストの改行問題修正 */
        .tab-button, 
        .page-title, 
        h2, h3, h4,
        button, 
        .btn, 
        .modal-header h3,
        th {
            white-space: nowrap;
        }

        /* アプリケーション全体 */
        .app-container {
            display: none;
            flex-direction: column;
            min-height: 100vh;
        }

        .app-header {
            background: var(--primary);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .app-title {
            margin: 0;
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* タブメニュー */
        .tab-menu {
            background: #1e3a5f;
            display: flex;
            padding: 0 1rem;
            overflow-x: auto;
        }

        .tab-button {
            background: transparent;
            border: none;
            color: #ccc;
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            font-size: 1rem;
            border-bottom: 3px solid transparent;
        }

        .tab-button:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }

        .tab-button.active {
            color: white;
            border-bottom: 3px solid white;
            background: rgba(255, 255, 255, 0.05);
        }

        /* メインコンテンツ */
        .main-content {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            flex: 1;
            overflow-x: auto; /* 横スクロール対応 */
        }

        .page-section {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .page-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* カードコンポーネント */
        .card {
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            overflow: hidden; /* コンテンツはみ出し防止 */
        }

        .card h2, .card h3 {
            color: var(--primary);
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }

        /* グリッドレイアウト */
        .grid-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            border-left: 5px solid var(--primary);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
            margin: 0.5rem 0;
        }

        .stat-label { color: #666; font-size: 0.9rem; }

        .grid-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
        }

        /* テーブル */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th { background-color: #f8f9fa; font-weight: bold; color: var(--primary); }
        tr:hover { background-color: #f5f5f5; }

        /* 顧客名リンク */
        .customer-link {
            color: var(--primary);
            text-decoration: underline;
            cursor: pointer;
            font-weight: bold;
        }
        .customer-link:hover { color: var(--primary-hover); }

        /* ファネルチャート */
        .funnel-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .funnel-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 1rem;
            color: white;
            border-radius: 4px;
            font-size: 0.9rem;
            transition: width 0.5s ease;
        }

        .funnel-label { font-weight: bold; flex: 1; }
        .funnel-value { white-space: nowrap; }

        /* カレンダー */
        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            background: var(--primary);
            color: white;
            padding: 0.5rem 0;
            border-radius: 4px 4px 0 0;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            border: 1px solid #ddd;
        }

        .calendar-day {
            min-height: 120px;
            border: 1px solid #eee;
            padding: 0.5rem;
            background: white;
            position: relative;
        }

        .calendar-day.other-month { background-color: #f9f9f9; color: #ccc; }
        .calendar-day.today { background-color: #e3f2fd; }

        .schedule-item {
            background: var(--primary);
            color: white;
            padding: 2px 5px;
            margin-bottom: 2px;
            border-radius: 3px;
            font-size: 0.75rem;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 担当者ごとの色分け */
        .schedule-item[data-assignee="永森"] { background-color: #e91e63; }
        .schedule-item[data-assignee="箱崎"] { background-color: #9c27b0; }
        .schedule-item[data-assignee="清水"] { background-color: #673ab7; }
        .schedule-item[data-assignee="杉田"] { background-color: #3f51b5; }
        .schedule-item[data-assignee="安里"] { background-color: #2196f3; }
        .schedule-item[data-assignee="鎌田"] { background-color: #03a9f4; }
        .schedule-item[data-assignee="大山"] { background-color: #00bcd4; }

        /* モーダル */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #eee;
            padding-bottom: 1rem;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        /* フォーム */
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: bold; color: #555; }
        input, select, textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        /* ボタン */
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            color: white;
            background-color: var(--primary);
        }
        .btn:hover { background-color: var(--primary-hover); }
        .btn-secondary { background-color: #6c757d; }
        .btn-secondary:hover { background-color: #5a6268; }
        .btn-danger { background-color: #dc3545; }
        .btn-danger:hover { background-color: #c82333; }
        .btn-success { background-color: #28a745; }
        .btn-success:hover { background-color: #218838; }

        .actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        /* KPIプログレスバー */
        .progress-bar-container {
            background-color: #e9ecef;
            border-radius: 0.25rem;
            height: 1.5rem;
            width: 100%;
            overflow: hidden;
            margin: 0.5rem 0;
        }
        .progress-bar {
            background-color: #28a745;
            height: 100%;
            color: white;
            text-align: center;
            line-height: 1.5rem;
            font-size: 0.8rem;
            transition: width 0.6s ease;
        }

        /* トースト通知 */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            display: none;
            z-index: 11000;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            animation: slideIn 0.3s ease-out;
        }
        .toast-success { background-color: #28a745; }
        .toast-error { background-color: #dc3545; }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>

    <!-- ログイン画面 -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h2><i class="fas fa-chart-line"></i> 販売管理システム</h2>
                <p>完全動作版</p>
            </div>
            
            <div style="background-color: #e3f2fd; padding: 1rem; border-radius: 4px; margin-bottom: 1.5rem; text-align: left;">
                <p style="margin: 0; font-size: 0.9rem; color: #0d47a1;">
                    <i class="fas fa-info-circle"></i> <strong>デモアカウント</strong><br>
                    ユーザー名: <strong>admin</strong><br>
                    パスワード: <strong>password</strong>
                </p>
            </div>

            <form id="loginForm">
                <div class="form-group" style="text-align: left;">
                    <label>ユーザー名</label>
                    <input type="text" id="username" value="admin" required>
                </div>
                <div class="form-group" style="text-align: left;">
                    <label>パスワード</label>
                    <input type="password" id="password" value="password" required>
                </div>
                <button type="submit" class="btn" style="width: 100%; justify-content: center; font-size: 1.1rem; padding: 0.8rem;">
                    <i class="fas fa-sign-in-alt"></i> ログイン
                </button>
            </form>
        </div>
    </div>

    <!-- メインアプリケーション -->
    <div id="appContainer" class="app-container">
        <header class="app-header">
            <div class="app-title"><i class="fas fa-chart-line"></i> 販売管理システム</div>
            <div class="user-info">
                <span><i class="fas fa-user-circle"></i> 管理者 (大山)</span>
                <button id="logoutBtn" class="btn btn-secondary" style="border: 1px solid white;">
                    <i class="fas fa-sign-out-alt"></i> ログアウト
                </button>
            </div>
        </header>

        <nav class="tab-menu">
            <button class="tab-button active" onclick="app.showPage('dashboard')"><i class="fas fa-tachometer-alt"></i> ダッシュボード</button>
            <button class="tab-button" onclick="app.showPage('customers')"><i class="fas fa-users"></i> 顧客管理</button>
            <button class="tab-button" onclick="app.showPage('schedule')"><i class="fas fa-calendar-alt"></i> スケジュール</button>
            <button class="tab-button" onclick="app.showPage('activities')"><i class="fas fa-clipboard-list"></i> 活動記録</button>
            <button class="tab-button" onclick="app.showPage('kpi')"><i class="fas fa-bullseye"></i> KPI設定</button>
        </nav>

        <main class="main-content">
            <!-- ダッシュボード -->
            <section id="dashboardPage" class="page-section active">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 class="page-title">ダッシュボード</h2>
                    <div>
                        <select id="dashboardFilter" onchange="app.renderDashboard()" style="width: auto; display: inline-block;">
                            <option value="all">全体表示</option>
                            <option value="personal">個人表示 (大山)</option>
                        </select>
                    </div>
                </div>

                <div class="grid-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="statTotalCustomers">0</div>
                        <div class="stat-label">総顧客数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statTodaySchedule">0</div>
                        <div class="stat-label">本日の予定</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statWeekActivities">0</div>
                        <div class="stat-label">今週の活動</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statTotalSales">¥0</div>
                        <div class="stat-label">受注想定価格合計</div>
                    </div>
                </div>

                <div class="grid-dashboard">
                    <div class="card">
                        <h3>担当者別活動状況</h3>
                        <canvas id="chartActivity"></canvas>
                    </div>
                    <div class="card">
                        <h3>機種名別売上</h3>
                        <canvas id="chartProduct"></canvas>
                    </div>
                    <div class="card">
                        <h3>ステージ別案件数</h3>
                        <div id="funnelStage" class="funnel-container"></div>
                    </div>
                    <div class="card">
                        <h3>確度別分布</h3>
                        <div id="funnelProbability" class="funnel-container"></div>
                    </div>
                    <div class="card" style="grid-column: 1 / -1;">
                        <h3>受注予定タイムライン (KPI目標線付き)</h3>
                        <canvas id="chartTimeline" height="300"></canvas>
                    </div>
                </div>
            </section>

            <!-- 顧客管理 -->
            <section id="customersPage" class="page-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 class="page-title">顧客管理</h2>
                    <button class="btn btn-primary" onclick="app.openCustomerModal()"><i class="fas fa-plus"></i> 新規顧客追加</button>
                </div>
                <div class="card table-container">
                    <table id="customersTable">
                        <thead>
                            <tr>
                                <th>顧客名</th>
                                <th>業種</th>
                                <th>ランク</th>
                                <th>ステータス</th>
                                <th>主担当者</th>
                                <th>担当者数</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <!-- スケジュール -->
            <section id="schedulePage" class="page-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 10px;">
                    <h2 class="page-title">スケジュール</h2>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="scheduleFilterAssignee" onchange="app.renderSchedule()" style="width: auto;">
                            <option value="all">全員</option>
                            <!-- JSで担当者追加 -->
                        </select>
                        <select id="scheduleViewType" onchange="app.renderSchedule()" style="width: auto;">
                            <option value="calendar">カレンダー</option>
                            <option value="list">リスト一覧</option>
                        </select>
                        <button class="btn btn-primary" onclick="app.openScheduleModal()"><i class="fas fa-plus"></i> 予定追加</button>
                    </div>
                </div>
                
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <button class="btn btn-secondary" onclick="app.changeMonth(-1)"><i class="fas fa-chevron-left"></i> 前月</button>
                        <h3 id="currentMonthLabel" style="margin: 0;">2024年 12月</h3>
                        <button class="btn btn-secondary" onclick="app.changeMonth(1)">翌月 <i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div id="calendarView">
                        <div class="calendar-header">
                            <div>日</div><div>月</div><div>火</div><div>水</div><div>木</div><div>金</div><div>土</div>
                        </div>
                        <div id="calendarGrid" class="calendar-grid"></div>
                    </div>
                    <div id="scheduleListView" style="display: none;">
                        <table id="scheduleListTable">
                            <thead><tr><th>日付</th><th>時間</th><th>担当者</th><th>タイトル</th><th>操作</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- 活動記録 -->
            <section id="activitiesPage" class="page-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 10px;">
                    <h2 class="page-title">活動記録</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="app.exportReport('weekly')"><i class="fas fa-file-csv"></i> 週報出力</button>
                        <button class="btn btn-success" onclick="app.exportReport('monthly')"><i class="fas fa-file-csv"></i> 月報出力</button>
                        <button class="btn btn-primary" onclick="app.openActivityModal()"><i class="fas fa-plus"></i> 記録追加</button>
                    </div>
                </div>
                <div class="card table-container">
                    <table id="activitiesTable">
                        <thead>
                            <tr>
                                <th>日付</th>
                                <th>担当</th>
                                <th>得意先</th>
                                <th>目的</th>
                                <th>相手</th>
                                <th>商談内容</th>
                                <th>ステージ</th>
                                <th>確度</th>
                                <th>金額</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <!-- KPI設定 -->
            <section id="kpiPage" class="page-section">
                <h2 class="page-title">KPI設定</h2>
                
                <div class="grid-dashboard">
                    <div class="card">
                        <h3>売上目標設定</h3>
                        <div class="form-group">
                            <label>全体売上目標 (¥)</label>
                            <input type="number" id="kpiTotalTarget" value="300000000">
                        </div>
                        <div class="form-group">
                            <label>個人売上目標 (大山) (¥)</label>
                            <input type="number" id="kpiPersonalTarget" value="100000000">
                        </div>
                        <div class="actions">
                            <button class="btn btn-primary" onclick="app.saveKPITargets()">目標保存</button>
                        </div>
                    </div>

                    <div class="card">
                        <h3>達成状況</h3>
                        <div style="margin-bottom: 1.5rem;">
                            <div style="display: flex; justify-content: space-between;">
                                <strong>全体達成率 <span id="kpiTotalRate">0%</span></strong>
                                <span style="color: #dc3545;">不足: <span id="kpiTotalShortage">¥300,000,000</span></span>
                            </div>
                            <div class="progress-bar-container">
                                <div id="kpiTotalBar" class="progress-bar" style="width: 0%">0%</div>
                            </div>
                        </div>
                        <div>
                            <div style="display: flex; justify-content: space-between;">
                                <strong>個人達成率 <span id="kpiPersonalRate">0%</span></strong>
                                <span style="color: #dc3545;">不足: <span id="kpiPersonalShortage">¥100,000,000</span></span>
                            </div>
                            <div class="progress-bar-container">
                                <div id="kpiPersonalBar" class="progress-bar" style="width: 0%">0%</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 5. 個人別KPI入力フォーム -->
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3>個人別KPI (アクションプラン)</h3>
                        <button class="btn btn-primary" onclick="app.openKPIModal()"><i class="fas fa-plus"></i> 項目追加</button>
                    </div>
                    <table id="personalKPITable">
                        <thead>
                            <tr>
                                <th>対象項目</th>
                                <th>ゴール (目標値)</th>
                                <th>期限</th>
                                <th>現状</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <!-- モーダル群 -->
    <!-- 顧客モーダル -->
    <div id="customerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>顧客情報</h3>
                <button class="close-btn" onclick="app.closeModal('customerModal')">&times;</button>
            </div>
            <form id="customerForm" onsubmit="app.saveCustomer(event)">
                <input type="hidden" id="customerId">
                <div class="form-group">
                    <label>顧客名 *</label>
                    <input type="text" id="customerName" required>
                </div>
                <div class="form-group">
                    <label>業種</label>
                    <input type="text" id="customerIndustry">
                </div>
                <div class="form-row" style="display: flex; gap: 1rem;">
                    <div class="form-group" style="flex: 1;">
                        <label>ランク</label>
                        <select id="customerRank">
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>ステータス</label>
                        <select id="customerStatus">
                            <option value="取引中">取引中</option>
                            <option value="アプローチ中">アプローチ中</option>
                            <option value="休眠">休眠</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>主担当者 *</label>
                    <select id="customerAssignee" required class="staff-select"></select>
                </div>
                <div class="actions">
                    <button type="button" class="btn btn-secondary" onclick="app.closeModal('customerModal')">キャンセル</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 3. 担当者一覧モーダル (顧客名クリック時) -->
    <div id="customerStaffModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><span id="staffModalCustomerName"></span> の担当者一覧</h3>
                <button class="close-btn" onclick="app.closeModal('customerStaffModal')">&times;</button>
            </div>
            <div style="margin-bottom: 1rem; text-align: right;">
                <button class="btn btn-primary" onclick="app.addCustomerStaff()"><i class="fas fa-plus"></i> 担当者追加</button>
            </div>
            <table id="customerStaffTable">
                <thead>
                    <tr><th>部署・役職</th><th>氏名</th><th>連絡先</th><th>操作</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- スケジュールモーダル -->
    <div id="scheduleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>予定情報</h3>
                <button class="close-btn" onclick="app.closeModal('scheduleModal')">&times;</button>
            </div>
            <form id="scheduleForm" onsubmit="app.saveSchedule(event)">
                <input type="hidden" id="scheduleId">
                <div class="form-group">
                    <label>タイトル *</label>
                    <input type="text" id="scheduleTitle" required>
                </div>
                <div class="form-row" style="display: flex; gap: 1rem;">
                    <div class="form-group" style="flex: 1;">
                        <label>日付 *</label>
                        <input type="date" id="scheduleDate" required>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>時間</label>
                        <input type="time" id="scheduleTime" step="900">
                    </div>
                </div>
                <div class="form-group">
                    <label>担当者 *</label>
                    <select id="scheduleAssignee" required class="staff-select"></select>
                </div>
                <div class="actions">
                    <button type="button" class="btn btn-danger" id="deleteScheduleBtn" style="display: none;" onclick="app.deleteSchedule()">削除</button>
                    <button type="button" class="btn btn-secondary" onclick="app.closeModal('scheduleModal')">キャンセル</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 活動記録モーダル -->
    <div id="activityModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>活動記録</h3>
                <button class="close-btn" onclick="app.closeModal('activityModal')">&times;</button>
            </div>
            <form id="activityForm" onsubmit="app.saveActivity(event)">
                <input type="hidden" id="activityId">
                <div class="form-row" style="display: flex; gap: 1rem;">
                    <div class="form-group" style="flex: 1;">
                        <label>日付 *</label>
                        <input type="date" id="activityDate" required>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>担当 *</label>
                        <select id="activityAssignee" required class="staff-select"></select>
                    </div>
                </div>
                <div class="form-group">
                    <label>得意先 *</label>
                    <select id="activityCustomer" required></select>
                </div>
                <div class="form-group">
                    <label>目的 *</label>
                    <select id="activityPurpose" required>
                        <option value="A">A: 新規事業活動</option>
                        <option value="B">B: 商談促進</option>
                        <option value="C">C: 仕様打合せ</option>
                        <option value="D">D: 納入・営業立会い</option>
                        <option value="E">E: クレーム対応</option>
                        <option value="F">F: 無償作業</option>
                        <option value="G">G: 有償作業</option>
                        <option value="H">H: 相談・アドバイス</option>
                        <option value="I">I: 部品調査</option>
                        <option value="J">J: 情報収集</option>
                        <option value="K">K: 社内業務</option>
                    </select>
                </div>
                <div class="form-row" style="display: flex; gap: 1rem;">
                    <div class="form-group" style="flex: 1;">
                        <label>相手</label>
                        <input type="text" id="activityPartner">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>機種名</label>
                        <input type="text" id="activityProduct">
                    </div>
                </div>
                <div class="form-group">
                    <label>商談内容</label>
                    <textarea id="activityContent" rows="3"></textarea>
                </div>
                <div class="form-row" style="display: flex; gap: 1rem;">
                    <div class="form-group" style="flex: 1;">
                        <label>ステージ</label>
                        <select id="activityStage">
                            <option value="アプローチ">アプローチ</option>
                            <option value="ヒアリング">ヒアリング</option>
                            <option value="提案">提案</option>
                            <option value="見積提出">見積提出</option>
                            <option value="クロージング">クロージング</option>
                            <option value="受注">受注</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>確度</label>
                        <select id="activityProbability">
                            <option value="A">A (高)</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D (低)</option>
                        </select>
                    </div>
                </div>
                <div class="form-row" style="display: flex; gap: 1rem;">
                    <div class="form-group" style="flex: 1;">
                        <label>受注想定価格</label>
                        <input type="number" id="activityAmount">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>受注予定日</label>
                        <input type="date" id="activityExpectedDate">
                    </div>
                </div>
                <div class="actions">
                    <button type="button" class="btn btn-secondary" onclick="app.closeModal('activityModal')">キャンセル</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- KPI項目モーダル -->
    <div id="kpiItemModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>個人KPI項目</h3>
                <button class="close-btn" onclick="app.closeModal('kpiItemModal')">&times;</button>
            </div>
            <form id="kpiItemForm" onsubmit="app.saveKPIItem(event)">
                <input type="hidden" id="kpiItemId">
                <div class="form-group">
                    <label>対象項目 *</label>
                    <input type="text" id="kpiTargetItem" required placeholder="例: 新規訪問件数">
                </div>
                <div class="form-group">
                    <label>ゴール (目標値) *</label>
                    <input type="text" id="kpiGoalValue" required placeholder="例: 10件/月">
                </div>
                <div class="form-group">
                    <label>期限</label>
                    <input type="date" id="kpiDeadline">
                </div>
                <div class="form-group">
                    <label>現状</label>
                    <input type="text" id="kpiCurrentStatus" placeholder="例: 3件">
                </div>
                <div class="actions">
                    <button type="button" class="btn btn-secondary" onclick="app.closeModal('kpiItemModal')">キャンセル</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- トースト通知 -->
    <div id="toast" class="toast"></div>

    <script>
        // 4. 日付ズレ対策: タイムゾーンを考慮せず、年月日をそのまま解釈する関数
        function parseDateString(dateStr) {
            if (!dateStr) return new Date();
            const [y, m, d] = dateStr.split('-').map(Number);
            return new Date(y, m - 1, d);
        }

        // 定数
        const STAFFS = ['永森', '箱崎', '清水', '杉田', '安里', '鎌田', '大山'];
        const CURRENT_USER = { name: 'admin', assignee: '大山' };

        class SalesApp {
            constructor() {
                this.data = this.loadData();
                this.currentDate = new Date();
                this.init();
            }

            // 初期化
            init() {
                this.setupEventListeners();
                this.setupSelectOptions();
                
                // ログインチェック (簡易)
                if (localStorage.getItem('isLoggedIn') === 'true') {
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('appContainer').style.display = 'flex';
                    this.showPage('dashboard');
                }
            }

            loadData() {
                const defaultData = {
                    customers: [
                        { id: 1, name: '株式会社A', industry: '製造', rank: 'A', status: '取引中', assignee: '大山', staffs: [] },
                        { id: 2, name: 'B商事', industry: '商社', rank: 'B', status: 'アプローチ中', assignee: '永森', staffs: [] }
                    ],
                    schedules: [
                        { id: 1, title: '定期訪問', date: '2024-12-17', time: '10:00', assignee: '大山' }
                    ],
                    activities: [],
                    kpiSettings: {
                        totalTarget: 300000000,
                        personalTarget: 100000000,
                        personalItems: []
                    }
                };
                const saved = localStorage.getItem('salesAppData');
                return saved ? JSON.parse(saved) : defaultData;
            }

            saveData() {
                localStorage.setItem('salesAppData', JSON.stringify(this.data));
            }

            setupEventListeners() {
                // ログイン
                document.getElementById('loginForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const u = document.getElementById('username').value;
                    const p = document.getElementById('password').value;
                    if (u === 'admin' && p === 'password') {
                        localStorage.setItem('isLoggedIn', 'true');
                        document.getElementById('loginScreen').style.display = 'none';
                        document.getElementById('appContainer').style.display = 'flex';
                        this.showPage('dashboard');
                    } else {
                        this.showToast('ログイン情報が正しくありません', 'error');
                    }
                });

                // ログアウト
                document.getElementById('logoutBtn').addEventListener('click', () => {
                    localStorage.removeItem('isLoggedIn');
                    location.reload();
                });
            }

            setupSelectOptions() {
                // 担当者プルダウンの設定
                document.querySelectorAll('.staff-select').forEach(select => {
                    select.innerHTML = '<option value="">選択してください</option>' + 
                        STAFFS.map(s => `<option value="${s}">${s}</option>`).join('');
                });
                
                // スケジュールフィルター用
                const filterSelect = document.getElementById('scheduleFilterAssignee');
                STAFFS.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s;
                    opt.textContent = s;
                    if (s === CURRENT_USER.assignee) opt.selected = true; // デフォルトはログインユーザー
                    filterSelect.appendChild(opt);
                });
            }

            // ページ切り替え
            showPage(pageId) {
                document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
                document.getElementById(pageId + 'Page').classList.add('active');
                
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                // 対応するタブをアクティブに（簡易実装）
                const tabIndex = ['dashboard', 'customers', 'schedule', 'activities', 'kpi'].indexOf(pageId);
                if (tabIndex >= 0) document.querySelectorAll('.tab-button')[tabIndex].classList.add('active');

                // ページごとのレンダリング
                if (pageId === 'dashboard') this.renderDashboard();
                if (pageId === 'customers') this.renderCustomers();
                if (pageId === 'schedule') this.renderSchedule();
                if (pageId === 'activities') this.renderActivities();
                if (pageId === 'kpi') this.renderKPI();
            }

            // --- 顧客管理 ---
            renderCustomers() {
                const tbody = document.querySelector('#customersTable tbody');
                tbody.innerHTML = this.data.customers.map(c => `
                    <tr>
                        <td>
                            <span class="customer-link" onclick="app.openCustomerStaffModal(${c.id})">${c.name}</span>
                        </td>
                        <td>${c.industry || '-'}</td>
                        <td>${c.rank}</td>
                        <td>${c.status}</td>
                        <td>${c.assignee}</td>
                        <td>${(c.staffs || []).length}名</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="app.editCustomer(${c.id})">編集</button>
                            <button class="btn btn-sm btn-danger" onclick="app.deleteCustomer(${c.id})">削除</button>
                        </td>
                    </tr>
                `).join('');
            }

            openCustomerModal() {
                document.getElementById('customerForm').reset();
                document.getElementById('customerId').value = '';
                this.openModal('customerModal');
            }

            editCustomer(id) {
                const c = this.data.customers.find(x => x.id === id);
                if (!c) return;
                document.getElementById('customerId').value = c.id;
                document.getElementById('customerName').value = c.name;
                document.getElementById('customerIndustry').value = c.industry || '';
                document.getElementById('customerRank').value = c.rank;
                document.getElementById('customerStatus').value = c.status;
                document.getElementById('customerAssignee').value = c.assignee;
                this.openModal('customerModal');
            }

            saveCustomer(e) {
                e.preventDefault();
                const id = document.getElementById('customerId').value;
                const customer = {
                    id: id ? parseInt(id) : Date.now(),
                    name: document.getElementById('customerName').value,
                    industry: document.getElementById('customerIndustry').value,
                    rank: document.getElementById('customerRank').value,
                    status: document.getElementById('customerStatus').value,
                    assignee: document.getElementById('customerAssignee').value,
                    staffs: id ? (this.data.customers.find(c => c.id == id).staffs || []) : []
                };

                if (id) {
                    const idx = this.data.customers.findIndex(c => c.id == id);
                    this.data.customers[idx] = customer;
                } else {
                    this.data.customers.push(customer);
                }
                this.saveData();
                this.closeModal('customerModal');
                this.renderCustomers();
                this.showToast('顧客情報を保存しました', 'success');
            }

            deleteCustomer(id) {
                if(!confirm('削除しますか？')) return;
                this.data.customers = this.data.customers.filter(c => c.id !== id);
                this.saveData();
                this.renderCustomers();
            }

            // 3. 顧客担当者一覧モーダル
            openCustomerStaffModal(customerId) {
                const c = this.data.customers.find(x => x.id === customerId);
                if (!c) return;
                
                this.currentEditingCustomerId = customerId; // 現在編集中の顧客IDを保持
                document.getElementById('staffModalCustomerName').textContent = c.name;
                this.renderCustomerStaffs(c);
                this.openModal('customerStaffModal');
            }

            renderCustomerStaffs(customer) {
                const tbody = document.querySelector('#customerStaffTable tbody');
                const staffs = customer.staffs || [];
                if (staffs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">担当者が登録されていません</td></tr>';
                } else {
                    tbody.innerHTML = staffs.map((s, idx) => `
                        <tr>
                            <td>${s.dept || '-'}</td>
                            <td>${s.name}</td>
                            <td>${s.contact || '-'}</td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="app.deleteCustomerStaff(${idx})">削除</button>
                            </td>
                        </tr>
                    `).join('');
                }
            }

            addCustomerStaff() {
                const name = prompt('担当者名を入力:');
                if (!name) return;
                const dept = prompt('部署・役職:');
                const contact = prompt('連絡先:');

                const c = this.data.customers.find(x => x.id === this.currentEditingCustomerId);
                if (!c.staffs) c.staffs = [];
                c.staffs.push({ name, dept, contact });
                this.saveData();
                this.renderCustomerStaffs(c);
                this.renderCustomers(); // 人数更新のため
            }

            deleteCustomerStaff(idx) {
                if(!confirm('削除しますか？')) return;
                const c = this.data.customers.find(x => x.id === this.currentEditingCustomerId);
                c.staffs.splice(idx, 1);
                this.saveData();
                this.renderCustomerStaffs(c);
                this.renderCustomers();
            }


            // --- スケジュール ---
            renderSchedule() {
                const viewType = document.getElementById('scheduleViewType').value;
                const assigneeFilter = document.getElementById('scheduleFilterAssignee').value;
                
                // フィルタリング
                let filtered = this.data.schedules;
                if (assigneeFilter !== 'all') {
                    filtered = filtered.filter(s => s.assignee === assigneeFilter);
                }

                if (viewType === 'calendar') {
                    document.getElementById('calendarView').style.display = 'block';
                    document.getElementById('scheduleListView').style.display = 'none';
                    this.renderCalendar(filtered);
                } else {
                    document.getElementById('calendarView').style.display = 'none';
                    document.getElementById('scheduleListView').style.display = 'block';
                    this.renderScheduleList(filtered);
                }
            }

            renderCalendar(schedules) {
                const year = this.currentDate.getFullYear();
                const month = this.currentDate.getMonth();
                
                document.getElementById('currentMonthLabel').textContent = `${year}年 ${month + 1}月`;
                
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startDay = firstDay.getDay(); // 0:Sun
                
                const grid = document.getElementById('calendarGrid');
                grid.innerHTML = '';
                
                // 空白セル
                for (let i = 0; i < startDay; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'calendar-day other-month';
                    grid.appendChild(cell);
                }
                
                // 日付セル
                for (let d = 1; d <= lastDay.getDate(); d++) {
                    const cell = document.createElement('div');
                    cell.className = 'calendar-day';
                    const checkDate = new Date(year, month, d);
                    
                    // 今日のハイライト
                    const today = new Date();
                    if (year === today.getFullYear() && month === today.getMonth() && d === today.getDate()) {
                        cell.classList.add('today');
                    }
                    
                    cell.innerHTML = `<div style="text-align:right; font-weight:bold; color:#666;">${d}</div>`;
                    
                    // 日付フォーマット YYYY-MM-DD
                    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    
                    // この日の予定
                    const daysSchedules = schedules.filter(s => s.date === dateStr);
                    daysSchedules.forEach(s => {
                        const item = document.createElement('div');
                        item.className = 'schedule-item';
                        item.dataset.assignee = s.assignee;
                        // [担当者] タイトル
                        item.textContent = `[${s.assignee}] ${s.time ? s.time+' ' : ''}${s.title}`;
                        item.onclick = (e) => {
                            e.stopPropagation();
                            this.editSchedule(s.id);
                        };
                        cell.appendChild(item);
                    });
                    
                    // 日付クリックで追加
                    cell.onclick = () => {
                        this.openScheduleModal(dateStr);
                    };

                    grid.appendChild(cell);
                }
            }
            
            renderScheduleList(schedules) {
                // 日付順ソート
                schedules.sort((a,b) => a.date.localeCompare(b.date) || a.time.localeCompare(b.time));
                const tbody = document.querySelector('#scheduleListTable tbody');
                tbody.innerHTML = schedules.map(s => `
                    <tr>
                        <td>${s.date}</td>
                        <td>${s.time || '-'}</td>
                        <td>${s.assignee}</td>
                        <td>${s.title}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="app.editSchedule(${s.id})">編集</button>
                        </td>
                    </tr>
                `).join('');
            }

            changeMonth(offset) {
                this.currentDate.setMonth(this.currentDate.getMonth() + offset);
                this.renderSchedule();
            }

            openScheduleModal(dateStr = '') {
                document.getElementById('scheduleForm').reset();
                document.getElementById('scheduleId').value = '';
                document.getElementById('deleteScheduleBtn').style.display = 'none';
                if (dateStr) document.getElementById('scheduleDate').value = dateStr;
                this.openModal('scheduleModal');
            }

            editSchedule(id) {
                const s = this.data.schedules.find(x => x.id === id);
                if (!s) return;
                document.getElementById('scheduleId').value = s.id;
                document.getElementById('scheduleTitle').value = s.title;
                document.getElementById('scheduleDate').value = s.date;
                document.getElementById('scheduleTime').value = s.time;
                document.getElementById('scheduleAssignee').value = s.assignee;
                document.getElementById('deleteScheduleBtn').style.display = 'inline-block';
                this.openModal('scheduleModal');
            }

            saveSchedule(e) {
                e.preventDefault();
                const id = document.getElementById('scheduleId').value;
                const schedule = {
                    id: id ? parseInt(id) : Date.now(),
                    title: document.getElementById('scheduleTitle').value,
                    // 4. 日付ズレ対策: 値はYYYY-MM-DDで来るのでそのまま保存
                    date: document.getElementById('scheduleDate').value,
                    time: document.getElementById('scheduleTime').value,
                    assignee: document.getElementById('scheduleAssignee').value
                };

                if (id) {
                    const idx = this.data.schedules.findIndex(s => s.id == id);
                    this.data.schedules[idx] = schedule;
                } else {
                    this.data.schedules.push(schedule);
                }
                this.saveData();
                this.closeModal('scheduleModal');
                this.renderSchedule();
                this.showToast('予定を保存しました', 'success');
            }

            deleteSchedule() {
                const id = document.getElementById('scheduleId').value;
                if(!confirm('削除しますか？')) return;
                this.data.schedules = this.data.schedules.filter(s => s.id != id);
                this.saveData();
                this.closeModal('scheduleModal');
                this.renderSchedule();
            }

            // --- 活動記録 ---
            renderActivities() {
                const tbody = document.querySelector('#activitiesTable tbody');
                // 顧客プルダウン更新
                const customerSelect = document.getElementById('activityCustomer');
                customerSelect.innerHTML = '<option value="">選択してください</option>' + 
                    this.data.customers.map(c => `<option value="${c.name}">${c.name}</option>`).join('');

                tbody.innerHTML = this.data.activities.map(a => `
                    <tr>
                        <td>${a.date}</td>
                        <td>${a.assignee}</td>
                        <td>${a.customer}</td>
                        <td>${a.purpose}</td>
                        <td>${a.partner || '-'}</td>
                        <td style="max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" 
                            title="${a.content}" onclick="alert('詳細:\\n' + this.title)">
                            ${a.content || '-'}
                        </td>
                        <td>${a.stage || '-'}</td>
                        <td>${a.probability || '-'}</td>
                        <td>${a.amount ? '¥'+Number(a.amount).toLocaleString() : '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="app.editActivity(${a.id})">編集</button>
                            <button class="btn btn-sm btn-danger" onclick="app.deleteActivity(${a.id})">削除</button>
                        </td>
                    </tr>
                `).join('');
            }

            openActivityModal() {
                document.getElementById('activityForm').reset();
                document.getElementById('activityId').value = '';
                this.openModal('activityModal');
            }

            editActivity(id) {
                const a = this.data.activities.find(x => x.id === id);
                if (!a) return;
                document.getElementById('activityId').value = a.id;
                document.getElementById('activityDate').value = a.date;
                document.getElementById('activityAssignee').value = a.assignee;
                document.getElementById('activityCustomer').value = a.customer;
                document.getElementById('activityPurpose').value = a.purpose;
                document.getElementById('activityPartner').value = a.partner;
                document.getElementById('activityProduct').value = a.product;
                document.getElementById('activityContent').value = a.content;
                document.getElementById('activityStage').value = a.stage;
                document.getElementById('activityProbability').value = a.probability;
                document.getElementById('activityAmount').value = a.amount;
                document.getElementById('activityExpectedDate').value = a.expectedDate;
                this.openModal('activityModal');
            }

            saveActivity(e) {
                e.preventDefault();
                const id = document.getElementById('activityId').value;
                const activity = {
                    id: id ? parseInt(id) : Date.now(),
                    date: document.getElementById('activityDate').value,
                    assignee: document.getElementById('activityAssignee').value,
                    customer: document.getElementById('activityCustomer').value,
                    purpose: document.getElementById('activityPurpose').value,
                    partner: document.getElementById('activityPartner').value,
                    product: document.getElementById('activityProduct').value,
                    content: document.getElementById('activityContent').value,
                    stage: document.getElementById('activityStage').value,
                    probability: document.getElementById('activityProbability').value,
                    amount: document.getElementById('activityAmount').value,
                    expectedDate: document.getElementById('activityExpectedDate').value
                };

                if (id) {
                    const idx = this.data.activities.findIndex(a => a.id == id);
                    this.data.activities[idx] = activity;
                } else {
                    this.data.activities.push(activity);
                }
                this.saveData();
                this.closeModal('activityModal');
                this.renderActivities();
                this.showToast('活動記録を保存しました', 'success');
            }

            deleteActivity(id) {
                if(!confirm('削除しますか？')) return;
                this.data.activities = this.data.activities.filter(a => a.id !== id);
                this.saveData();
                this.renderActivities();
            }

            exportReport(type) {
                const csvContent = "data:text/csv;charset=utf-8," 
                    + "日付,担当,得意先,目的,商談内容\n"
                    + this.data.activities.map(a => `${a.date},${a.assignee},${a.customer},${a.purpose},"${a.content}"`).join("\n");
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `${type}_report.csv`);
                document.body.appendChild(link);
                link.click();
            }

            // --- KPI設定 ---
            // 5. KPI設定ページ機能追加
            renderKPI() {
                // 目標値設定
                document.getElementById('kpiTotalTarget').value = this.data.kpiSettings.totalTarget;
                document.getElementById('kpiPersonalTarget').value = this.data.kpiSettings.personalTarget;

                // 達成率計算 (活動記録の金額合計から簡易計算)
                const totalSales = this.data.activities.reduce((sum, a) => sum + (Number(a.amount) || 0), 0);
                const personalSales = this.data.activities
                    .filter(a => a.assignee === CURRENT_USER.assignee)
                    .reduce((sum, a) => sum + (Number(a.amount) || 0), 0);

                const totalTarget = this.data.kpiSettings.totalTarget;
                const personalTarget = this.data.kpiSettings.personalTarget;

                const totalRate = Math.round((totalSales / totalTarget) * 100) || 0;
                const personalRate = Math.round((personalSales / personalTarget) * 100) || 0;

                const totalShortage = totalTarget - totalSales;
                const personalShortage = personalTarget - personalSales;

                // 表示更新
                document.getElementById('kpiTotalRate').textContent = totalRate + '%';
                document.getElementById('kpiTotalShortage').textContent = '¥' + totalShortage.toLocaleString();
                document.getElementById('kpiTotalBar').style.width = totalRate + '%';
                document.getElementById('kpiTotalBar').textContent = totalRate + '%';

                document.getElementById('kpiPersonalRate').textContent = personalRate + '%';
                document.getElementById('kpiPersonalShortage').textContent = '¥' + personalShortage.toLocaleString();
                document.getElementById('kpiPersonalBar').style.width = personalRate + '%';
                document.getElementById('kpiPersonalBar').textContent = personalRate + '%';

                // KPI項目一覧
                this.renderKPIItems();
            }

            saveKPITargets() {
                this.data.kpiSettings.totalTarget = document.getElementById('kpiTotalTarget').value;
                this.data.kpiSettings.personalTarget = document.getElementById('kpiPersonalTarget').value;
                this.saveData();
                this.renderKPI();
                this.showToast('KPI目標を保存しました', 'success');
            }

            renderKPIItems() {
                const tbody = document.querySelector('#personalKPITable tbody');
                const items = this.data.kpiSettings.personalItems || [];
                
                if (items.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">KPI項目が設定されていません</td></tr>';
                } else {
                    tbody.innerHTML = items.map(item => `
                        <tr>
                            <td>${item.targetItem}</td>
                            <td>${item.goalValue}</td>
                            <td>${item.deadline || '-'}</td>
                            <td>${item.currentStatus || '-'}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="app.editKPIItem(${item.id})">編集</button>
                                <button class="btn btn-sm btn-danger" onclick="app.deleteKPIItem(${item.id})">削除</button>
                            </td>
                        </tr>
                    `).join('');
                }
            }

            openKPIModal() {
                document.getElementById('kpiItemForm').reset();
                document.getElementById('kpiItemId').value = '';
                this.openModal('kpiItemModal');
            }

            editKPIItem(id) {
                const item = this.data.kpiSettings.personalItems.find(x => x.id === id);
                if (!item) return;
                document.getElementById('kpiItemId').value = item.id;
                document.getElementById('kpiTargetItem').value = item.targetItem;
                document.getElementById('kpiGoalValue').value = item.goalValue;
                document.getElementById('kpiDeadline').value = item.deadline;
                document.getElementById('kpiCurrentStatus').value = item.currentStatus;
                this.openModal('kpiItemModal');
            }

            saveKPIItem(e) {
                e.preventDefault();
                const id = document.getElementById('kpiItemId').value;
                const item = {
                    id: id ? parseInt(id) : Date.now(),
                    targetItem: document.getElementById('kpiTargetItem').value,
                    goalValue: document.getElementById('kpiGoalValue').value,
                    deadline: document.getElementById('kpiDeadline').value,
                    currentStatus: document.getElementById('kpiCurrentStatus').value
                };

                if (!this.data.kpiSettings.personalItems) this.data.kpiSettings.personalItems = [];
                
                if (id) {
                    const idx = this.data.kpiSettings.personalItems.findIndex(x => x.id == id);
                    this.data.kpiSettings.personalItems[idx] = item;
                } else {
                    this.data.kpiSettings.personalItems.push(item);
                }
                this.saveData();
                this.closeModal('kpiItemModal');
                this.renderKPI();
                this.showToast('KPI項目を保存しました', 'success');
            }

            deleteKPIItem(id) {
                if(!confirm('削除しますか？')) return;
                this.data.kpiSettings.personalItems = this.data.kpiSettings.personalItems.filter(x =>
 x.id !== id);
                this.saveData();
                this.renderKPI();
            }
        }

        const app = new SalesApp();
    </script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"9af521823d77de82","serverTiming":{"name":{"cfExtPri":true,"cfEdge":true,"cfOrigin":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"version":"2025.9.1","token":"4edd5f8ec12a48cfa682ab8261b80a79"}' crossorigin="anonymous"></script>
</body>
</html>
