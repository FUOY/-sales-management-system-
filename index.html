<!DOCTYPE html>
<html lang="ja" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>販売管理システム (localStorage版)</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root { --primary: #2c5aa0; --primary-hover: #1e3a5f; --background: #f5f7fa; --card-bg: #ffffff; --text-color: #333333; }
        body { margin: 0; padding: 0; font-family: 'Segoe UI', 'Meiryo', sans-serif; background-color: var(--background); color: var(--text-color); min-height: 100vh; }
        .auth-container { display: flex; justify-content: center; align-items: center; width: 100vw; height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); position: fixed; top: 0; left: 0; z-index: 9999; }
        .auth-card { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); width: 90%; max-width: 420px; text-align: center; }
        .auth-header { color: var(--primary); margin-bottom: 1.5rem; border-bottom: 2px solid #eee; padding-bottom: 0.75rem; }
        .auth-header h2 { margin: 0 0 0.5rem 0; font-size: 1.5rem; }
        .app-container { display: none; flex-direction: column; min-height: 100vh; }
        .app-header { background: var(--primary); color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); }
        .app-title { margin: 0; font-size: 1.5rem; font-weight: bold; color: white; }
        .user-info { display: flex; align-items: center; gap: 1rem; }
        .tab-menu { background: #1e3a5f; display: flex; padding: 0 1rem; overflow-x: auto; }
        .tab-button { background: transparent; border: none; color: #ccc; padding: 1rem 1.5rem; cursor: pointer; transition: all 0.3s; font-weight: bold; font-size: 1rem; border-bottom: 3px solid transparent; }
        .tab-button:hover { color: white; background: rgba(255, 255, 255, 0.1); }
        .tab-button.active { color: white; border-bottom: 3px solid white; background: rgba(255, 255, 255, 0.05); }
        .main-content { padding: 2rem; max-width: 1400px; margin: 0 auto; width: 100%; flex: 1; }
        .page-section { display: none; animation: fadeIn 0.3s ease-in-out; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card { background: var(--card-bg); border-radius: 8px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); padding: 1.5rem; margin-bottom: 1.5rem; overflow: hidden; }
        .card h2, .card h3 { color: var(--primary); margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 0.5rem; margin-bottom: 1rem; }
        .grid-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 8px; text-align: center; border-left: 5px solid var(--primary); box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); }
        .stat-value { font-size: 2rem; font-weight: bold; color: var(--primary); margin: 0.5rem 0; white-space: nowrap; }
        .stat-label { color: #666; font-size: 0.9rem; }
        .grid-dashboard { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; }
        @media (max-width: 1200px) { .grid-dashboard { grid-template-columns: 1fr; } }
        .chart-wrapper { position: relative; height: 280px; width: 100%; }
        .funnel-wrapper { max-height: 300px; overflow-y: auto; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #ddd; white-space: nowrap; }
        th { background-color: #f8f9fa; font-weight: bold; color: var(--primary); cursor: pointer; }
        tr:hover { background-color: #f5f5f5; }
        .customer-link { color: var(--primary); text-decoration: underline; cursor: pointer; font-weight: bold; }
        .funnel-container { display: flex; flex-direction: column; gap: 0.5rem; }
        .funnel-item { display: flex; align-items: center; justify-content: space-between; padding: 0.5rem 1rem; color: white; border-radius: 4px; font-size: 0.9rem; transition: width 0.5s ease; }
        .calendar-header { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; background: var(--primary); color: white; padding: 0.5rem 0; border-radius: 4px 4px 0 0; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); border: 1px solid #ddd; }
        .calendar-day { min-height: 120px; border: 1px solid #eee; padding: 0.5rem; background: white; position: relative; }
        .calendar-day.other-month { background-color: #f9f9f9; color: #ccc; }
        .calendar-day.today { background-color: #e3f2fd; }
        .schedule-item { background: var(--primary); color: white; padding: 2px 5px; margin-bottom: 2px; border-radius: 3px; font-size: 0.75rem; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 10000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 2rem; border-radius: 8px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 1px solid #eee; padding-bottom: 1rem; }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; }
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: bold; color: #555; }
        input, select, textarea { width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; }
        .btn { padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 0.5rem; text-decoration: none; color: white; background-color: var(--primary); flex-shrink: 1; }
        .btn:hover { background-color: var(--primary-hover); }
        .btn-secondary { background-color: #6c757d; }
        .btn-danger { background-color: #dc3545; }
        .btn-success { background-color: #28a745; }
        .btn-sm { padding: 0.2rem 0.5rem; font-size: 0.8rem; }
        .actions { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem; }
        .progress-bar-container { background-color: #e9ecef; border-radius: 0.25rem; height: 1.5rem; width: 100%; overflow: hidden; margin: 0.5rem 0; }
        .progress-bar { background-color: #28a745; height: 100%; color: white; text-align: center; line-height: 1.5rem; font-size: 0.8rem; transition: width 0.6s ease; }
        .toast { position: fixed; top: 20px; right: 20px; padding: 1rem 1.5rem; border-radius: 4px; color: white; font-weight: bold; display: none; z-index: 11000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); animation: slideIn 0.3s ease-out; }
        .toast-success { background-color: #28a745; }
        .toast-error { background-color: #dc3545; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 20000; display: none; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .header-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .filter-select { width: 150px !important; padding: 0.5rem; }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay"><div class="spinner"></div><p style="margin-top: 1rem; font-weight: bold; color: var(--primary);">Loading...</p></div>
    <div id="loginScreen" class="auth-container">
        <div class="auth-card">
            <div class="auth-header"><h2><i class="fas fa-chart-line"></i> 販売管理システム</h2><p>localStorage版</p></div>
            <form id="loginForm">
                <div class="form-group" style="text-align: left;"><label>ユーザーID</label><input type="text" id="username" required placeholder="admin"></div>
                <div class="form-group" style="text-align: left;"><label>パスワード</label><input type="password" id="password" required placeholder="パスワードを入力"></div>
                <button type="submit" class="btn" style="width: 100%; justify-content: center; padding: 0.8rem;">ログイン</button>
            </form>
        </div>
    </div>
    <div id="appContainer" class="app-container">
        <header class="app-header">
            <div class="app-title"><i class="fas fa-chart-line"></i> 販売管理システム</div>
            <div class="user-info"><span id="userInfoDisplay"></span><button id="logoutBtn" class="btn btn-secondary" style="border: 1px solid white;">ログアウト</button></div>
        </header>
        <nav class="tab-menu">
            <button class="tab-button active" onclick="app.showPage('dashboard')">ダッシュボード</button>
            <button class="tab-button" onclick="app.showPage('customers')">顧客管理</button>
            <button class="tab-button" onclick="app.showPage('schedule')">スケジュール</button>
            <button class="tab-button" onclick="app.showPage('activities')">活動記録</button>
            <button class="tab-button" onclick="app.showPage('kpi')">KPI設定</button>
        </nav>
        <main class="main-content">
x.id == id);
                if (!c) return;
                document.getElementById('customerId').value = c.id;
                document.getElementById('customerName').value = c.name;
                document.getElementById('customerIndustry').value = c.industry || '';
                document.getElementById('customerRank').value = c.rank || 'A';
                document.getElementById('customerStatus').value = c.status || '取引中';
                document.getElementById('customerAssignee').value = c.assignee || '';
                this.openModal('customerModal');
            }

            saveCustomer(e) {
                e.preventDefault();
                const id = document.getElementById('customerId').value;
                const data = {
                    name: document.getElementById('customerName').value,
                    industry: document.getElementById('customerIndustry').value,
                    rank: document.getElementById('customerRank').value,
                    status: document.getElementById('customerStatus').value,
                    assignee: document.getElementById('customerAssignee').value
                };

                if (id) {
                    const idx = this.data.customers.findIndex(x => x.id == id);
                    if (idx !== -1) {
                        this.data.customers[idx] = { ...this.data.customers[idx], ...data };
                    }
                } else {
                    this.data.customers.push({ id: Date.now().toString(), ...data, staffs: [] });
                }

                this.saveData();
                this.closeModal('customerModal');
                this.renderCustomers();
                this.showToast('顧客を保存しました', 'success');
            }

            deleteCustomer(id) {
                if (!confirm('この顧客を削除しますか?')) return;
                this.data.customers = this.data.customers.filter(c => c.id != id);
                this.saveData();
                this.renderCustomers();
                this.showToast('顧客を削除しました', 'success');
            }

            openCustomerStaffModal(customerId) {
                this.currentEditingCustomerId = customerId;
                const c = this.data.customers.find(x => x.id == customerId);
                if (!c) return;
                document.getElementById('staffModalCustomerName').textContent = c.name;
                this.renderCustomerStaffs(c);
                this.openModal('customerStaffModal');
            }

            renderCustomerStaffs(customer) {
                document.querySelector('#customerStaffTable tbody').innerHTML = (customer.staffs || []).map((s, idx) => `
                    <tr>
                        <td>${s.name}</td>
                        <td>${s.dept || '-'}</td>
                        <td>${s.contact || '-'}</td>
                        <td>
                            <button class="btn btn-secondary btn-sm" onclick="app.editCustomerStaff(${idx})">編集</button>
                            <button class="btn btn-danger btn-sm" onclick="app.deleteCustomerStaff(${idx})">削除</button>
                        </td>
                    </tr>`).join('');
            }

            addCustomerStaff() {
                const name = prompt('担当者名:');
                if (!name) return;
                const dept = prompt('部署・役職:');
                const contact = prompt('連絡先:');
                
                const c = this.data.customers.find(x => x.id == this.currentEditingCustomerId);
                if (!c) return;
                if (!c.staffs) c.staffs = [];
                c.staffs.push({ name, dept, contact });
                this.saveData();
                this.renderCustomerStaffs(c);
                this.renderCustomers();
            }

            editCustomerStaff(idx) {
                const c = this.data.customers.find(x => x.id == this.currentEditingCustomerId);
                if (!c || !c.staffs[idx]) return;
                const s = c.staffs[idx];
                const name = prompt('担当者名:', s.name);
                if (!name) return;
                const dept = prompt('部署・役職:', s.dept);
                const contact = prompt('連絡先:', s.contact);
                c.staffs[idx] = { name, dept, contact };
                this.saveData();
                this.renderCustomerStaffs(c);
                this.renderCustomers();
            }

            deleteCustomerStaff(idx) {
                if (!confirm('この担当者を削除しますか?')) return;
                const c = this.data.customers.find(x => x.id == this.currentEditingCustomerId);
                if (!c) return;
                c.staffs.splice(idx, 1);
                this.saveData();
                this.renderCustomerStaffs(c);
                this.renderCustomers();
            }

            openScheduleModal() {
                document.getElementById('scheduleId').value = '';
                document.getElementById('scheduleTitle').value = '';
                document.getElementById('scheduleDate').value = '';
                document.getElementById('scheduleTime').value = '';
                document.getElementById('scheduleAssignee').value = CURRENT_USER.assignee;
                document.getElementById('deleteScheduleBtn').style.display = 'none';
                this.openModal('scheduleModal');
            }

            editSchedule(id) {
                const s = this.data.schedules.find(x => x.id == id);
                if (!s) return;
                document.getElementById('scheduleId').value = s.id;
                document.getElementById('scheduleTitle').value = s.title;
                document.getElementById('scheduleDate').value = s.date;
                document.getElementById('scheduleTime').value = s.time || '';
                document.getElementById('scheduleAssignee').value = s.assignee;
                document.getElementById('deleteScheduleBtn').style.display = 'inline-block';
                this.openModal('scheduleModal');
            }

            saveSchedule(e) {
                e.preventDefault();
                const id = document.getElementById('scheduleId').value;
                const data = {
                    title: document.getElementById('scheduleTitle').value,
                    date: document.getElementById('scheduleDate').value,
                    time: document.getElementById('scheduleTime').value,
                    assignee: document.getElementById('scheduleAssignee').value
                };

                if (id) {
                    const idx = this.data.schedules.findIndex(x => x.id == id);
                    if (idx !== -1) this.data.schedules[idx] = { ...this.data.schedules[idx], ...data };
                } else {
                    this.data.schedules.push({ id: Date.now().toString(), ...data });
                }

                this.saveData();
                this.closeModal('scheduleModal');
                this.renderSchedule();
                this.showToast('予定を保存しました', 'success');
            }

            deleteSchedule() {
                const id = document.getElementById('scheduleId').value;
                if (!confirm('この予定を削除しますか?')) return;
                this.data.schedules = this.data.schedules.filter(s => s.id != id);
                this.saveData();
                this.closeModal('scheduleModal');
                this.renderSchedule();
                this.showToast('予定を削除しました', 'success');
            }

            openActivityModal() {
                document.getElementById('activityId').value = '';
                document.getElementById('activityDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('activityAssignee').value = CURRENT_USER.assignee;
                document.getElementById('activityCustomer').value = '';
                document.getElementById('activityPurpose').value = 'A';
                document.getElementById('activityPartner').value = '';
                document.getElementById('activityProduct').value = '';
                document.getElementById('activityContent').value = '';
                document.getElementById('activityStage').value = 'アプローチ';
                document.getElementById('activityProbability').value = 'A';
                document.getElementById('activityAmount').value = '';
                document.getElementById('activityExpectedDate').value = '';
                this.openModal('activityModal');
            }

            editActivity(id) {
                const a = this.data.activities.find(x => x.id == id);
                if (!a) return;
                document.getElementById('activityId').value = a.id;
                document.getElementById('activityDate').value = a.date;
                document.getElementById('activityAssignee').value = a.assignee;
                document.getElementById('activityCustomer').value = a.customer;
                document.getElementById('activityPurpose').value = a.purpose;
                document.getElementById('activityPartner').value = a.partner || '';
                document.getElementById('activityProduct').value = a.product || '';
                document.getElementById('activityContent').value = a.content || '';
                document.getElementById('activityStage').value = a.stage || 'アプローチ';
                
                // Set probability dropdown based on stage
                const probSelect = document.getElementById('activityProbability');
                if (a.stage === '受注') {
                    probSelect.innerHTML = '<option value="">空白</option><option value="受注済">受注済</option>';
                } else {
                    probSelect.innerHTML = '<option value="A">A (高)</option><option value="B">B</option><option value="C">C</option><option value="D">D (低)</option>';
                }
                probSelect.value = a.probability || '';
                
                document.getElementById('activityAmount').value = a.amount || '';
                document.getElementById('activityExpectedDate').value = a.expected_date || '';
                this.openModal('activityModal');
            }

            saveActivity(e) {
                e.preventDefault();
                const id = document.getElementById('activityId').value;
                const data = {
                    date: document.getElementById('activityDate').value,
                    assignee: document.getElementById('activityAssignee').value,
                    customer: document.getElementById('activityCustomer').value,
                    purpose: document.getElementById('activityPurpose').value,
                    partner: document.getElementById('activityPartner').value,
                    product: document.getElementById('activityProduct').value,
                    content: document.getElementById('activityContent').value,
                    stage: document.getElementById('activityStage').value,
                    probability: document.getElementById('activityProbability').value,
                    amount: Number(document.getElementById('activityAmount').value) || 0,
                    expected_date: document.getElementById('activityExpectedDate').value
                };

                if (id) {
                    const idx = this.data.activities.findIndex(x => x.id == id);
                    if (idx !== -1) this.data.activities[idx] = { ...this.data.activities[idx], ...data };
                } else {
                    this.data.activities.push({ id: Date.now().toString(), ...data });
                }

                this.saveData();
                this.closeModal('activityModal');
                this.renderActivities();
                this.showToast('活動記録を保存しました', 'success');
            }

            deleteActivity(id) {
                if (!confirm('この活動記録を削除しますか?')) return;
                this.data.activities = this.data.activities.filter(a => a.id != id);
                this.saveData();
                this.renderActivities();
                this.showToast('活動記録を削除しました', 'success');
            }

            openKPIModal() {
                document.getElementById('kpiItemId').value = '';
                document.getElementById('kpiTargetItem').value = '';
                document.getElementById('kpiGoalValue').value = '';
                document.getElementById('kpiDeadline').value = '';
                document.getElementById('kpiCurrentStatus').value = '';
                this.openModal('kpiItemModal');
            }

            editKPIItem(id) {
                const item = this.data.kpiSettings.personalItems.find(x => x.id == id);
                if (!item) return;
                document.getElementById('kpiItemId').value = item.id;
                document.getElementById('kpiTargetItem').value = item.targetItem;
                document.getElementById('kpiGoalValue').value = item.goalValue;
                document.getElementById('kpiDeadline').value = item.deadline || '';
                document.getElementById('kpiCurrentStatus').value = item.currentStatus || '';
                this.openModal('kpiItemModal');
            }

            saveKPIItem(e) {
                e.preventDefault();
                const id = document.getElementById('kpiItemId').value;
                const data = {
                    targetItem: document.getElementById('kpiTargetItem').value,
                    goalValue: document.getElementById('kpiGoalValue').value,
                    deadline: document.getElementById('kpiDeadline').value,
                    currentStatus: document.getElementById('kpiCurrentStatus').value,
                    userId: CURRENT_USER.assignee
                };

                if (id) {
                    const idx = this.data.kpiSettings.personalItems.findIndex(x => x.id == id);
                    if (idx !== -1) this.data.kpiSettings.personalItems[idx] = { ...this.data.kpiSettings.personalItems[idx], ...data };
                } else {
                    this.data.kpiSettings.personalItems.push({ id: Date.now().toString(), ...data });
                }

                this.saveData();
                this.closeModal('kpiItemModal');
                this.renderKPI();
                this.showToast('KPI項目を保存しました', 'success');
            }

            deleteKPIItem(id) {
                if (!confirm('このKPI項目を削除しますか?')) return;
                this.data.kpiSettings.personalItems = this.data.kpiSettings.personalItems.filter(i => i.id != id);
                this.saveData();
                this.renderKPI();
                this.showToast('KPI項目を削除しました', 'success');
            }

            openModal(id) { document.getElementById(id).classList.add('active'); }
            closeModal(id) { document.getElementById(id).classList.remove('active'); }

            showToast(msg, type = 'success') {
                const toast = document.getElementById('toast');
                toast.textContent = msg;
                toast.className = `toast toast-${type}`;
                toast.style.display = 'block';
                setTimeout(() => { toast.style.display = 'none'; }, 3000);
            }

            showLoading(show) {
                document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
            }

            formatCurrency(input) {
                let val = input.value.replace(/,/g, '');
                if (!isNaN(val) && val !== '') {
                    input.value = Number(val).toLocaleString();
                }
            }

            parseCurrency(str) {
                return Number((str || '').replace(/,/g, '')) || 0;
            }

            // LocalStorage Data Management
            saveData() {
                localStorage.setItem('salesCustomers', JSON.stringify(this.data.customers));
                localStorage.setItem('salesSchedules', JSON.stringify(this.data.schedules));
                localStorage.setItem('salesActivities', JSON.stringify(this.data.activities));
                localStorage.setItem('salesKPI', JSON.stringify(this.data.kpiSettings));
            }

            loadData() {
                this.data.customers = JSON.parse(localStorage.getItem('salesCustomers') || '[]');
                this.data.schedules = JSON.parse(localStorage.getItem('salesSchedules') || '[]');
                this.data.activities = JSON.parse(localStorage.getItem('salesActivities') || '[]');
                const kpi = JSON.parse(localStorage.getItem('salesKPI') || '{}');
                this.data.kpiSettings = {
                    totalTarget: kpi.totalTarget || 300000000,
                    personalTargets: kpi.personalTargets || { '永森': 100000000, '箱崎': 100000000, '清水': 100000000, '杉田': 100000000, '安里': 100000000, '鎌田': 100000000, '大山': 100000000 },
                    personalItems: kpi.personalItems || []
                };
            }
        }

        // Initialize App
        const USER_ACCOUNTS = [
            { username: 'admin', password: 'admin', assignee: 'admin', displayName: '管理者', role: 'admin' },
            { username: '永森', password: 'nagamori', assignee: '永森', displayName: '永森', role: 'staff' },
            { username: '箱崎', password: 'hakozaki', assignee: '箱崎', displayName: '箱崎', role: 'staff' },
            { username: '清水', password: 'shimizu', assignee: '清水', displayName: '清水', role: 'staff' },
            { username: '杉田', password: 'sugita', assignee: '杉田', displayName: '杉田', role: 'staff' },
            { username: '安里', password: 'asato', assignee: '安里', displayName: '安里', role: 'staff' },
            { username: '鎌田', password: 'kamata', assignee: '鎌田', displayName: '鎌田', role: 'staff' },
            { username: '大山', password: 'oyama', assignee: '大山', displayName: '大山', role: 'staff' }
        ];

        let app;
        window.addEventListener('DOMContentLoaded', () => {
            app = new SalesApp();
        });
    </script>
</body>
</html>
