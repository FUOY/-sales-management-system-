
<!DOCTYPE html>
<html lang="ja" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>販売管理システム (localStorage版)</title>
    <!-- External Libraries -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --primary: #2c5aa0;
            --primary-hover: #1e3a5f;
            --background: #f5f7fa;
            --card-bg: #ffffff;
            --text-color: #333333;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Meiryo', sans-serif;
            background-color: var(--background);
            color: var(--text-color);
            min-height: 100vh;
        }

        /* Authentication Screen */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: fixed;
            top: 0;
            left: 0;
            z-index: 9999;
        }

        .auth-card {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 420px;
            text-align: center;
        }

        .auth-header {
            color: var(--primary);
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #eee;
            padding-bottom: 0.75rem;
        }
        
        .auth-header h2 {
            margin: 0 0 0.5rem 0;
            font-size: 1.5rem;
        }

        /* App Structure */
        .app-container {
            display: none;
            flex-direction: column;
            min-height: 100vh;
        }

        .app-header {
            background: var(--primary);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .app-title { margin: 0; font-size: 1.5rem; font-weight: bold; color: white; }
        
        /* 修正2: 担当者名を改行しない */
        .user-info { display: flex; align-items: center; gap: 1rem; white-space: nowrap; }

        .tab-menu {
            background: #1e3a5f;
            display: flex;
            padding: 0 1rem;
            overflow-x: auto;
        }

        .tab-button {
            background: transparent;
            border: none;
            color: #ccc;
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            font-size: 1rem;
            border-bottom: 3px solid transparent;
        }
        .tab-button:hover { color: white; background: rgba(255, 255, 255, 0.1); }
        .tab-button.active { color: white; border-bottom: 3px solid white; background: rgba(255, 255, 255, 0.05); }

        .main-content {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            flex: 1;
        }

        .page-section { display: none; animation: fadeIn 0.3s ease-in-out; }
        .page-section.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .card h2, .card h3 {
            color: var(--primary);
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }

        /* Dashboard Stats */
        .grid-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            border-left: 5px solid var(--primary);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
            margin: 0.5rem 0;
            white-space: nowrap;
        }
        .stat-label { color: #666; font-size: 0.9rem; }

        /* Dashboard Grid */
        .grid-dashboard {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }
        @media (max-width: 1200px) { .grid-dashboard { grid-template-columns: 1fr; } }

        .chart-wrapper { position: relative; height: 280px; width: 100%; }
        .funnel-wrapper { max-height: 300px; overflow-y: auto; }

        /* Tables */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #ddd; white-space: nowrap; }
        th { background-color: #f8f9fa; font-weight: bold; color: var(--primary); cursor: pointer; }
        tr:hover { background-color: #f5f5f5; }

        .customer-link {
            color: var(--primary);
            text-decoration: underline;
            cursor: pointer;
            font-weight: bold;
        }

        /* Funnel */
        .funnel-container { display: flex; flex-direction: column; gap: 0.5rem; }
        .funnel-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 0.5rem 1rem; color: white; border-radius: 4px;
            font-size: 0.9rem; transition: width 0.5s ease;
        }

        /* Calendar */
        .calendar-header {
            display: grid; grid-template-columns: repeat(7, 1fr); text-align: center;
            background: var(--primary); color: white; padding: 0.5rem 0; border-radius: 4px 4px 0 0;
        }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); border: 1px solid #ddd; }
        .calendar-day {
            min-height: 120px; border: 1px solid #eee; padding: 0.5rem;
            background: white; position: relative;
        }
        .calendar-day.other-month { background-color: #f9f9f9; color: #ccc; }
        .calendar-day.today { background-color: #e3f2fd; }

        .schedule-item {
            background: var(--primary); color: white; padding: 2px 5px; margin-bottom: 2px;
            border-radius: 3px; font-size: 0.75rem; cursor: pointer;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        /* Modals */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); z-index: 10000; justify-content: center; align-items: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white; padding: 2rem; border-radius: 8px; width: 90%;
            max-width: 600px; max-height: 90vh; overflow-y: auto;
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1.5rem; border-bottom: 1px solid #eee; padding-bottom: 1rem;
        }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; }

        /* Form Elements */
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: bold; color: #555; }
        input, select, textarea {
            width: 100%; padding: 0.5rem; border: 1px solid #ddd;
            border-radius: 4px; font-size: 1rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none; border-radius: 4px; cursor: pointer;
            font-size: 0.9rem; display: inline-flex; align-items: center; gap: 0.5rem;
            text-decoration: none; color: white; background-color: var(--primary);
            flex-shrink: 1;
        }
        .btn:hover { background-color: var(--primary-hover); }
        .btn-secondary { background-color: #6c757d; }
        .btn-danger { background-color: #dc3545; }
        .btn-success { background-color: #28a745; }
        
        /* 修正4: テーブルボタン調整用 */
        .btn-sm {
            padding: 0.2rem 0.4rem !important;
            font-size: 0.75rem !important;
            white-space: nowrap;
        }
        .btn-group {
            display: flex;
            gap: 0.3rem;
            flex-wrap: nowrap;
        }

        .actions { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem; }

        /* KPI Progress */
        .progress-bar-container {
            background-color: #e9ecef; border-radius: 0.25rem; height: 1.5rem;
            width: 100%; overflow: hidden; margin: 0.5rem 0;
        }
        .progress-bar {
            background-color: #28a745; height: 100%; color: white; text-align: center;
            line-height: 1.5rem; font-size: 0.8rem; transition: width 0.6s ease;
        }

        /* Toast & Loading */
        .toast {
            position: fixed; top: 20px; right: 20px; padding: 1rem 1.5rem;
            border-radius: 4px; color: white; font-weight: bold; display: none;
            z-index: 11000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); animation: slideIn 0.3s ease-out;
        }
        .toast-success { background-color: #28a745; }
        .toast-error { background-color: #dc3545; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); z-index: 20000;
            display: none; justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid var(--primary);
            border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Specific Layout Classes */
        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .filter-select {
            width: 150px !important;
            padding: 0.5rem;
        }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <p style="margin-top: 1rem; font-weight: bold; color: var(--primary);">Loading...</p>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <h2><i class="fas fa-chart-line"></i> 販売管理システム</h2>
                <p>localStorage版</p>
            </div>
            <form id="loginForm">
                <div class="form-group" style="text-align: left;">
                    <label>ユーザーID (メールアドレス)</label>
                    <input type="text" id="username" required placeholder="admin">
                </div>
                <div class="form-group" style="text-align: left;">
                    <label>パスワード</label>
                    <input type="password" id="password" required placeholder="パスワードを入力">
                </div>
                <button type="submit" class="btn" style="width: 100%; justify-content: center; padding: 0.8rem;">ログイン</button>
            </form>
            <div style="margin-top: 1rem; font-size: 0.8rem; color: #666;">
                <p>初期ID: admin, eimori, hakozaki...</p>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="appContainer" class="app-container">
        <header class="app-header">
            <div class="app-title"><i class="fas fa-chart-line"></i> 販売管理システム</div>
            <div class="user-info">
                <span id="userInfoDisplay"></span>
                <button id="logoutBtn" class="btn btn-secondary" style="border: 1px solid white;">ログアウト</button>
            </div>
        </header>

        <nav class="tab-menu">
            <button class="tab-button active" onclick="app.showPage('dashboard')">ダッシュボード</button>
            <button class="tab-button" onclick="app.showPage('customers')">顧客管理</button>
            <button class="tab-button" onclick="app.showPage('schedule')">スケジュール</button>
            <button class="tab-button" onclick="app.showPage('activities')">活動記録</button>
            <button class="tab-button" onclick="app.showPage('kpi')">KPI設定</button>
        </nav>

        <main class="main-content">
            <!-- Dashboard Section -->
            <section id="dashboardPage" class="page-section active">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 class="page-title">ダッシュボード</h2>
                    <select id="dashboardFilter" onchange="app.renderDashboard()" class="filter-select">
                        <option value="all">全体表示</option>
                        <option value="personal">個人表示</option>
                    </select>
                </div>

                <div class="card">
                    <h3>売上達成状況</h3>
                    <div style="margin-bottom: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <strong id="dashboardKpiLabel">全体達成率</strong>
                            <div>
                                <span style="color: var(--primary); font-size: 1.2rem; font-weight: bold;" id="dashboardKpiRate">0%</span>
                                <span style="margin-left: 1rem; color: #dc3545;">不足: <span id="dashboardKpiShortage">¥0</span></span>
                            </div>
                        </div>
                        <div class="progress-bar-container">
                            <div id="dashboardKpiBar" class="progress-bar" style="width: 0%">0%</div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.9rem;">
                        <div><strong>売上目標:</strong> <span id="dashboardKpiTarget">¥0</span></div>
                        <div><strong>現在売上:</strong> <span id="dashboardKpiCurrent">¥0</span></div>
                    </div>
                </div>

                <div class="grid-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="statTotalCustomers">0</div>
                        <div class="stat-label">総顧客数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statTodaySchedule">0</div>
                        <div class="stat-label">本日の予定</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statWeekActivities">0</div>
                        <div class="stat-label">今週の活動</div>
                    </div>
                    <div class="stat-card">
						<div class="stat-value" id="statTotalSales">¥0</div>
						<div class="stat-label">受注想定価格合計</div>
						<div style="font-size: 0.75rem; color: #666; margin-top: 0.5rem;" id="statTotalSalesDetail">-</div>
					</div>
                </div>

                <div class="grid-dashboard">
                    <div class="card">
						<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
							<h3 style="margin: 0; border: none;">担当者別活動状況</h3>
							<div style="display: flex; gap: 0.3rem;">
								<button class="btn btn-sm" style="padding: 0.3rem 0.5rem; font-size: 0.75rem;" onclick="app.setActivityPeriod('all')">累計</button>
								<button class="btn btn-sm" style="padding: 0.3rem 0.5rem; font-size: 0.75rem;" onclick="app.setActivityPeriod('week')">今週</button>
								<button class="btn btn-sm" style="padding: 0.3rem 0.5rem; font-size: 0.75rem;" onclick="app.setActivityPeriod('month')">今月</button>
							</div>
						</div>
						<div class="chart-wrapper"><canvas id="chartActivity"></canvas></div>
					</div>
                    <div class="card">
                        <h3>機種名別売上（受注済）</h3>
                        <div class="chart-wrapper"><canvas id="chartProduct"></canvas></div>
                    </div>
                    <div class="card">
                        <h3>ステージ別案件数</h3>
                        <div class="funnel-wrapper"><div id="funnelStage" class="funnel-container"></div></div>
                    </div>
                    <div class="card">
                        <h3>確度別分布</h3>
                        <div class="funnel-wrapper"><div id="funnelProbability" class="funnel-container"></div></div>
                    </div>
                    <div class="card" style="grid-column: 1 / -1;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
							<h3 style="margin: 0; border: none;">受注予定タイムライン (6月-5月)</h3>
							<div style="font-size: 0.85rem; color: #666;">
								<span style="color: #4BC0C0; font-weight: bold;">目標: ¥<span id="timelineTarget">0</span></span> | 
								<span style="color: #28a745; font-weight: bold;">受注済: ¥<span id="timelineOrdered">0</span></span> | 
								<span style="color: #ffc107; font-weight: bold;">想定: ¥<span id="timelineExpected">0</span></span> | 
								<span style="color: #dc3545; font-weight: bold;">不足: ¥<span id="timelineShortage">0</span></span>
							</div>
						</div>
                        <div class="chart-wrapper" style="height: 350px;"><canvas id="chartTimeline"></canvas></div>
                    </div>
                </div>
            </section>

            <!-- Customer Management Section -->
            <section id="customersPage" class="page-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; gap: 1rem; flex-wrap: wrap;">
                    <h2 class="page-title" style="margin: 0;">顧客管理</h2>
                    <div class="header-controls">
                        <select id="customersFilter" onchange="app.renderCustomers()" class="filter-select">
                            <option value="all">全員表示</option>
                            <option value="personal">個人表示</option>
                        </select>
                        <button class="btn btn-primary" onclick="app.openCustomerModal()"><i class="fas fa-plus"></i> 新規顧客追加</button>
                    </div>
                </div>
                <div class="card table-container">
                    <table id="customersTable">
                        <thead>
                            <tr>
                                <th onclick="app.sortCustomers('name')">顧客名 <i class="fas fa-sort" id="sortIconCustomerName"></i></th>
                                <th>業種</th>
                                <th>ランク</th>
                                <th>ステータス</th>
                                <th>主担当者</th>
                                <th>担当者数</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <!-- Schedule Section -->
            <section id="schedulePage" class="page-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 10px;">
                    <h2 class="page-title">スケジュール</h2>
                    <div class="header-controls">
                        <select id="scheduleFilterAssignee" onchange="app.renderSchedule()" class="filter-select"></select>
                        <select id="scheduleViewType" onchange="app.renderSchedule()" class="filter-select">
                            <option value="calendar">カレンダー</option>
                            <option value="list">リスト一覧</option>
                        </select>
                        <button class="btn btn-primary" onclick="app.openScheduleModal()"><i class="fas fa-plus"></i> 予定追加</button>
                    </div>
                </div>
                <div class="card">
                    <!-- 修正5: カレンダー操作ボタンレイアウト -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <button class="btn btn-secondary" style="min-width: 60px; padding: 0.4rem 0.6rem;" onclick="app.changeMonth(-1)">前月</button>
                        <h3 id="currentMonthLabel" style="margin: 0; white-space: nowrap;"></h3>
                        <button class="btn btn-secondary" style="min-width: 60px; padding: 0.4rem 0.6rem;" onclick="app.changeMonth(1)">翌月</button>
                    </div>
                    <div id="calendarView">
                        <div class="calendar-header"><div>日</div><div>月</div><div>火</div><div>水</div><div>木</div><div>金</div><div>土</div></div>
                        <div id="calendarGrid" class="calendar-grid"></div>
                    </div>
                    <div id="scheduleListView" style="display: none;">
                        <table id="scheduleListTable">
                            <thead>
                                <tr>
                                    <th onclick="app.sortScheduleList('date')">日付 <i class="fas fa-sort" id="sortIconScheduleDate"></i></th>
                                    <th>時間</th>
                                    <th>担当者</th>
                                    <th>タイトル</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Activity Log Section -->
            <section id="activitiesPage" class="page-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; gap: 1rem; flex-wrap: wrap;">
                    <h2 class="page-title" style="margin: 0;">活動記録</h2>
                    <div class="header-controls">
                        <select id="activitiesFilter" onchange="app.renderActivities()" class="filter-select">
                            <option value="all">全員表示</option>
                            <option value="personal">個人表示</option>
                        </select>
                        <button class="btn btn-success" onclick="app.exportReport('weekly')"><i class="fas fa-file-csv"></i> 週報出力</button>
                        <button class="btn btn-success" onclick="app.exportReport('monthly')"><i class="fas fa-file-csv"></i> 月報出力</button>
                        <button class="btn btn-primary" onclick="app.openActivityModal()"><i class="fas fa-plus"></i> 記録追加</button>
                    </div>
                </div>
                <div class="card table-container">
                    <table id="activitiesTable">
                        <thead>
                            <tr>
                                <th onclick="app.sortActivities('date')">日付 <i class="fas fa-sort" id="sortIconActivityDate"></i></th>
                                <th>担当</th>
                                <th>得意先</th>
                                <th>目的</th>
                                <th>相手</th>
                                <th>商談内容</th>
                                <th>ステージ</th>
                                <th>確度</th>
                                <th>金額</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <!-- KPI Settings Section -->
            <section id="kpiPage" class="page-section">
                <h2 class="page-title">KPI設定</h2>
                <div class="card">
                    <!-- 修正8: タイトルとボタンを横並びに -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0; border: none; padding: 0;">売上目標設定</h3>
                        <button class="btn btn-primary" onclick="app.saveKPITargets()">目標保存</button>
                    </div>
                    <div class="form-group">
                        <label>全体売上目標 (円) *</label>
                        <input type="text" id="kpiTotalTarget" required oninput="app.formatCurrency(this)">
                    </div>
                    <div class="form-group">
                        <label>個人売上目標 (円) *</label>
                        <input type="text" id="kpiPersonalTarget" required oninput="app.formatCurrency(this)">
                    </div>
                </div>
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <!-- 修正8: タイトルの改行防止 -->
                        <h3 style="margin: 0; white-space: nowrap;">個人別KPI (アクションプラン)</h3>
                        <button class="btn btn-primary" onclick="app.openKPIModal()"><i class="fas fa-plus"></i> 項目追加</button>
                    </div>
                    <table id="personalKPITable">
                        <thead>
                            <tr><th>対象項目</th><th>ゴール (目標値)</th><th>期限</th><th>現状</th><th>操作</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <!-- Modals (修正7: 各モーダルタイトルの改行防止) -->
    <div id="customerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3 style="white-space: nowrap;">顧客情報</h3><button class="close-btn" onclick="app.closeModal('customerModal')">×</button></div>
            <form onsubmit="app.saveCustomer(event)">
                <input type="hidden" id="customerId">
                <div class="form-group"><label>顧客名 *</label><input type="text" id="customerName" required></div>
                <div class="form-group"><label>業種</label><input type="text" id="customerIndustry"></div>
                <div class="form-group"><label>ランク</label><select id="customerRank"><option value="A">A</option><option value="B">B</option><option value="C">C</option></select></div>
                <div class="form-group"><label>ステータス</label><select id="customerStatus"><option value="取引中">取引中</option><option value="アプローチ中">アプローチ中</option><option value="休眠">休眠</option></select></div>
                <div class="form-group"><label>主担当者 *</label><select id="customerAssignee" required class="staff-select"></select></div>
                <div class="actions">
                    <button type="button" class="btn btn-secondary" onclick="app.closeModal('customerModal')">キャンセル</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <div id="customerStaffModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3><span id="staffModalCustomerName"></span> の担当者一覧</h3><button class="close-btn" onclick="app.closeModal('customerStaffModal')">×</button></div>
            <div style="margin-bottom: 1rem; text-align: right;"><button class="btn btn-primary" onclick="app.addCustomerStaff()">担当者追加</button></div>
            <table id="customerStaffTable"><thead><tr><th>担当者名</th><th>部署・役職</th><th>連絡先</th><th>操作</th></tr></thead><tbody></tbody></table>
        </div>
    </div>

    <div id="scheduleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3 style="white-space: nowrap;">予定情報</h3><button class="close-btn" onclick="app.closeModal('scheduleModal')">×</button></div>
            <form onsubmit="app.saveSchedule(event)">
                <input type="hidden" id="scheduleId">
                <div class="form-group"><label>タイトル *</label><input type="text" id="scheduleTitle" required></div>
                <div class="form-group"><label>日付 *</label><input type="date" id="scheduleDate" required></div>
                <div class="form-group"><label>時間</label><input type="time" id="scheduleTime"></div>
                <div class="form-group"><label>担当者 *</label><select id="scheduleAssignee" required class="staff-select"></select></div>
                <div class="actions">
                    <button type="button" class="btn btn-danger" id="deleteScheduleBtn" style="display: none;" onclick="app.deleteSchedule()">削除</button>
                    <button type="button" class="btn btn-secondary" onclick="app.closeModal('scheduleModal')">キャンセル</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <div id="activityModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3 style="white-space: nowrap;">活動記録</h3><button class="close-btn" onclick="app.closeModal('activityModal')">×</button></div>
            <form onsubmit="app.saveActivity(event)">
                <input type="hidden" id="activityId">
                <div class="form-group"><label>日付 *</label><input type="date" id="activityDate" required></div>
                <div class="form-group"><label>担当 *</label><select id="activityAssignee" required class="staff-select"></select></div>
                <div class="form-group"><label>得意先 *</label><select id="activityCustomer" required></select></div>
                <div class="form-group"><label>目的 *</label><select id="activityPurpose" required>
                    <option value="A">A: 新規事業活動</option><option value="B">B: 商談促進</option><option value="C">C: 仕様打合せ</option>
                    <option value="D">D: 納入・営業立会い</option><option value="E">E: クレーム対応</option><option value="F">F: 無償作業</option>
                    <option value="G">G: 有償作業</option><option value="H">H: 相談・アドバイス</option><option value="I">I: 部品調査</option>
                    <option value="J">J: 情報収集</option><option value="K">K: 社内業務</option>
                </select></div>
                <div class="form-group"><label>相手</label><input type="text" id="activityPartner"></div>
                <div class="form-group"><label>機種名</label><input type="text" id="activityProduct"></div>
                <div class="form-group"><label>商談内容</label><textarea id="activityContent" rows="3"></textarea></div>
                <div class="form-group"><label>ステージ</label><select id="activityStage">
                    <option value="アプローチ">アプローチ</option><option value="ヒアリング">ヒアリング</option>
                    <option value="提案">提案</option><option value="見積提出">見積提出</option>
                    <option value="クロージング">クロージング</option><option value="受注">受注</option>
                </select></div>
                <div class="form-group"><label>確度</label><select id="activityProbability"><option value="A">A (高)</option><option value="B">B</option><option value="C">C</option><option value="D">D (低)</option></select></div>
                <div class="form-group"><label>受注想定価格</label><input type="number" id="activityAmount"></div>
                <div class="form-group"><label>受注予定日</label><input type="date" id="activityExpectedDate"></div>
                <div class="actions">
                    <button type="button" class="btn btn-secondary" onclick="app.closeModal('activityModal')">キャンセル</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <div id="kpiItemModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3 style="white-space: nowrap;">個人KPI項目</h3><button class="close-btn" onclick="app.closeModal('kpiItemModal')">×</button></div>
            <form onsubmit="app.saveKPIItem(event)">
                <input type="hidden" id="kpiItemId">
                <div class="form-group"><label>対象項目 *</label><input type="text" id="kpiTargetItem" required></div>
                <div class="form-group"><label>ゴール (目標値) *</label><input type="text" id="kpiGoalValue" required></div>
                <div class="form-group"><label>期限</label><input type="date" id="kpiDeadline"></div>
                <div class="form-group"><label>現状</label><input type="text" id="kpiCurrentStatus"></div>
                <div class="actions">
                    <button type="button" class="btn btn-secondary" onclick="app.closeModal('kpiItemModal')">キャンセル</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
        const SUPABASE_URL = 'https://vflehlpohwuwploozobi.supabase.co';
		const SUPABASE_KEY = 'sb_publishable_469r2OoTzw-xioLdkOHotQ_7b8RzjuY';

		const supabase = supabase.createClient(
		SUPABASE_URL,
		SUPABASE_KEY
		);
		// Constants & Global State
        // 修正1: USER_ACCOUNTSの修正（eimori）
        const USER_ACCOUNTS = [
            { username: 'admin', password: 'admin', assignee: 'admin', displayName: '管理者', role: 'admin', altUsername: 'admin' },
            { username: '永森', password: 'eimori', assignee: '永森', displayName: '永森', role: 'staff', altUsername: 'eimori' },
            { username: '箱崎', password: 'hakozaki', assignee: '箱崎', displayName: '箱崎', role: 'staff', altUsername: 'hakozaki' },
            { username: '清水', password: 'shimizu', assignee: '清水', displayName: '清水', role: 'staff', altUsername: 'shimizu' },
            { username: '杉田', password: 'sugita', assignee: '杉田', displayName: '杉田', role: 'staff', altUsername: 'sugita' },
            { username: '安里', password: 'asato', assignee: '安里', displayName: '安里', role: 'staff', altUsername: 'asato' },
            { username: '鎌田', password: 'kamata', assignee: '鎌田', displayName: '鎌田', role: 'staff', altUsername: 'kamata' },
            { username: '大山', password: 'oyama', assignee: '大山', displayName: '大山', role: 'staff', altUsername: 'oyama' }
        ];

        const STAFFS = ['永森', '箱崎', '清水', '杉田', '安里', '鎌田', '大山'];
        let supabaseClient = null;
        // LocalStorage優先のためデフォルトSupabase設定はダミー
        const SUPABASE_URL = localStorage.getItem('supabaseUrl') || 'YOUR_SUPABASE_URL';
        const SUPABASE_KEY = localStorage.getItem('supabaseKey') || 'YOUR_SUPABASE_KEY';

        // Initialize Supabase if config exists
        if (SUPABASE_URL && SUPABASE_KEY && SUPABASE_URL !== 'YOUR_SUPABASE_URL') {
            try {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            } catch (e) { console.warn('Supabase init failed', e); }
        }

        let CURRENT_USER = { id: '', username: '', assignee: '', displayName: '', role: 'staff' };

        class SalesApp {
			setActivityPeriod(period) {
				this.activityPeriod = period;
				this.renderDashboard();
			}

            constructor() {
                this.data = {
                    customers: [],
                    schedules: [],
                    activities: [],
                    kpiSettings: { totalTarget: 0, personalTargets: {}, personalItems: [] }
                };
                this.currentDate = new Date();
                this.currentEditingCustomerId = null;
                
                // Sort state
                this.customersSortField = null; this.customersSortOrder = 'asc';
                this.activitiesSortField = null; this.activitiesSortOrder = 'asc';
                this.scheduleSortField = null; this.scheduleSortOrder = 'asc';
                
                this.init();
            }

            init() {
                this.loadData();
                this.setupEventListeners();
                
                // Simple session check (localStorage mode)
                const sessionUser = sessionStorage.getItem('currentUser');
                if (sessionUser) {
                    CURRENT_USER = JSON.parse(sessionUser);
                    this.showApp();
                }
            }

            setupEventListeners() {
                // Login Form
                document.getElementById('loginForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const username = document.getElementById('username').value;
                    const password = document.getElementById('password').value;
                    
                    // 修正1: ユーザー認証ロジック
                    const user = USER_ACCOUNTS.find(u => (u.username === username || u.assignee === username || u.altUsername === username) && u.password === password);
                    
                    if (user) {
                        CURRENT_USER = user;
                        sessionStorage.setItem('currentUser', JSON.stringify(user));
                        this.showApp();
                    } else {
                        alert('ログイン失敗: ユーザー名またはパスワードが間違っています');
                    }
                });

                document.getElementById('logoutBtn').addEventListener('click', () => {
                    sessionStorage.removeItem('currentUser');
                    location.reload();
                });

                // Dynamic Probability Dropdown based on Stage
                document.getElementById('activityStage').addEventListener('change', function(e) {
                    const probSelect = document.getElementById('activityProbability');
                    if (this.value === '受注') {
                        probSelect.innerHTML = '<option value="">空白</option><option value="受注済">受注済</option>';
                    } else {
                        probSelect.innerHTML = '<option value="A">A (高)</option><option value="B">B</option><option value="C">C</option><option value="D">D (低)</option>';
                    }
                });
            }

            showApp() {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('appContainer').style.display = 'flex';
                document.getElementById('userInfoDisplay').textContent = CURRENT_USER.displayName;
                this.setupSelectOptions();
                this.showPage('dashboard');
            }

            setupSelectOptions() {
                const staffOptions = '<option value="">選択してください</option>' + STAFFS.map(s => `<option value="${s}">${s}</option>`).join('');
                document.querySelectorAll('.staff-select').forEach(el => el.innerHTML = staffOptions);
                
                // Schedule filter
                const sFilter = document.getElementById('scheduleFilterAssignee');
                sFilter.innerHTML = '<option value="all">全員</option>' + STAFFS.map(s => `<option value="${s}">${s}</option>`).join('');
                if (CURRENT_USER.role !== 'admin' && STAFFS.includes(CURRENT_USER.assignee)) {
                    sFilter.value = CURRENT_USER.assignee;
                }
            }

            showPage(pageId) {
                document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
                document.getElementById(pageId + 'Page').classList.add('active');
                document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
                const idx = ['dashboard', 'customers', 'schedule', 'activities', 'kpi'].indexOf(pageId);
                if (idx !== -1) document.querySelectorAll('.tab-button')[idx].classList.add('active');

                if (pageId === 'dashboard') this.renderDashboard();
                if (pageId === 'customers') this.renderCustomers();
                if (pageId === 'schedule') this.renderSchedule();
                if (pageId === 'activities') this.renderActivities();
                if (pageId === 'kpi') this.renderKPI();
            }

            // --- Dashboard Render ---
            renderDashboard() {
                const filter = document.getElementById('dashboardFilter').value;
                const isPersonal = filter === 'personal' && CURRENT_USER.role !== 'admin';
                
                const acts = isPersonal ? this.data.activities.filter(a => a.assignee === CURRENT_USER.assignee) : this.data.activities;
                const scheds = isPersonal ? this.data.schedules.filter(s => s.assignee === CURRENT_USER.assignee) : this.data.schedules;
                const custs = isPersonal ? this.data.customers.filter(c => c.assignee === CURRENT_USER.assignee) : this.data.customers;

                // Stats
                document.getElementById('statTotalCustomers').textContent = custs.length;
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('statTodaySchedule').textContent = scheds.filter(s => s.date === today).length;
                
                const now = new Date();
                const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
                const weekActs = acts.filter(a => new Date(a.date) >= weekStart);
                document.getElementById('statWeekActivities').textContent = weekActs.length; 
                
                // 受注済と受注想定を分離
				const orderedSales = acts.filter(a => a.stage === '受注').reduce((sum, a) => sum + (Number(a.amount) || 0), 0);
				const expectedSales = acts.filter(a => a.stage !== '受注').reduce((sum, a) => sum + (Number(a.amount) || 0), 0);
				const totalSales = orderedSales + expectedSales;
				document.getElementById('statTotalSales').textContent = '¥' + totalSales.toLocaleString();
				document.getElementById('statTotalSalesDetail').textContent = `受注済: ¥${orderedSales.toLocaleString()} / 想定: ¥${expectedSales.toLocaleString()}`;

                // KPI Achievement
                const ordered = acts.filter(a => a.stage === '受注').reduce((sum, a) => sum + (Number(a.amount) || 0), 0);
                const target = isPersonal ? (this.data.kpiSettings.personalTargets[CURRENT_USER.assignee] || 0) : this.data.kpiSettings.totalTarget;
                const rate = target > 0 ? Math.round((ordered / target) * 100) : 0;
                
                document.getElementById('dashboardKpiLabel').textContent = isPersonal ? '個人達成率' : '全体達成率';
                document.getElementById('dashboardKpiRate').textContent = rate + '%';
                document.getElementById('dashboardKpiShortage').textContent = '¥' + Math.max(target - ordered, 0).toLocaleString();
                document.getElementById('dashboardKpiBar').style.width = Math.min(rate, 100) + '%';
                document.getElementById('dashboardKpiBar').textContent = rate + '%';
                document.getElementById('dashboardKpiTarget').textContent = '¥' + Number(target).toLocaleString();
                document.getElementById('dashboardKpiCurrent').textContent = '¥' + ordered.toLocaleString();

                this.renderCharts(acts, target);
				
				// 個人表示時のKPI状況表示
				if (isPersonal) {
					// 個人KPIカードが存在しない場合は追加
					let personalKpiCard = document.getElementById('personalKpiCard');
					if (!personalKpiCard) {
						const dashboardGrid = document.querySelector('.grid-dashboard');
						personalKpiCard = document.createElement('div');
						personalKpiCard.id = 'personalKpiCard';
						personalKpiCard.className = 'card';
						personalKpiCard.style.gridColumn = '1 / -1';
						dashboardGrid.appendChild(personalKpiCard);
					}
    
					// 個人KPI項目を取得
					const userItems = this.data.kpiSettings.personalItems.filter(i => i.userId === CURRENT_USER.assignee);
    
					if (userItems.length > 0) {
						personalKpiCard.style.display = 'block';
        
						let kpiHtml = '<h3>個人別KPI達成状況</h3><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">';
        
						userItems.forEach(item => {
							// 簡易的な達成率計算（数値の場合のみ）
							const goal = parseFloat(item.goalValue);
							const current = parseFloat(item.currentStatus);
							let progressHtml = '';
            
							if (!isNaN(goal) && !isNaN(current) && goal > 0) {
								const rate = Math.min(Math.round((current / goal) * 100), 100);
								const color = rate >= 80 ? '#28a745' : rate >= 50 ? '#ffc107' : '#dc3545';
								progressHtml = `
									<div class="progress-bar-container" style="margin-top: 0.5rem;">
										<div class="progress-bar" style="width: ${rate}%; background-color: ${color};">${rate}%</div>
									</div>
									<div style="font-size: 0.8rem; color: #666; margin-top: 0.3rem;">
										現状: ${current} / 目標: ${goal}
									</div>
								`;
							} else {
								progressHtml = `
									<div style="font-size: 0.85rem; color: #666; margin-top: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
										<div><strong>目標:</strong> ${item.goalValue}</div>
										<div><strong>現状:</strong> ${item.currentStatus || '未設定'}</div>
									</div>
								`;
							}
            
							const deadlineText = item.deadline ? `<div style="font-size: 0.75rem; color: #999;">期限: ${item.deadline}</div>` : '';
            
							kpiHtml += `
								<div style="padding: 1rem; background: #f8f9fa; border-radius: 8px; border-left: 4px solid var(--primary);">
									<div style="font-weight: bold; color: var(--primary); margin-bottom: 0.5rem;">${item.targetItem}</div>
									${deadlineText}
									${progressHtml}
								</div>
							`;
						});
        
						kpiHtml += '</div>';
						personalKpiCard.innerHTML = kpiHtml;
					} else {
						personalKpiCard.style.display = 'none';
					}
				} else {
					// 全体表示時は非表示
					const personalKpiCard = document.getElementById('personalKpiCard');
					if (personalKpiCard) personalKpiCard.style.display = 'none';
				}
            }

            renderCharts(acts, target) {
                ['chartActivity', 'chartProduct', 'chartTimeline'].forEach(id => {
                    const canvas = document.getElementById(id);
                    const parent = canvas.parentElement;
                    const newCanvas = document.createElement('canvas');
                    newCanvas.id = id;
                    parent.innerHTML = '';
                    parent.appendChild(newCanvas);
                });
				
                // Activity Bar - 期間フィルター対応
				const activityPeriod = this.activityPeriod || 'all'; // 'all', 'week', 'month'
				let filteredActs = acts;

				if (activityPeriod === 'week') {
					const now = new Date();
					const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
					filteredActs = acts.filter(a => new Date(a.date) >= weekStart);
				} else if (activityPeriod === 'month') {
					const now = new Date();
					const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
					filteredActs = acts.filter(a => new Date(a.date) >= monthStart);
				}

				const counts = {}; STAFFS.forEach(s => counts[s] = 0);
				filteredActs.forEach(a => { if (counts[a.assignee] !== undefined) counts[a.assignee]++; });

				const periodLabel = activityPeriod === 'all' ? '累計活動件数' : activityPeriod === 'week' ? '今週の活動件数' : '今月の活動件数';

				new Chart(document.getElementById('chartActivity'), {
					type: 'bar',
					data: { labels: STAFFS, datasets: [{ label: periodLabel, data: STAFFS.map(s => counts[s]), backgroundColor: '#2c5aa0' }] },
					options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
				});

                // Product Doughnut - 受注済のみ
				const prods = {}; 
				acts.filter(a => a.stage === '受注').forEach(a => { 
					if(a.product) prods[a.product] = (prods[a.product] || 0) + (Number(a.amount) || 0); 
				});
                const colorPalette = [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                    '#FF9F40', '#E7E9ED', '#76D7C4', '#F7DC6F', '#C0392B',
                    '#8E44AD', '#3498DB', '#2ECC71', '#F39C12', '#D35400'
                ];
                new Chart(document.getElementById('chartProduct'), {
                    type: 'doughnut',
                    data: { labels: Object.keys(prods), datasets: [{ data: Object.values(prods), backgroundColor: colorPalette }] },
                    options: { maintainAspectRatio: false }
                });

                // Funnels
                const stages = ['アプローチ', 'ヒアリング', '提案', '見積提出', 'クロージング', '受注'];
                const stageCounts = {}; stages.forEach(s => stageCounts[s] = { count: 0, amount: 0 });
                acts.forEach(a => { if (stageCounts[a.stage]) { stageCounts[a.stage].count++; stageCounts[a.stage].amount += (Number(a.amount) || 0); } });
                const maxStage = Math.max(...Object.values(stageCounts).map(v => v.count), 1);
                document.getElementById('funnelStage').innerHTML = stages.map(s => `
                    <div class="funnel-item" style="width: ${Math.max((stageCounts[s].count / maxStage) * 100, 10)}%; min-width: 120px; background-color: #2c5aa0;">
                        <span class="funnel-label">${s}</span><span class="funnel-value">${stageCounts[s].count}件 / ¥${(stageCounts[s].amount / 10000).toFixed(0)}万</span>
                    </div>`).join('');

                // Probability Funnel
                const actsForProb = acts.filter(a => a.stage !== '受注');
                const probs = ['A', 'B', 'C', 'D'];
                const probCounts = {}; probs.forEach(p => probCounts[p] = 0);
                actsForProb.forEach(a => { if (probCounts[a.probability] !== undefined) probCounts[a.probability]++; });
                const maxProb = Math.max(...Object.values(probCounts), 1);
                document.getElementById('funnelProbability').innerHTML = probs.map(p => `
                    <div class="funnel-item" style="width: ${Math.max((probCounts[p] / maxProb) * 100, 10)}%; min-width: 50px; background-color: #28a745;">
                        <span class="funnel-label">${p}</span><span class="funnel-value">${probCounts[p]}件</span>
                    </div>`).join('');
	
				// Timeline - 受注済と受注想定を分離、KPI達成状況を明確化
				const months = ['6月','7月','8月','9月','10月','11月','12月','1月','2月','3月','4月','5月'];
				const monthlyOrdered = new Array(12).fill(0);  // 受注済
				const monthlyExpected = new Array(12).fill(0); // 受注想定
																							
				// 現在の月のインデックスを取得（営業年度基準）
				const nowDate = new Date();
				const nowMonth = nowDate.getMonth(); // 0-11
				const nowIdx = (nowMonth - 5 + 12) % 12;
				
				acts.forEach(a => {
					if (a.expected_date) {
						const d = new Date(a.expected_date);
						let m = d.getMonth();
						let idx = (m - 5 + 12) % 12;
						if (idx >= 0 && idx < 12) {
							const amount = Number(a.amount) || 0;
							if (a.stage === '受注') {
								monthlyOrdered[idx] += amount;
							} else {
								monthlyExpected[idx] += amount;
							}
						}
					}
				});

				// 累積（受注済のみ）
				let cumOrdered = 0;
				const cumulativeOrdered = monthlyOrdered.map(v => cumOrdered += v);

				// 現時点の受注済合計
				const currentOrdered = acts.filter(a => a.stage === '受注').reduce((sum, a) => sum + (Number(a.amount) || 0), 0);
				// 受注想定合計（ファネル）
				const totalExpected = acts.filter(a => a.stage !== '受注').reduce((sum, a) => sum + (Number(a.amount) || 0), 0);
				// 不足額
				const shortage = Math.max(target - currentOrdered, 0);
				// その後で表示更新
				document.getElementById('timelineTarget').textContent   = target.toLocaleString();
				document.getElementById('timelineOrdered').textContent  = currentOrdered.toLocaleString();
				document.getElementById('timelineExpected').textContent = totalExpected.toLocaleString();
				document.getElementById('timelineShortage').textContent = shortage.toLocaleString();
				
				new Chart(document.getElementById('chartTimeline'), {
					type: 'bar',
					data: {
						labels: months,
						datasets: [
							{ 
								label: '累積受注済', 
								data: cumulativeOrdered, 
								borderColor: '#FF6384', 
								backgroundColor: 'rgba(255, 99, 132, 0.2)', 
								type: 'line', 
								fill: false, 
								order: 1 
							},
							{ 
								label: '月次受注済', 
								data: monthlyOrdered, 
								backgroundColor: 'rgba(75, 192, 192, 0.6)', 
								type: 'bar', 
								stack: 'stack1',
								order: 3
							},
							{ 
								label: '月次受注想定', 
								data: monthlyExpected, 
								backgroundColor: 'rgba(255, 206, 86, 0.6)', 
								type: 'bar', 
								stack: 'stack1',
								order: 3
							},
							{ 
								label: 'KPI目標', 
								data: Array(12).fill(target), 
								borderColor: '#4BC0C0', 
								borderDash: [5, 5], 
								pointRadius: 0, 
								type: 'line', 
								order: 0 
							}
						]
					},
					options: { 
						maintainAspectRatio: false,
						interaction: { mode: 'index', intersect: false },
						plugins: {
							tooltip: {
								callbacks: {
									footer: function(context) {
										return `\n現在の受注済: ¥${currentOrdered.toLocaleString()}\n受注想定: ¥${totalExpected.toLocaleString()}\n不足額: ¥${shortage.toLocaleString()}`;
									}
								}
							}
						}
					}
				});
            }

            // --- Customer Management ---
            renderCustomers() {
                const filter = document.getElementById('customersFilter').value;
                let list = this.data.customers;
                if (filter === 'personal' && CURRENT_USER.role !== 'admin') {
                    list = list.filter(c => c.assignee === CURRENT_USER.assignee);
                }
                
                if (this.customersSortField) {
                    list.sort((a, b) => {
                        const va = a[this.customersSortField] || '';
                        const vb = b[this.customersSortField] || '';
                        return this.customersSortOrder === 'asc' ? va.localeCompare(vb, 'ja') : vb.localeCompare(va, 'ja');
                    });
                    document.getElementById('sortIconCustomerName').className = this.customersSortOrder === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
                } else {
                    document.getElementById('sortIconCustomerName').className = 'fas fa-sort';
                }

                document.querySelector('#customersTable tbody').innerHTML = list.map(c => `
                    <tr>
                        <td><span class="customer-link" onclick="app.openCustomerStaffModal('${c.id}')">${c.name}</span></td>
                        <td>${c.industry || '-'}</td>
                        <td>${c.rank || '-'}</td>
                        <td>${c.status || '-'}</td>
                        <td>${c.assignee || '-'}</td>
                        <td>${c.staffs.length}</td>
                        <!-- 修正4: ボタン配置修正 -->
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-secondary btn-sm" onclick="app.editCustomer('${c.id}')">編集</button>
                                <button class="btn btn-danger btn-sm" onclick="app.deleteCustomer('${c.id}')">削除</button>
                            </div>
                        </td>
                    </tr>`).join('');
            }

            sortCustomers(field) {
                if (this.customersSortField === field) {
                    this.customersSortOrder = this.customersSortOrder === 'asc' ? 'desc' : 'asc';
                } else {
                    this.customersSortField = field;
                    this.customersSortOrder = 'asc';
                }
                this.renderCustomers();
            }

            // --- Schedule ---
            renderSchedule() {
                const view = document.getElementById('scheduleViewType').value;
                const assignee = document.getElementById('scheduleFilterAssignee').value;
                let list = this.data.schedules;
                if (assignee !== 'all') {
                    list = list.filter(s => s.assignee === assignee);
                }

                if (view === 'calendar') {
                    document.getElementById('calendarView').style.display = 'block';
                    document.getElementById('scheduleListView').style.display = 'none';
                    this.renderCalendar(list);
                } else {
                    document.getElementById('calendarView').style.display = 'none';
                    document.getElementById('scheduleListView').style.display = 'block';
                    
                    if (this.scheduleSortField === 'date') {
                        list.sort((a, b) => this.scheduleSortOrder === 'asc' ? a.date.localeCompare(b.date) : b.date.localeCompare(a.date));
                        document.getElementById('sortIconScheduleDate').className = this.scheduleSortOrder === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
                    }

                    document.querySelector('#scheduleListTable tbody').innerHTML = list.map(s => `
                        <tr>
                            <td>${s.date}</td>
                            <td>${s.time || '-'}</td>
                            <td>${s.assignee}</td>
                            <td>${s.title}</td>
                            <td><button class="btn btn-secondary btn-sm" onclick="app.editSchedule('${s.id}')">編集</button></td>
                        </tr>`).join('');
                }
            }

            sortScheduleList(field) {
                if (this.scheduleSortField === field) {
                    this.scheduleSortOrder = this.scheduleSortOrder === 'asc' ? 'desc' : 'asc';
                } else {
                    this.scheduleSortField = field;
                    this.scheduleSortOrder = 'asc';
                }
                this.renderSchedule();
            }

            renderCalendar(list) {
				const y = this.currentDate.getFullYear();
				const m = this.currentDate.getMonth();
				document.getElementById('currentMonthLabel').textContent = `${y}年 ${m + 1}月`;
    
				const first = new Date(y, m, 1);
				const last = new Date(y, m + 1, 0);
				const start = new Date(first);
				start.setDate(start.getDate() - start.getDay());
				const end = new Date(last);
				end.setDate(end.getDate() + (6 - end.getDay()));
    
				let html = '';
				for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
					// タイムゾーンの影響を受けないように、ローカル日付文字列を生成
					const year = d.getFullYear();
					const month = String(d.getMonth() + 1).padStart(2, '0');
					const day = String(d.getDate()).padStart(2, '0');
					const dateStr = `${year}-${month}-${day}`;
        
					const isOther = d.getMonth() !== m;
        
					// 今日の日付も同様にローカルで生成
					const today = new Date();
					const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
					const isToday = dateStr === todayStr;
        
					const dayScheds = list.filter(s => s.date === dateStr);
					html += `<div class="calendar-day ${isOther ? 'other-month' : ''} ${isToday ? 'today' : ''}">
						<div style="text-align:right; font-size:0.8rem; margin-bottom:2px;">${d.getDate()}</div>
						${dayScheds.map(s => `<div class="schedule-item" onclick="app.editSchedule('${s.id}')">${s.time ? s.time + ' ' : ''}${s.title}</div>`).join('')}
					</div>`;
				}
				document.getElementById('calendarGrid').innerHTML = html;
			}


            changeMonth(delta) {
                this.currentDate.setMonth(this.currentDate.getMonth() + delta);
                this.renderSchedule();
            }

            // --- Activity Log ---
            renderActivities() {
                const filter = document.getElementById('activitiesFilter').value;
                let list = this.data.activities;
                if (filter === 'personal' && CURRENT_USER.role !== 'admin') {
                    list = list.filter(a => a.assignee === CURRENT_USER.assignee);
                }
                
                if (this.activitiesSortField === 'date') {
                    list.sort((a, b) => this.activitiesSortOrder === 'asc' ? a.date.localeCompare(b.date) : b.date.localeCompare(a.date));
                    document.getElementById('sortIconActivityDate').className = this.activitiesSortOrder === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
                }

                document.querySelector('#activitiesTable tbody').innerHTML = list.map(a => `
                    <tr>
                        <td>${a.date}</td>
                        <td>${a.assignee}</td>
                        <td>${a.customer}</td>
                        <td>${a.purpose}</td>
                        <td>${a.partner || '-'}</td>
                        <td title="${a.content}" onclick="alert('${(a.content || '').replace(/'/g, "\\'")}');" style="cursor:pointer; max-width:150px; overflow:hidden; text-overflow:ellipsis;">${a.content || '-'}</td>
                        <td>${a.stage || '-'}</td>
                        <td>${a.probability || '-'}</td>
                        <td>¥${Number(a.amount).toLocaleString()}</td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-secondary btn-sm" onclick="app.editActivity('${a.id}')">編集</button>
                                <button class="btn btn-danger btn-sm" onclick="app.deleteActivity('${a.id}')">削除</button>
                            </div>
                        </td>
                    </tr>`).join('');
                
                // Sorted customer dropdown
                const custSelect = document.getElementById('activityCustomer');
                const sortedCustomers = [...this.data.customers].sort((a, b) => a.name.localeCompare(b.name, 'ja'));
                custSelect.innerHTML = '<option value="">選択</option>' + sortedCustomers.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            }

            sortActivities(field) {
                if (this.activitiesSortField === field) {
                    this.activitiesSortOrder = this.activitiesSortOrder === 'asc' ? 'desc' : 'asc';
                } else {
                    this.activitiesSortField = field;
                    this.activitiesSortOrder = 'asc';
                }
                this.renderActivities();
            }

            exportReport(type) {
                const BOM = '\uFEFF';
                const header = '日付,担当,得意先,目的,相手,商談内容,ステージ,確度,金額\n';
                const list = this.data.activities;
                const rows = list.map(a => `${a.date},${a.assignee},${a.customer},${a.purpose},${a.partner || ''},"${(a.content || '').replace(/"/g, '""')}",${a.stage},${a.probability},${a.amount || 0}`).join('\n');
                
                const csv = BOM + header + rows;
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `${type === 'weekly' ? '週報' : '月報'}_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                this.showToast(`${type === 'weekly' ? '週報' : '月報'}を出力しました`, 'success');
            }

            // --- KPI Settings ---
            renderKPI() {
                const totalTarget = this.data.kpiSettings.totalTarget || 0;
                const personalTarget = this.data.kpiSettings.personalTargets[CURRENT_USER.assignee] || 0;
                
                document.getElementById('kpiTotalTarget').value = totalTarget.toLocaleString();
                document.getElementById('kpiPersonalTarget').value = personalTarget.toLocaleString();
                
                // Filter personal items by current user
                const userItems = this.data.kpiSettings.personalItems.filter(i => i.userId === CURRENT_USER.assignee);
                
                document.querySelector('#personalKPITable tbody').innerHTML = userItems.map(i => `
                    <tr>
                        <td>${i.targetItem}</td>
                        <td>${i.goalValue}</td>
                        <td>${i.deadline || '-'}</td>
                        <td>${i.currentStatus || '-'}</td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-secondary btn-sm" onclick="app.editKPIItem('${i.id}')">編集</button>
                                <button class="btn btn-danger btn-sm" onclick="app.deleteKPIItem('${i.id}')">削除</button>
                            </div>
                        </td>
                    </tr>`).join('');
            }

            saveKPITargets() {
                const total = this.parseCurrency(document.getElementById('kpiTotalTarget').value);
                const personal = this.parseCurrency(document.getElementById('kpiPersonalTarget').value);
                
                this.data.kpiSettings.totalTarget = total;
                this.data.kpiSettings.personalTargets[CURRENT_USER.assignee] = personal;
                
                this.saveData();
                this.showToast('KPI目標を保存しました', 'success');
            }
			
			// ================================
			// 保存専用関数（localStorage + Supabase）
			// ================================
			function saveSalesData(data) {
				// ① これまで通り localStorage に保存
				localStorage.setItem('salesData', JSON.stringify(data));

				// ② Supabase にも送信
				syncToSupabase(data);
			}
			
			// ================================
			// Supabase 同期処理
			// ================================
			async function syncToSupabase(data) {
			const payload = {
				...data,
				_updatedBy: CURRENT_USER.assignee
			};

			await supabase
				.from('sales_data')
				.upsert({
					id: 'shared',
					payload: payload,
					updated_at: new Date().toISOString()
				});
			}

            // Modal Management
            openCustomerModal() {
                document.getElementById('customerId').value = '';
                document.getElementById('customerName').value = '';
                document.getElementById('customerIndustry').value = '';
                document.getElementById('customerRank').value = 'A';
                document.getElementById('customerStatus').value = '取引中';
                document.getElementById('customerAssignee').value = CURRENT_USER.assignee;
                this.openModal('customerModal');
            }

            editCustomer(id) {
                const c = this.data.customers.find(x => x.id == id);
                if (!c) return;
                document.getElementById('customerId').value = c.id;
                document.getElementById('customerName').value = c.name;
                document.getElementById('customerIndustry').value = c.industry || '';
                document.getElementById('customerRank').value = c.rank || 'A';
                document.getElementById('customerStatus').value = c.status || '取引中';
                document.getElementById('customerAssignee').value = c.assignee || '';
                this.openModal('customerModal');
            }

            saveCustomer(e) {
                e.preventDefault();
                const id = document.getElementById('customerId').value;
                const data = {
                    name: document.getElementById('customerName').value,
                    industry: document.getElementById('customerIndustry').value,
                    rank: document.getElementById('customerRank').value,
                    status: document.getElementById('customerStatus').value,
                    assignee: document.getElementById('customerAssignee').value
                };

                if (id) {
                    const idx = this.data.customers.findIndex(x => x.id == id);
                    if (idx !== -1) {
                        this.data.customers[idx] = { ...this.data.customers[idx], ...data };
                    }
                } else {
                    this.data.customers.push({ id: Date.now().toString(), ...data, staffs: [] });
                }

                this.saveData();
                this.closeModal('customerModal');
                this.renderCustomers();
                this.showToast('顧客を保存しました', 'success');
            }

            deleteCustomer(id) {
                if (!confirm('この顧客を削除しますか?')) return;
                this.data.customers = this.data.customers.filter(c => c.id != id);
                this.saveData();
                this.renderCustomers();
                this.showToast('顧客を削除しました', 'success');
            }

            openCustomerStaffModal(customerId) {
                this.currentEditingCustomerId = customerId;
                const c = this.data.customers.find(x => x.id == customerId);
                if (!c) return;
                document.getElementById('staffModalCustomerName').textContent = c.name;
                this.renderCustomerStaffs(c);
                this.openModal('customerStaffModal');
            }

            renderCustomerStaffs(customer) {
                document.querySelector('#customerStaffTable tbody').innerHTML = (customer.staffs || []).map((s, idx) => `
                    <tr>
                        <td>${s.name}</td>
                        <td>${s.dept || '-'}</td>
                        <td>${s.contact || '-'}</td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-secondary btn-sm" onclick="app.editCustomerStaff(${idx})">編集</button>
                                <button class="btn btn-danger btn-sm" onclick="app.deleteCustomerStaff(${idx})">削除</button>
                            </div>
                        </td>
                    </tr>`).join('');
            }

            addCustomerStaff() {
                const name = prompt('担当者名:');
                if (!name) return;
                const dept = prompt('部署・役職:');
                const contact = prompt('連絡先:');
                
                const c = this.data.customers.find(x => x.id == this.currentEditingCustomerId);
                if (!c) return;
                if (!c.staffs) c.staffs = [];
                c.staffs.push({ name, dept, contact });
                this.saveData();
                this.renderCustomerStaffs(c);
                this.renderCustomers();
            }

            editCustomerStaff(idx) {
                const c = this.data.customers.find(x => x.id == this.currentEditingCustomerId);
                if (!c || !c.staffs[idx]) return;
                const s = c.staffs[idx];
                const name = prompt('担当者名:', s.name);
                if (!name) return;
                const dept = prompt('部署・役職:', s.dept);
                const contact = prompt('連絡先:', s.contact);
                c.staffs[idx] = { name, dept, contact };
                this.saveData();
                this.renderCustomerStaffs(c);
                this.renderCustomers();
            }

            deleteCustomerStaff(idx) {
                if (!confirm('この担当者を削除しますか?')) return;
                const c = this.data.customers.find(x => x.id == this.currentEditingCustomerId);
                if (!c) return;
                c.staffs.splice(idx, 1);
                this.saveData();
                this.renderCustomerStaffs(c);
                this.renderCustomers();
            }

            openScheduleModal() {
                document.getElementById('scheduleId').value = '';
                document.getElementById('scheduleTitle').value = '';
                document.getElementById('scheduleDate').value = '';
                document.getElementById('scheduleTime').value = '';
                document.getElementById('scheduleAssignee').value = CURRENT_USER.assignee;
                document.getElementById('deleteScheduleBtn').style.display = 'none';
                this.openModal('scheduleModal');
            }

            editSchedule(id) {
                const s = this.data.schedules.find(x => x.id == id);
                if (!s) return;
                document.getElementById('scheduleId').value = s.id;
                document.getElementById('scheduleTitle').value = s.title;
                document.getElementById('scheduleDate').value = s.date;
                document.getElementById('scheduleTime').value = s.time || '';
                document.getElementById('scheduleAssignee').value = s.assignee;
                document.getElementById('deleteScheduleBtn').style.display = 'inline-block';
                this.openModal('scheduleModal');
            }

            saveSchedule(e) {
                e.preventDefault();
                const id = document.getElementById('scheduleId').value;
                const data = {
                    title: document.getElementById('scheduleTitle').value,
                    date: document.getElementById('scheduleDate').value,
                    time: document.getElementById('scheduleTime').value,
                    assignee: document.getElementById('scheduleAssignee').value
                };

                if (id) {
                    const idx = this.data.schedules.findIndex(x => x.id == id);
                    if (idx !== -1) this.data.schedules[idx] = { ...this.data.schedules[idx], ...data };
                } else {
                    this.data.schedules.push({ id: Date.now().toString(), ...data });
                }

                this.saveData();
                this.closeModal('scheduleModal');
                this.renderSchedule();
                this.showToast('予定を保存しました', 'success');
            }

            deleteSchedule() {
                const id = document.getElementById('scheduleId').value;
                if (!confirm('この予定を削除しますか?')) return;
                this.data.schedules = this.data.schedules.filter(s => s.id != id);
                this.saveData();
                this.closeModal('scheduleModal');
                this.renderSchedule();
                this.showToast('予定を削除しました', 'success');
            }

            openActivityModal() {
                document.getElementById('activityId').value = '';
                document.getElementById('activityDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('activityAssignee').value = CURRENT_USER.assignee;
                document.getElementById('activityCustomer').value = '';
                document.getElementById('activityPurpose').value = 'A';
                document.getElementById('activityPartner').value = '';
                document.getElementById('activityProduct').value = '';
                document.getElementById('activityContent').value = '';
                document.getElementById('activityStage').value = 'アプローチ';
                document.getElementById('activityProbability').value = 'A';
                document.getElementById('activityAmount').value = '';
                document.getElementById('activityExpectedDate').value = '';
                this.openModal('activityModal');
            }

            editActivity(id) {
                const a = this.data.activities.find(x => x.id == id);
                if (!a) return;
                document.getElementById('activityId').value = a.id;
                document.getElementById('activityDate').value = a.date;
                document.getElementById('activityAssignee').value = a.assignee;
                document.getElementById('activityCustomer').value = a.customer;
                document.getElementById('activityPurpose').value = a.purpose;
                document.getElementById('activityPartner').value = a.partner || '';
                document.getElementById('activityProduct').value = a.product || '';
                document.getElementById('activityContent').value = a.content || '';
                document.getElementById('activityStage').value = a.stage || 'アプローチ';
                
                const probSelect = document.getElementById('activityProbability');
                if (a.stage === '受注') {
                    probSelect.innerHTML = '<option value="">空白</option><option value="受注済">受注済</option>';
                } else {
                    probSelect.innerHTML = '<option value="A">A (高)</option><option value="B">B</option><option value="C">C</option><option value="D">D (低)</option>';
                }
                probSelect.value = a.probability || '';
                
                document.getElementById('activityAmount').value = a.amount || '';
                document.getElementById('activityExpectedDate').value = a.expected_date || '';
                this.openModal('activityModal');
            }

            saveActivity(e) {
                e.preventDefault();
                const id = document.getElementById('activityId').value;
                const data = {
                    date: document.getElementById('activityDate').value,
                    assignee: document.getElementById('activityAssignee').value,
                    customer: document.getElementById('activityCustomer').value,
                    purpose: document.getElementById('activityPurpose').value,
                    partner: document.getElementById('activityPartner').value,
                    product: document.getElementById('activityProduct').value,
                    content: document.getElementById('activityContent').value,
                    stage: document.getElementById('activityStage').value,
                    probability: document.getElementById('activityProbability').value,
                    amount: Number(document.getElementById('activityAmount').value) || 0,
                    expected_date: document.getElementById('activityExpectedDate').value
                };

                if (id) {
                    const idx = this.data.activities.findIndex(x => x.id == id);
                    if (idx !== -1) this.data.activities[idx] = { ...this.data.activities[idx], ...data };
                } else {
                    this.data.activities.push({ id: Date.now().toString(), ...data });
                }

                this.saveData();
                this.closeModal('activityModal');
                this.renderActivities();
                this.showToast('活動記録を保存しました', 'success');
            }

            deleteActivity(id) {
                if (!confirm('この活動記録を削除しますか?')) return;
                this.data.activities = this.data.activities.filter(a => a.id != id);
                this.saveData();
                this.renderActivities();
                this.showToast('活動記録を削除しました', 'success');
            }

            openKPIModal() {
                document.getElementById('kpiItemId').value = '';
                document.getElementById('kpiTargetItem').value = '';
                document.getElementById('kpiGoalValue').value = '';
                document.getElementById('kpiDeadline').value = '';
                document.getElementById('kpiCurrentStatus').value = '';
                this.openModal('kpiItemModal');
            }

            editKPIItem(id) {
                const item = this.data.kpiSettings.personalItems.find(x => x.id == id);
                if (!item) return;
                document.getElementById('kpiItemId').value = item.id;
                document.getElementById('kpiTargetItem').value = item.targetItem;
                document.getElementById('kpiGoalValue').value = item.goalValue;
                document.getElementById('kpiDeadline').value = item.deadline || '';
                document.getElementById('kpiCurrentStatus').value = item.currentStatus || '';
                this.openModal('kpiItemModal');
            }

            saveKPIItem(e) {
                e.preventDefault();
                const id = document.getElementById('kpiItemId').value;
                const data = {
                    targetItem: document.getElementById('kpiTargetItem').value,
                    goalValue: document.getElementById('kpiGoalValue').value,
                    deadline: document.getElementById('kpiDeadline').value,
                    currentStatus: document.getElementById('kpiCurrentStatus').value,
                    userId: CURRENT_USER.assignee
                };

                if (id) {
                    const idx = this.data.kpiSettings.personalItems.findIndex(x => x.id == id);
                    if (idx !== -1) this.data.kpiSettings.personalItems[idx] = { ...this.data.kpiSettings.personalItems[idx], ...data };
                } else {
                    this.data.kpiSettings.personalItems.push({ id: Date.now().toString(), ...data });
                }

                this.saveData();
                this.closeModal('kpiItemModal');
                this.renderKPI();
                this.showToast('KPI項目を保存しました', 'success');
            }

            deleteKPIItem(id) {
                if (!confirm('このKPI項目を削除しますか?')) return;
                this.data.kpiSettings.personalItems = this.data.kpiSettings.personalItems.filter(i => i.id != id);
                this.saveData();
                this.renderKPI();
                this.showToast('KPI項目を削除しました', 'success');
            }

            openModal(id) { document.getElementById(id).classList.add('active'); }
            closeModal(id) { document.getElementById(id).classList.remove('active'); }

            showToast(msg, type = 'success') {
                const toast = document.getElementById('toast');
                toast.textContent = msg;
                toast.className = `toast toast-${type}`;
                toast.style.display = 'block';
                setTimeout(() => { toast.style.display = 'none'; }, 3000);
            }

            showLoading(show) {
                document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
            }

            formatCurrency(input) {
                let val = input.value.replace(/,/g, '');
                if (!isNaN(val) && val !== '') {
                    input.value = Number(val).toLocaleString();
                }
            }

            parseCurrency(str) {
                return Number((str || '').replace(/,/g, '')) || 0;
            }

            saveData() {
				// ① 既存の localStorage 保存はそのまま
				localStorage.setItem('salesCustomers', JSON.stringify(this.data.customers));
				localStorage.setItem('salesSchedules', JSON.stringify(this.data.schedules));
				localStorage.setItem('salesActivities', JSON.stringify(this.data.activities));
				localStorage.setItem('salesKPI', JSON.stringify(this.data.kpiSettings));

				// ② Supabase 用に「まとめたデータ」を送信
				saveSalesData({
					customers: this.data.customers,
					schedules: this.data.schedules,
					activities: this.data.activities,
					kpiSettings: this.data.kpiSettings
				});
			}

            loadData() {
                this.data.customers = JSON.parse(localStorage.getItem('salesCustomers') || '[]');
                this.data.schedules = JSON.parse(localStorage.getItem('salesSchedules') || '[]');
                this.data.activities = JSON.parse(localStorage.getItem('salesActivities') || '[]');
                const kpi = JSON.parse(localStorage.getItem('salesKPI') || '{}');
                this.data.kpiSettings = {
                    totalTarget: kpi.totalTarget || 300000000,
                    personalTargets: kpi.personalTargets || { '永森': 100000000, '箱崎': 100000000, '清水': 100000000, '杉田': 100000000, '安里': 100000000, '鎌田': 100000000, '大山': 100000000 },
                    personalItems: kpi.personalItems || []
                };
            }
        }

        let app;
        window.addEventListener('DOMContentLoaded', () => {
            app = new SalesApp();
        });
    </script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</body>
</html>
